<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>habitican Wardrobes</title>
    <meta name="description" content="Wardrobes for Heros of Habitica" />
    <meta name="author" content="@Piti! Code is based on Alys (Alice Harris) lady_alys@oldgods.net code from Data Display Tool" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script> 
	
<script type="text/javascript">

$(function() { // wraps around all our code to not pollute global namespace

//////////////////////////////////////////////////////////////////////
////   Global Variables                              /////////////////
//////////////////////////////////////////////////////////////////////

var content = {}; // Habitica's content
var user = {}; // holds user content
var tasksFromDb = {}; // holds tasks
var serverUrl = 'https://habitica.com:443/api/v3';
var userID     = '';
var apiToken   = '';
var legendary = {"head":"head_special_2", "armor":"armor_special_2", "weapon":"weapon_special_2","shield":"shield_special_goldenknight"}; // Nameless Helm, Jean Chalard's Noble Tunic, Stephen Weber's Shaft of the Dragon, Mustaine's Milestonemashing Morningstar
var blessing = {};
var intelligence = {};
var perception = {};
var constitution = {};
var strength = {};
var initialGear = {};
var legendaryGearOwned = false; // see function checkLegendaryGear
 var wardrobeEquipped = ['Initial'];
var userName = '';
var equipCount = 0;
var equipCountSkip = 0;
var gearLocation = ["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"]; 
var attributes = ["int", "per", "str", "con"];
var maxInt = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
var maxPer = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
var maxStr = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
var maxCon = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
var maxBles = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};



//////////////////////////////////////////////////////////////////////
////   Get UUID from URL      ////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
var url_vars = getUrlVars();
if (url_vars.uuid) {
    $("#userId").val(url_vars.uuid);
}
function getUrlVars() {
    // Function found at http://stackoverflow.com/questions/4656843/jquery-get-querystring-from-url#answer-4656873
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}

//////////////////////////////////////////////////////////////////////
////   Login events      /////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
$('#userApiDetailsForm').submit(function(event){
    /* The user manually submitted the API connection form. */

    userID   = $('#userId').val();
    apiToken = $('#apiToken').val();
    fetchData();
});



//////////////////////////////////////////////////////////////////////
////   Data Fetch Function   /////////////////////////////////////////
//////////////////////////////////////////////////////////////////////

function fetchData() {
    //$('#loading .good').show();
    $('#loading .bad' ).hide();
	$('#modalContent').html('Please wait, fetching data from Habitica...');
	$('#modal').show();

    var ajaxRunningCount = 3; // drops to 0 when all calls have succeeded
    // fetch the site-wide content (gear names and stats, etc):
    $.ajax({
        url: serverUrl + '/content',
        type: 'GET',
        dataType: 'json',
        cache: true,
        success: fetchContentSuccess,
        error: fetchFailure
    });

	// fetch the tasks content (dotods dailies etc):
    $.ajax({
        url: serverUrl + '/tasks/user',
        type: 'GET',
        dataType: 'json',
        cache: true,
		 beforeSend: function(xhr){
                xhr.setRequestHeader('x-api-user', userID);
                xhr.setRequestHeader('x-api-key',  apiToken);
            },
        success: fetchTasksSuccess,
        error: fetchFailure
    });

    // fetch the user's own content (gear owned, etc):
	$.ajax({
        url: serverUrl + '/user',
        type: 'GET',
        dataType: 'json',
        cache: false,
        beforeSend: function(xhr){
                xhr.setRequestHeader('x-api-user', userID);
                xhr.setRequestHeader('x-api-key',  apiToken);
            },
        success: fetchUserSuccess,
        error: fetchFailure
        });

    function fetchFailure() {
        $('#modal').hide();
        $('#loading .bad' ).show();
    }

    function fetchContentSuccess(data) {
        content = data.data;
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            $('#modal').hide();
			parseData();
        }
    }

    function fetchUserSuccess(data) {
        user = data.data;
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            $('#modal').hide();
			parseData();
        }
    }

	function fetchTasksSuccess(data) {
        tasksFromDb = data.data;
        ajaxRunningCount--;
        if (ajaxRunningCount === 0) { // all ajax calls have finished
            $('#modal').hide();
			parseData();
        }
    }



} // end of fetchData() //////////////////////////////////////////////



//////////////////////////////////////////////////////////////////////
////   Parse Data Function   /////////////////////////////////////////
//////////////////////////////////////////////////////////////////////

function parseData() {
    var htmlStats = ''; // displaying name, class, current equipment, int, per, str, con
	var htmlStart = '';
    var html = '';
	var htmlEnd = '';
	var int = 0;
	var per = 0;
	var str = 0;
	var con = 0;
	var dailyTotal = 0;
	var dailyCompleted = 0;
	wardrobeEquipped = ["Initial"];
	var mostValueableTaskValue = 0;
	var mostValueableTaskName = "";  

	$('#headerExtras').html('<div id="userNameDisplay">' + user.profile.name + '(' + user.stats.class + ')</div>');	// display UserName and Class
	evaluateTasks();
	function evaluateTasks() {
		var compareValue = 0;
		for (var i in tasksFromDb) { 
			if (tasksFromDb[i].type == 'habit') {
				if (mostValueableTaskValue < tasksFromDb[i].value) {
					mostValueableTaskValue = tasksFromDb[i].value; 
					mostValueableTaskName = tasksFromDb[i].text; 
				}
       			} // endIf daily or habit
			if (tasksFromDb[i].type == 'daily' && tasksFromDb[i].isDue == true) {
				dailyTotal ++;
				if (tasksFromDb[i].completed == true) {
					dailyCompleted ++;
				}
			}
		}; // end for
	}; // end of function evaluateTasks;

	checkLegendaryGear();
	function checkLegendaryGear() {
		var ownedGear = user.items.gear.owned;
		if (ownedGear["head_special_2"] == true && ownedGear["armor_special_2"] == true && ownedGear["weapon_special_2"] == true && ownedGear["shield_special_goldenknight"] == true) {
			legendaryGearOwned = true;}
	}; // end of function checkLegendaryGear


	getMaxGear(); // Searches for the best possible type of gear in means of INT and PER, that is being posessed by the user
	function getMaxGear() {
		var ownedKeys = {}; 
		var ownedGear = user.items.gear.owned; // Format: "nameOfEquipment": boolean,   // user.items.gear.owned = false might occur when item was owned once but lost due to death. Still to be implemted	 
	
		// get rid of inventory lost due to death or character reset... 
		for (var item in ownedGear){
			if (ownedGear[item] === false) {delete ownedGear[item];} 
			}
		
		for (var item in ownedGear){ // var item: Format: nameOfEquipment
			ownedKeys[item] = content.gear.flat[item]; // Habiticas content information about each key
				
				// INT
				var factor = 1; 
				if (ownedKeys[item].klass == user.stats.class) {var factor = 1.5;} 
				for (var i in gearLocation) { //gearLocation = [head, armor, ... eyewear], i = 1..8
					var gear = gearLocation[i];  // fromat gear: head_base_0 e.g.
					if ((factor * ownedKeys[item].int) >= maxInt[gear] && ownedKeys[item].type == gear && ownedKeys[item].twoHanded != true) {
						intelligence[gear] = ownedKeys[item].key; 
						maxInt[gear] = (factor * ownedKeys[item].int);
					} // end if  
				} // end for var i in gearLocation
				if (maxInt["headAccessory"] <= 2 && ownedGear["headAccessory_armoire_comicalArrow"] == true) {intelligence["headAccessory"] = "headAccessory_armoire_comicalArrow"; }
				if (maxInt["back"] <= 2 && ownedGear["back_special_aetherCloak"] == true) {intelligence["back"] = "back_special_aetherCloak";}
				if (maxInt["body"] <= 2 && ownedGear["body_special_aetherAmulet"] == true) {intelligence["body"] = "body_special_aetherAmulet";}

				// PER
				var factor = 1; 
				if (ownedKeys[item].klass == user.stats.class) {var factor =1.5;}
				for (var i in gearLocation) { //gearLocation = [head, armor, ... eyewear], i = 1..8
       		 		var gear = gearLocation[i];
					if ((factor * ownedKeys[item].per) >= maxPer[gear] && ownedKeys[item].type == gear && ownedKeys[item].twoHanded != true) {
						perception[gear] = ownedKeys[item].key; 
						maxPer[gear] = (factor * ownedKeys[item].per);
					}  // end if ownedGear[item]
				} // end for var i in gearLocation

				// CON
				var factor = 1; 
				if (ownedKeys[item].klass ==user.stats.class ) {var factor = 1.5;}
				for (var i in gearLocation) { //gearLocation = [head, armor, ... eyewear], i = 1..8
       	 			var gear = gearLocation[i];
					if ((factor * ownedKeys[item].con) >= maxCon[gear] && ownedKeys[item].type == gear && ownedKeys[item].twoHanded != true) {
						constitution[gear] = ownedKeys[item].key; 
						maxCon[gear] = (factor * ownedKeys[item].con);
					}  // end if
				} // end for var in gearLocation 
		
				// STR
				var factor = 1;
				if (ownedKeys[item].klass == user.stats.class) {var factor = 1.5;}
				for (var i in gearLocation) { //gearLocation = [head, armor, ... eyewear], i = 1..8
       		 		var gear = gearLocation[i];
					if ((factor * ownedKeys[item].str) >= maxStr[gear] && ownedKeys[item].type == gear && ownedKeys[item].twoHanded != true) {
						strength[gear] = ownedKeys[item].key; 
						maxStr[gear] = (factor * ownedKeys[item].str);
					}  // end if
				} // end for var i in gearLocation
				if (maxStr["back"] <= 2 && ownedGear["back_special_aetherCloak"] == true) {strength.back = "back_special_aetherCloak";}
				if (maxStr["eyewear"] <= 2 && ownedGear["eyewear_special_aetherMask"] == true) {strength.eyewear = "eyewear_special_aetherMask";}

				// Blessing for Healers INT+CON
				var factor = 1; 
				if (ownedKeys[item].klass == user.stats.class) {var factor = 1.5;} 
				for (var i in gearLocation) { //gearLocation = [head, armor, ... eyewear], i = 1..8
       	 			var gear = gearLocation[i];
					if ((factor * (ownedKeys[item].con + ownedKeys[item].int)) >= maxBles[gear] && ownedKeys[item].type == gear && ownedKeys[item].twoHanded != true) {
						blessing[gear] = ownedKeys[item].key; 
						maxBles[gear] = (factor * (ownedKeys[item].con + ownedKeys[item].int));
					}  // end if
				} // end for var i in gearLocation

		} // end for var Item in ownedGear
	
	
		//second run: checking if there is a two-handed weapon more valueable than single handed weapon + shield
		//content.gear.flat["weapon_wizard_6"].int = 35; // corrupting one entry for testing purpose and set its INT higher as 32 so it will be chosen... delete if works
		var weaponIntPoints = 0; 
		var shieldIntPoints = 0; 
		var weaponPlusShieldIntPoints = 0;
		var twoHandedIntPoints = 0;
		var weaponPerPoints = 0; 
		var shieldPerPoints = 0; 
		var weaponPlusShieldPerPoints = 0; 
		var twoHandedPerPoints = 0;  
		
		//INT          //will it be necessary to calculate PER, STR, etc. also?
		if ('weapon' in intelligence) { 
			weaponIntPoints = ownedKeys[intelligence["weapon"]].int;
			if (ownedKeys[intelligence.weapon].klass == user.stats.class) {weaponIntPoints += 0.5 * weaponIntPoints; } 
			}
		 	if ('shield' in intelligence) {
			shieldIntPoints  = ownedKeys[intelligence["shield"]].int;
			if (ownedKeys[intelligence.shield].klass == user.stats.class) {shieldIntPoints += 0.5 * shieldIntPoints; } 
			} 
			weaponPlusShieldIntPoints = weaponIntPoints + shieldIntPoints; 
		
		for (var item in ownedGear){ // var item: Format: nameOfEquipment
			ownedKeys[item] = content.gear.flat[item]; // Habiticas content information about each key	
			twoHandedIntPoints = ownedKeys[item].int;	
			if (ownedKeys[item].klass == user.stats.class) {twoHandedIntPoints += 0.5 * twoHandedIntPoints; }
					
			// if item is not in inventory, set values int, str, per, con to zero so they are not taken in consideration to equip
			// not sure if this is needed... ownedKeys is already set to zero, but might be set back due to above: ownedKeys[item] = content.gear.flat[item]; so calulate this a second time!
			if (ownedGear[item] == false) {
					ownedKeys[item].int = 0;
					ownedKeys[item].per = 0;
					ownedKeys[item].con = 0; 
					ownedKeys[item].str = 0;  
					} 
			
			if (ownedKeys[item].twoHanded == true && twoHandedIntPoints > weaponPlusShieldIntPoints) {
						intelligence.weapon = item; 
						delete intelligence.shield;  // twoHanded weapon doesn't allow for a shield
			} // end if 
			
			
			
			
			
			//PER          //will it be necessary to calculate PER, STR, etc. also?
		if ('weapon' in perception) { 
			weaponPerPoints = ownedKeys[perception["weapon"]].per;
			if (ownedKeys[perception.weapon].klass == user.stats.class) {weaponPerPoints += 0.5 * weaponPerPoints; } 
			}
		if ('shield' in perception) {
			shieldPerPoints  = ownedKeys[perception["shield"]].per;
			if (ownedKeys[perception.shield].klass == user.stats.class) {shieldPerPoints += 0.5 * shieldPerPoints; } 
			} 
			weaponPlusShieldPerPoints = weaponPerPoints + shieldPerPoints; 
		
		for (var item in ownedGear){ // var item: Format: nameOfEquipment
			ownedKeys[item] = content.gear.flat[item]; // Habiticas content information about each key	
			twoHandedPerPoints = ownedKeys[item].per;	
			if (ownedKeys[item].klass == user.stats.class) {twoHandedPerPoints += 0.5 * twoHandedPerPoints; }
					
			// if item is not in inventory, set values int, str, per, con to zero so they are not taken in consideration to equip
			// not sure if this is needed... ownedKeys is already set to zero, but might be set back due to above: ownedKeys[item] = content.gear.flat[item]; so calulate this a second time!
			if (ownedGear[item] == false) {
					ownedKeys[item].int = 0;
					ownedKeys[item].per = 0;
					ownedKeys[item].con = 0; 
					ownedKeys[item].str = 0;  
					} 
			
			if (ownedKeys[item].twoHanded == true && twoHandedPerPoints > weaponPlusShieldPerPoints) {
						perception.weapon = item; 
						delete perception.shield;  // twoHanded weapon doesn't allow for a shield
			} // end if
			
			
		}	
		} // end second run: for var item in ownedGear 
 
 		// get array with all wardrobes currently equipped 
        if (compareGear(intelligence) == true) {wardrobeEquipped.push('Intelligence');};
        if (compareGear(perception) == true) {wardrobeEquipped.push('Perception');};
        if (compareGear(strength) == true) {wardrobeEquipped.push('Strength');};
        if (compareGear(blessing) == true) {wardrobeEquipped.push('Blessing');};
        if (compareGear(constitution) == true) {wardrobeEquipped.push('Constitution');};
        if (compareGear(legendary) == true) {wardrobeEquipped.push('Legendary');};
        if (wardrobeEquipped.length > 1) {wardrobeEquipped = wardrobeEquipped.filter(function(item){return item !== 'Initial'}); console.log("Initial killed");}; // get rid of 'Initial' in case any other wardrobe matches
        } // end of getMaxGear
 
        function compareGear(specificWardrobe){ //checks if the currently equipped gear is equal to one of the wardrobes
               var equipped = true
               for (var gear in specificWardrobe){
                       if (specificWardrobe[gear] != user.items.gear.equipped[gear]) {
                               equipped = false; 
                       } // end if    
               } // end for gear in specificWardrobe
               return equipped; 
        }; // end of function compareGear
  	
		
	function calculateAttributes(wardrobe) {
		var equipment = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
		var bonus = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
		var total = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
		var totalUnbuffed = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
		var totalPerfectDay = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
		var level = 0;
		var perfectDay = 0;
		var manaRefresh = 0;
		var impactSkill = 0;
		var toolsOfTheTrade = 0; //rogue
		var stealth = 0; 
		var backstab = 0; 
		var pickpocket = 0; 
		var blessing = 0;
		var protectiveAura = 0; 
		var valorousPresence = 0;
		var earthquake = 0;  // mage
		var burstOfFlames = 0; 
		var etherealSurge = 0;
		var chillingFrost = 0; 
		var wardrobeKeys = {};
    	for (var typeOfItem in wardrobe) { //wardrobe is an altered copy of user.items.gear.equipped and contains optimized gear for INT, STR, CON, PER, BLES
       	 	var key = wardrobe[typeOfItem]; // format key: weapon_base_0 e.g.
			wardrobeKeys[key] = content.gear.flat[key];
			if (typeOfItem in wardrobe === true && typeof wardrobeKeys[key] != 'undefined') {
				if (wardrobeKeys[key].klass == user.stats.class){
					bonus.int += 0.5 * wardrobeKeys[key].int;
					bonus.str += 0.5 * wardrobeKeys[key].str;
					bonus.per += 0.5 * wardrobeKeys[key].per;
					bonus.con += 0.5 * wardrobeKeys[key].con;
					}
				equipment["int"] += wardrobeKeys[key].int;
				equipment["per"] += wardrobeKeys[key].per;
				equipment["str"] += wardrobeKeys[key].str;
				equipment["con"] += wardrobeKeys[key].con;
			} // end if typeof wardrobeKeys ... undefined
		}; // end for
		level = Math.floor(user.stats.lvl / 2);
		perfectDay = Math.round(user.stats.lvl / 2);
		if (perfectDay >= 50) {perfectDay = 50;}
 		if (level > 50) {level = 50;}
		totalUnbuffed.int = level + equipment.int + bonus.int + user.stats.int; // totalUnbuffed: level + equipment + allocation
		totalUnbuffed.per = level + equipment.per + bonus.per + user.stats.per; // perfect day buff does not apply to Tools of the Trade
		totalUnbuffed.con = level + equipment.con + bonus.con + user.stats.con; // but it does apply to manamax
		totalUnbuffed.str = level + equipment.str + bonus.str + user.stats.str;
		total.int = totalUnbuffed.int + user.stats.buffs.int; // total: everything - we need that to display attribute stats / we don't need it for calculation of manaRefresh and manaMax...
		total.per = totalUnbuffed.per + user.stats.buffs.per;
		total.con = totalUnbuffed.con + user.stats.buffs.con;
		total.str = totalUnbuffed.str + user.stats.buffs.str;
		totalPerfectDay.int = totalUnbuffed.int + perfectDay; // totalPerfectDay.xxx contains level, equipment, classbonus, allocated and PerfectDayBuff (after Cron)
		totalPerfectDay.per = totalUnbuffed.per + perfectDay;
		totalPerfectDay.con = totalUnbuffed.con + perfectDay;
		totalPerfectDay.str = totalUnbuffed.str + perfectDay;
		manaRefreshPerfectDay 	  = (2 * totalPerfectDay.int + 30) / 10; // manaRefreshPerfectDay is based on 100% completion rate before cron including only Perfect Day buff
		manaRefreshCompletionRate = ((2 * totalUnbuffed.int + 30) / 10) * dailyCompleted / dailyTotal; // manaRefreshCompletionRate includes no buffs and is multipied with completion rate
		var currentMana = user.stats.mp;
		var manaMax = Math.round(2 * total.int + 30); // maximum mana points until cron = ( 2 * buffedINT + 30)
		var habit = 0.0025 * manaMax;
		var dailyToDo = 0.01 * manaMax; 
		if (manaMax < 100) {habit = 0.25; dailyToDo = 1;}
		var manaMaxAfterCronCompletionRate = Math.round(2 * totalUnbuffed.int + 30); // at cron on a non-Perfect Day, all buffs are reset to zero
		var manaMaxAfterCronPerfectDay 	   = Math.round(2 * totalPerfectDay.int + 30)//;  + Math.round(level / 2); // at cron on a Perfect Day all buffs are reset to zero, except Perfect Day buff
		var manaAfterCronCompletionRate	   = Math.round(currentMana + manaRefreshCompletionRate); // before checking if manaMaxAfterCron is exceeded.
		var manaAfterCronPerfectDay		   = Math.round(currentMana + manaRefreshPerfectDay); // before checking if manaMaxAfterCron is exceeded.
		var manaCapCompletionRate = 0;
		var manaCapPerfectDay = 0;
		if (dailyCompleted == dailyTotal) { // fixes bug displaying mana max after cron without perfect day buff on the left column when all dailies are completed 
			manaMaxAfterCronCompletionRate = manaMaxAfterCronPerfectDay;
			manaRefreshCompletionRate = manaRefreshPerfectDay; 
			manaAfterCronCompletionRate = manaAfterCronPerfectDay; 
		}
		if (manaAfterCronCompletionRate >= manaMaxAfterCronCompletionRate) {
			manaCapCompletionRate = manaAfterCronCompletionRate - manaMaxAfterCronCompletionRate;
		}
		if (manaAfterCronPerfectDay >= manaMaxAfterCronPerfectDay) {
			manaCapPerfectDay = manaAfterCronPerfectDay - manaMaxAfterCronPerfectDay;
		}

		//rogue
		toolsOfTheTrade = Math.round((100 * (level + equipment.per + user.stats.per + bonus.per)) / (level + equipment.per + user.stats.per + bonus.per + 50));
		stealth = Math.ceil(0.64 * dailyTotal * total.per / (total.per + 55));
		backstab = (mostValueableTaskValue + 1) +( 0.5 * total.str); 
		pickpocket = (mostValueableTaskValue + 1) + (0.5 * total.per);  
		//healer
		blessing = Math.round((total.int + total.con + 5) * 0.04);
		protectiveAura = Math.round((200 * totalUnbuffed.con) / (200 + totalUnbuffed.con));
		healingLight =  Math.ceil((total.con + total.int + 5) * 0.075); 
		searingBrightness = Math.round(4 * (total.int / (total.int + 40))); 
		//warrior
		brutalSmashTask = Math.round((2.5 * total.str / (total.str + 35)));
		brutalSmashDamage = Math.round(55 * total.str / (total.str + 70));
		valorousPresence = Math.ceil((20 * totalUnbuffed.str) / (200 + totalUnbuffed.str));
		defensiveStance = Math.ceil(40 * totalUnbuffed.con / (totalUnbuffed.con + 200));
		intimidatingGaze = Math.ceil(24 * totalUnbuffed.con / (totalUnbuffed.con + 200)); 
		 //mage
		earthquake = Math.ceil((30 * totalUnbuffed.int) / (200 + totalUnbuffed.int));
		burstOfFlames = (mostValueableTaskValue +1) * 0.075 * total.int;
		etherealSurge = Math.ceil((total.int * 25) / (total.int + 125)); 
		htmlStats +='<section class="container">' +
					'<div class="one"><section class="innerContainer"><div class="innerOne"><a style="color: #f74e52; vertical-align: middle">STR:</a><h3>' + total.str + '</h3></div>' +
					'<div class="innerTwo"><a>Level: ' + level + '<br></a><a>Equipment: ' + equipment["str"] + '<br></a><a>Bonus: ' + bonus.str + '<br></a><a>Allocation: ' + user.stats.str + '<br></a><a>Buffs: ' + user.stats.buffs.str + '</a></div></section></div>' +
					
					'<div class="two"><section class="innerContainer"><div class="innerOne"><a style="color: #2995cd; vertical-align: middle">INT:</a><h3>' + total.int + '</h3></div>' +
					'<div class="innerTwo"><a>Level: ' + level + '<br></a><a>Equipment: ' + equipment["int"] + '<br></a><a>Bonus: ' + bonus.int + '<br></a><a>Allocation: ' + user.stats.int + '<br></a><a>Buffs: ' + user.stats.buffs.int + '</a></div></section></div>' +
					'</section>';
		htmlStats +='<section class="container">' +
					'<div class="one"><section class="innerContainer"><div class="innerOne"><a style="color: #ffa623; vertical-align: middle">CON:</a><h3>' + total.con + '</h3></div>' +
					'<div class="innerTwo"><a>Level: ' + level + '<br></a><a>Equipment: ' + equipment["con"] + '<br></a><a>Bonus: ' + bonus.con + '<br></a><a>Allocation: ' + user.stats.con + '<br></a><a>Buffs: ' + user.stats.buffs.con + '</a></div></section></div>' +
					
					'<div class="two"><section class="innerContainer"><div class="innerOne"><a style="color: #4f2a93; vertical-align: middle">PER:</a><h3>' + total.per + '</h3></div>' +
					'<div class="innerTwo"><a>Level: ' + level + '<br></a><a>Equipment: ' + equipment["per"] + '<br></a><a>Bonus: ' + bonus.per + '<br></a><a>Allocation: ' + user.stats.per + '<br></a><a>Buffs: ' + user.stats.buffs.per + '</a></div></section></div>' +
					'</section>';
		// Progression of Mana: 
		var manaLostOnCapCompletionRate = (currentMana + manaRefreshCompletionRate - manaMaxAfterCronCompletionRate);
						if (manaLostOnCapCompletionRate < 0) {
							manaLostOnCapCompletionRate = 0;
						} else { // Perfect Day
							manaAfterCronCompletionRate = manaMaxAfterCronCompletionRate;
						}
		var manaLostOnCapPerfectDay = (currentMana + manaRefreshPerfectDay - manaMaxAfterCronPerfectDay);
						if (manaLostOnCapPerfectDay < 0) {
							manaLostOnCapPerfectDay = 0;
							manaAfterCronPerfectDay = currentMana + manaRefreshPerfectDay;
						} else {
							manaAfterCronPerfectDay = manaMaxAfterCronPerfectDay;
						}
		// Progression of Mana around Cron time
		htmlStats +='<section class="containerMana"><div style="font-weight: bold">&nbsp; Progression of Mana</div>'+
					'<div class="left">Dailies completed:<br><br>' + //first column
					'current Mana:<br>' +
					'Mana refresh at cron:<br>'+
					'Mana lost on cap:<br>'+
					'Mana after Cron:<br>'+
					'Mana max after Cron:'+
					'</div>'+
					'<div class="middle">'+ // second column 
					 + dailyCompleted + '/' + dailyTotal +'<br>'+ // not all Dailies completed
					'<br>'+
					Math.round(currentMana) +'<br>'+ //current mana
					Math.round(manaRefreshCompletionRate) +'<br>'+ // mana refresh calculated on ratio of completed dailies
					Math.round(-manaLostOnCapCompletionRate) +'<br>'+
					Math.round(manaAfterCronCompletionRate) +'<br>'+
					manaMaxAfterCronCompletionRate +
					'</div>'+
					'<div class="right">'+ // third column
					 + dailyTotal + '/' + dailyTotal +'<br>'+ // all Dailies completed
					'<br>'+
					 Math.round(currentMana) +'<br>'+ // current mana
					 Math.round(manaRefreshPerfectDay) +'<br>'+
					 Math.round(-manaLostOnCapPerfectDay) +'<br>'+
					 Math.round(manaAfterCronPerfectDay) +'<br>' +
					 manaMaxAfterCronPerfectDay +
					'</div></section>';
		// Skills
		htmlStats +='<section class="container" style="margin: 5px">'+
					'<div class="skills" style="background-color: #ffffff"> Impact of Skills<br>';
					// ROGUE
					if (user.stats.class == 'rogue') {
						var x = totalUnbuffed.per;
						var y = toolsOfTheTrade; 
						var high = 0; 
						var low = 0;
						// Schleife nach unten  
						while (y == toolsOfTheTrade) {
							x--;
							y  = Math.round((100 * x) / (50 + x));
							}
							low = x + 1; 
						// Schleife nach oben  
						var x = totalUnbuffed.per;
						var y = toolsOfTheTrade; 
						while (y == toolsOfTheTrade) {
							x++;
							y  = Math.round((100 * x) / (50 + x));
							}
							high = x - 1; 
						htmlStats += '<font size="-2">Tools of the Trade: +' + toolsOfTheTrade +'PER<br>';	
						htmlStats += 'PER<sub>unb</sub>=' + totalUnbuffed.per + '&#8712;{' + low + ',..,' + high + '}<br>';
						htmlStats += 'Stealth: ' + stealth + ' dailies<br>';  
						var xp = Math.round(75*backstab / (backstab + 50)); 
						var gold = Math.round(18 * backstab / (backstab + 75));
						htmlStats += 'Backstab: ' + xp + 'XP + ' + gold + 'GP<br>' ;
						var gold = Math.round(25 * pickpocket / (pickpocket + 75));
						htmlStats +='Pickpocket: ' + gold + 'GP</font>';
						} // end if ROGUE & continue Flexbox 2, 4, 6
					//MAGE
					if (user.stats.class == 'wizard') {
						var x = totalUnbuffed.int;
						var y = earthquake; 
						var high = 0; 
						var low = 0;
						// Schleife nach unten  
						while (y == earthquake) {
							x--;
							y  = Math.round((30 * x) / (200 + x));
							}
							low = x + 1; 
						// Schleife nach oben  
						var x = totalUnbuffed.int;
						var y = earthquake; 
						while (y == earthquake) {
							x++;
							y  = Math.round((30 * x) / (200 + x));
							}
							high = x - 1; 
						htmlStats += '<font size="-2">Earthquake: +' + earthquake + 'INT<br>';	
						htmlStats += 'INT<sub>unb</sub> = ' + totalUnbuffed.int  + '&#8712;{' + low + ',..,' + high + '}<br>';
						htmlStats += 'Eth.Surge : +' + etherealSurge + 'mana<br>';  
						var xp = Math.round(75 * burstOfFlames / (burstOfFlames + 37.5));
						htmlStats += 'BrstfFlms: ' + total.int / 10 + 'dmg, ' + xp + 'XP<br></font>'; 
						}
					if (user.stats.class == 'healer') {
						htmlStats += '<font sitze ="-2">Healing Light: +' + healingLight + 'HP <br>';
						htmlStats += 'Sear.Brightness: ' + searingBrightness + '<br>'; 
						htmlStats += 'Protective Aura: +' + protectiveAura + 'CON<br>';
						htmlStats += 'Blessing: +' + blessing + 'HP</fron>';
						}
					//WARRIOR
					if (user.stats.class == 'warrior') {
						htmlStats += '<font size="-2">BrtSmsh: ' + brutalSmashTask + 'TskVal, +' + brutalSmashDamage + 'dmg<br>'; 
						htmlStats += 'DefStance: +' + defensiveStance + 'CON<sub>You</sub><br>'; 
						var x = totalUnbuffed.str;
						var y = valorousPresence; 
						var high = 0; 
						var low = 0;
						// Schleife nach unten  
						while (y == valorousPresence) {
							x--;
							y  = Math.round((20 * x) / (200 + x));
							}
							low = x + 1; 
						// Schleife nach oben  
						var x = totalUnbuffed.str;
						var y = valorousPresence; 
						while (y == valorousPresence) {
							x++;
							y  = Math.round((20 * x) / (200 + x));
							}
							high = x - 1; 
						htmlStats += 'Val.Pres.: +' + valorousPresence + 'STR<sub>Party</sub><br>';	
						htmlStats += 'STR<sub>unb</sub> = ' + totalUnbuffed.str  + '&#8712;{' + low + ',..,' + high + '}<br>';
						htmlStats +='Int.Gaze: +' + intimidatingGaze + 'CON<sub>Party</sub></font>';
						} // end if WARRIOR
		htmlStats +='</div>'+
					'<div class="mana" style="background-color: #ffffff"> Maximum Mana: ' + manaMax + '<br>' +
					'Mana refresh ...<br>' +
					'- per Habit: ' + (Math.round((habit * 100)) / 100) + '<br>' +
					'- per Daily: ' + (Math.round((dailyToDo * 100)) / 100) + '<br>' +
					'- per To-Do: ' + (Math.round((dailyToDo * 100)) / 100) + '<br>' +
					'</div></section>';
					 	




}; // end of function calculateAttributes



//////////////////////////////
//// calculate and display wardrobes and stats
//////////////////////////////

function picsToFlexbox(copyGear) {
	htmlStats +='<br>'; 	
		for (var i in gearLocation) { //gearLocation = [head, armor, ... eyewear], i = 1..8
       	 	var gear = gearLocation[i];
			if (gear in copyGear === true && typeof copyGear[gear] != 'undefined' ) {
					htmlStats += '<a class="wrap"><img src="https://habitica-assets.s3.amazonaws.com/mobileApp/images/shop_' + copyGear[gear] + '.png">' + 
  					'<p class="description">' + content.gear.flat[copyGear[gear]].text +
					'<br>INT: ' + content.gear.flat[copyGear[gear]].int + ' PER: ' + content.gear.flat[copyGear[gear]].per +
					'<br>STR: ' + content.gear.flat[copyGear[gear]].str + ' CON: ' + content.gear.flat[copyGear[gear]].con + '</p>' ;
					} // end if copyGear[gear]
			} // end for var i in gearLocation
	htmlStats +='</a></div>'; // end single box (flexbox 2 - intelligence)
	
} // end function picsToFlexboxes


	var copyGear = JSON.parse(JSON.stringify(user.items.gear.equipped)); // make a deep copy of user.items.gear.equipped so not to corrupt the origninal var
	legendary.headAccessory = copyGear.headAccessory; // Accessory in legendary is deriven from effective equipment
	legendary.back = copyGear.back;
	legendary.body = copyGear.body;
	legendary.eyewear = copyGear.eyewear;
		
	htmlStats = '<div class="flex-container">'; 
	
	//start flexbox 1
	// initialGear: 
	htmlStats += '<div id="Initial" style="background-color: #cccccc"><h3>Equipped Gear:</h3>'; 
	calculateAttributes(copyGear); // continue with content of flexbox 1 there
	htmlStats +='<br>'; 	
		for (var i in gearLocation) { //gearLocation = [head, armor, ... eyewear], i = 1..8
       	 	var gear = gearLocation[i];
			if (gear in copyGear === true) {	
					htmlStats += '<a class="wrap"><img src="https://habitica-assets.s3.amazonaws.com/mobileApp/images/shop_' + copyGear[gear] + '.png">' + 
  					'<p class="description">' + content.gear.flat[copyGear[gear]].text +
					'<br>INT: ' + content.gear.flat[copyGear[gear]].int + ' PER: ' + content.gear.flat[copyGear[gear]].per +
					'<br>STR: ' + content.gear.flat[copyGear[gear]].str + ' CON: ' + content.gear.flat[copyGear[gear]].con + '</p>' ;
					} // end if copyGear[gear]
			} // end for var i in gearLocation
	htmlStats +='</a></div>'; // end single box (flexbox 2, 3, ...6)


	// start Flexbox 2
	// INTELLIGENCE
	htmlStats +='<div id="Intelligence" style="background-color: #2995cd"><h3>Wardrobe Intelligence:  <input id="INT" type="submit" value=" Equip "></h3>'; //e0ffff
	// copy intelligence to copyGear so not to pullute user.items.gear.equipped anymore. 
	copyGear = {};
	gearLocation.forEach(function(gear) {
		if (gear in intelligence) {
				copyGear[gear] = intelligence[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
	
	// start flexbox 3
	// PERCEPTION
	htmlStats +='<div id="Perception" style="background-color: #4f2a93"; border: solid><h3>Wardrobe Perception:  <input id="PER" type="submit" value=" Equip "></h3>'; //continue Flexbox 5 ffdfff
	copyGear = {};
	gearLocation.forEach(function(gear) {
		if (gear in perception) {
				copyGear[gear] = perception[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
		
	// start Flexbox 4
	// STRENGTH
	htmlStats +='<div id="Strength" style="background-color: #f74e52"><h3>Wardrobe Strength:  <input id="STR" type="submit" value=" Equip "></h3>'; //continue Flexbox 7 ff9999
	copyGear = {};
	gearLocation.forEach(function(gear) {
		if (gear in strength) {
				copyGear[gear] = strength[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
	
	// start Flexbox 5 
	// CONSTITUTION
	htmlStats +='<div id="Constitution" style="background-color: #ffa623"><h3>Wardrobe Constitution:  <input id="CON" type="submit" value=" Equip "></h3>'; //continue Flexbox 9 f9f9c9
	copyGear = {};
	gearLocation.forEach(function(gear) {
		if (gear in constitution) {
				copyGear[gear] = constitution[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 	
	
	// Start Flexbox 6
	// BLESSING
	htmlStats +='<div id="Blessing" style="background-color: #f9f9c9"><h3>Wardrobe Blessing:  <input id="BLE" type="submit" value=" Equip "></h3>'; //continue Flexbox 9
	copyGear = {};
	gearLocation.forEach(function(gear) {
		if (gear in blessing) {
				copyGear[gear] = blessing[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
	// Start Flexbox 7
	// LEGENDARY
	htmlStats +='<div id="Legendary" style="background-color: #aabb88"><h3>Wardrobe Legendary: ';
	if (legendaryGearOwned == true) {htmlStats +='<input id="LEG" type="submit" value=" Equip ">'}
	htmlStats += '</h3>'; //continue Flexbox 9
	copyGear = {};
	gearLocation.forEach(function(gear) {
		if (gear in legendary) {
				copyGear[gear] = legendary[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	

	// Flexbox for info about which wardrobe is currently equipped and for some buttons
	htmlStats +='<div id="Overview and Buttons">You are wearing:' +
				'<div id="percept">Wardrobe PER</div>' +
				'<div id="blessin">Wardrobe Blessing</div>' +
				'<div id="strengt">Wardrobe STR</div>' +
				'<div id="initial">Initial wardrobe</div>' +
				'<div id="intelli">Wardrobe INT</div>' +
				'<div id="constit">Wardrobe CON</div>' +
				'<div id="legenda">Legendary wardrobe</div>' +
				'<div>You have ' + dailyCompleted + ' of ' + dailyTotal + ' dailies completed.<div></div></div>' +
				'<div>Your most valueable taks is: </div><div> ' + mostValueableTaskName + '<div></div><div> with a value of: ' + Math.round(mostValueableTaskValue) + '</div><div></div>' +
				'<input id="a" type="submit" value="Content"><br>' +
	 			'<input id="b" type="submit" value="User data"><br>' +
				'<input id="TAS" type="submit" value="Tasks"><br>' +
				'<input id="HLP" type="submit" value="Help"><br>' +
				'<input id="DGR" type="submit" value="Display Gear"><br>' +
				'<input id="RFR" type="submit" value="Refresh"><br>'
				'</div>'; // end single box;
				
	// last flexbox for graphical information about skills
	
	google.charts.load('current', {'packages':['corechart']}); 
	google.charts.setOnLoadCallback(drawChart);

	function drawChart() {
			// calculate how much unbuffed STR you currently have
			var strength = 0;
			var valorousPresence = 0; 
			
			strength = Math.floor(user.stats.lvl / 2); if ( strength > 50 ) { strength = 50;} 
			user.items.gear.equipped.forEach(function(gear) {
		if (gear in content.gear.flat[user.items.gear.equipped[gear]].str) {
				strength += (content.gear.flat[user.items.gear.equipped[gear]].str);
				}
		})
			/*
			strength += (content.gear.flat[user.items.gear.equipped.head].str);
			strength += (content.gear.flat[user.items.gear.equipped.armor].str);
			strength += (content.gear.flat[user.items.gear.equipped.shield].str);
			strength += (content.gear.flat[user.items.gear.equipped.weapon].str);
			strength += (content.gear.flat[user.items.gear.equipped.headAccessory].str);
			strength += (content.gear.flat[user.items.gear.equipped.eyewear].str);
			strength += (content.gear.flat[user.items.gear.equipped.body].str);
			strength += (content.gear.flat[user.items.gear.equipped.back].str);
			if (content.gear.flat[user.items.gear.equipped.head].klass == user.stats.class) {strength += 0.5 * (content.gear.flat[user.items.gear.equipped.head].str)};
			if (content.gear.flat[user.items.gear.equipped.armor].klass == user.stats.class) {strength += 0.5 * (content.gear.flat[user.items.gear.equipped.armor].str)};
			if (content.gear.flat[user.items.gear.equipped.shield].klass == user.stats.class) {strength += 0.5 * (content.gear.flat[user.items.gear.equipped.shield].str)};
			if (content.gear.flat[user.items.gear.equipped.weapon].klass == user.stats.class) {strength += 0.5 * (content.gear.flat[user.items.gear.equipped.weapon].str)};
			*/
			strength += user.stats.str; 
			valorousPresence = Math.ceil((20 * strength / (200 + strength)));
			
			var data = google.visualization.arrayToDataTable([
			['STR', 'Valorous Presence', {'type': 'string', 'role': 'style'}],
			[ 23, 2, null], [ 36, 3, null], [ 50, 4, null],
			[ 67, 5, null], [ 86, 6, null], [ 108, 7, null],
			[ 134, 8, null], [ 164, 9, null],
			[ strength, valorousPresence, 'point {size: 12; shape-type: star; fill-color: #a52714;}'], // Draw the star to display current values
			[ 200, 10, null], [ 245, 11, null], [ 300, 12, null]
			]);

		var options = {
			title: 'Valorous Presence = (20*STR / (200+STR))',
			// tooltip: {trigger: 'none'}, 
			//hight: 300, 
			//width: 600, 
			vAxis: {title: 'Valorous Presence', minValue: 2, maxValue: 12, ticks: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]},
			hAxis: {title: 'STR (Level + Equipment + Class Bonus + Allocation)', fontSize: 6, minValue: 23, maxValue: 300, scaleType: 'null', ticks: [23, 36, 50, 67, 86, 108, 134, 164, 200, 245, 300]},
			legend: 'none'
			};
			var chart = new google.visualization.ScatterChart(document.getElementById('Valorous Presence'));
			chart.draw(data, options);
			
			
			// calculate how much unbuffed PER you currently have
			var perception = 0;
			var ToolsOfTheTrade = 0; 
			
			perception = Math.floor(user.stats.lvl / 2); if ( perception > 50 ) { perception = 50;} 
			perception += (content.gear.flat[user.items.gear.equipped.head].per);
			perception += (content.gear.flat[user.items.gear.equipped.armor].per);
			perception += (content.gear.flat[user.items.gear.equipped.shield].per);
			perception += (content.gear.flat[user.items.gear.equipped.weapon].per);
			perception += (content.gear.flat[user.items.gear.equipped.headAccessory].per);
			perception += (content.gear.flat[user.items.gear.equipped.eyewear].per);
			perception += (content.gear.flat[user.items.gear.equipped.body].per);
			perception += (content.gear.flat[user.items.gear.equipped.back].per);
			if (content.gear.flat[user.items.gear.equipped.head].klass == user.stats.class) {perception += 0.5 * (content.gear.flat[user.items.gear.equipped.head].per)};
			if (content.gear.flat[user.items.gear.equipped.armor].klass == user.stats.class) {perception += 0.5 * (content.gear.flat[user.items.gear.equipped.armor].per)};
			if (content.gear.flat[user.items.gear.equipped.shield].klass == user.stats.class) {perception += 0.5 * (content.gear.flat[user.items.gear.equipped.shield].per)};
			if (content.gear.flat[user.items.gear.equipped.weapon].klass == user.stats.class) {perception += 0.5 * (content.gear.flat[user.items.gear.equipped.weapon].per)};
			perception += user.stats.per; 
			ToolsOfTheTrade = Math.ceil((100 * perception / (50 + perception)));
			
			var data = google.visualization.arrayToDataTable([
			['PER', 'Tools of the Trade', {'type': 'string', 'role': 'style'}],
			[ 20, 29, null], [ 30, 38, null], [ 40, 45, null],
			[ 50, 50, null], [ 60, 55, null], [ 70, 59, null],
			[ 80, 62, null], [ 90, 65, null], [ 100, 67, null],
			[ perception, ToolsOfTheTrade, 'point {size: 12; shape-type: star; fill-color: #a52714;}'], // Draw the star to display current values
			[ 110, 69, null], [ 120, 71, null], [ 130, 73, null],
			[ 140, 74, null], [ 150, 75, null], [ 160, 77, null],
			[ 170, 78, null], [ 180, 79, null], [ 190, 80, null]
			]);

		var options = {
			title: 'Tools of the Trade = (100*PER / (50+PER))',
			// tooltip: {trigger: 'none'}, 
			//hight: 300, 
			//width: 600, 
			vAxis: {title: 'Tools of the Trade', minValue: 29, maxValue: 80, ticks: [29, 45, 55, 62, 67, 71, 74, 77, 79, 80]},
			hAxis: {title: 'PER (Level + Equipment + Class Bonus + Allocation)', fontSize: 6, minValue: 20, maxValue: 190, scaleType: 'null', ticks: [20, 40, 60, 80, 100, 120, 140, 160, 180, 190]},
			legend: 'none'
			};
			
			
			var chart = new google.visualization.ScatterChart(document.getElementById('Tools of the Trade'));
			chart.draw(data, options);
			
			
			}; // end function drawChart
			
	
	htmlStats +='</div><div id="Charts">Charts:' +
				'<div id="Valorous Presence" style="width: 600px; height: 250px;">Skill: Valorous Presence: </div>'+ 
				'<div id="Tools of the Trade" style="width: 600px; height: 250px;">Skill: Tools of the Trade: </div>'+ 
	
				'</div>'; // end Flexbox; end Flexboxes

			

	$('#userStats').html(htmlStats);
	addBorderToSelectedWardrobe();

	function addBorderToSelectedWardrobe() {
	$("#percept").hide();
	$("#constit").hide();
	$("#strengt").hide();
	$("#blessin").hide();
	$("#intelli").hide();
	$("#legenda").hide();
	$("#initial").hide();
	
	$("#Intelligence").css({"border": "none", "border-color": "yellow"});
	$("#Perception").css({"border": "none", "border-color": "yellow"});
	$("#Constitution").css({"border": "none", "border-color": "yellow"});
	$("#Strength").css({"border": "none", "border-color": "yellow"});
	$("#Blessing").css({"border": "none", "border-color": "yellow"});
	$("#Legendary").css({"border": "none", "border-color": "yellow"});

	
	if (wardrobeEquipped == 'Initial') { // show if initial wardrobe is not one of Habitican Wardrobes, else hide Initial
		$('#Initial').css({"border": "solid", "border-color": "#4f2a93"});
		} else
		{$('#Initial').hide();}
	console.log(JSON.stringify(wardrobeEquipped));
	if (wardrobeEquipped.includes('Intelligence')) {$('#intelli').show(); $("#Intelligence").css({"border": "solid", "border-color": "#4f2a93"});}
	if (wardrobeEquipped.includes('Perception')) {$('#percept').show(); $("#Perception").css({"border": "solid", "border-color": "#af8af3"});}
	if (wardrobeEquipped.includes('Constitution')) {$('#constit').show();$("#Constitution").css({"border": "solid", "border-color": "#4f2a93"});}
	if (wardrobeEquipped.includes('Strength')) {$('#strengt').show();$("#Strength").css({"border": "solid", "border-color": "#4f2a93"});}
	if (wardrobeEquipped.includes('Blessing')) {$('#blessin').show();$("#Blessing").css({"border": "solid", "border-color": "#4f2a93"});}
	if (wardrobeEquipped.includes('Legendary')) {$('#legenda').show();$("#Legendary").css({"border": "solid", "border-color": "#4f2a93"});}

	}; // end of function addBorderToSelectedWardrobe




    //////////////////////////////////////////////////////////////////////
    ////   equip function      (within paseData)   ///////////////////////
    //////////////////////////////////////////////////////////////////////

	function equip(wardrobe) {  // wardrobe is intelligence, perception or legendary, each with head, armor, shield and weapon
		var currentItem = '';
		var typeOfItem = '';
		//var currenType = '';
		var base = $.when({});
		var j = 0;
		var i = 0;
		console.log(wardrobe + JSON.stringify(wardrobe));
		$.each(wardrobe, function(key, itemToEquip){
			// First determine the type [Helm, Armor ...] of the Item that is goint to be equipped (The type is taken from Habitica's content)
			typeOfItem = content.gear.flat[itemToEquip].type; //eg displays: head (good)
			// Second determine which item is located in the correspondig slot [Helm, Armor...] looking at user..equipped]
			currentItem = user.items.gear.equipped[typeOfItem]; //eg displays: helm_special_2
			// verify if item is already equipped
			if (itemToEquip == user.items.gear.equipped[typeOfItem]) {
				equipCountSkip++;
				htmlEnd += content.gear.flat[itemToEquip].text + '<br>';
				if (equipCountSkip===Object.keys(wardrobe).length){ // if equipCountSkip = amount of inventory in wardrobe
					equipCountSkip=0;
					$("#modalContent").html('already equipped');
					$('#modal').show();
					setInterval(function(){
					$("#modal").hide();
					},1500)
				} // end if equipCountSkip
			} else {
				htmlEnd += content.gear.flat[itemToEquip].text + '<br>';
				base = base.then(fireAjax(itemToEquip, typeOfItem));	
			} // end else
		}); // end each


	function fireAjax(itemToEquip, typeOfItem) {
		return function(){
			var defer = $.Deferred();
			$("#modalContent").html('equipping gear can take 10 seconds<br>afterwards please sync Habitica');
			$("#modal").show();
				$.ajax({
					url: 'https://habitica.com/api/v3/user/equip/equipped/'+ itemToEquip,
					type: 'POST',
					dataType: 'json',
					cache: false,
					beforeSend: function(xhr){
						xhr.setRequestHeader('x-api-user', userID);
						xhr.setRequestHeader('x-api-key',  apiToken);
					},
					success: function(){user.items.gear.equipped[typeOfItem] = itemToEquip;},
					complete: function(){defer.resolve();},
					error: function(){alert('Error firing Ajax. No such key: ' + itemToEquip + ' in ' + typeOfItem);}
				}); // end ajax
				defer.promise().then(function(){ // this was hard to code // might be anywhere in the code
						equipCount++;
						if (equipCount + equipCountSkip === Object.keys(wardrobe).length){
							equipCount = 0;
							equipCountSkip = 0;
							$('#modal').hide();
							compareGear(); 
							parseData();
						}		
				});
			return defer.promise();
		// example here: http://www.jefferydurand.com/jquery/sequential/javascript/ajax/2015/04/13/jquery-sequential-ajax-promise-deferred.html
		}; // end of wrap function
	}; // end of fireAjax(itemToEquip)
}; // end of equip



	////////////////////////////////////
	//// Buttons ///////////////////////
	////////////////////////////////////

	 $('#buttons').html(buttons);

	 $('#a').click(function(){$('#displayContent').html('<div>This is Habitica\'s content: <br><pre>' + JSON.stringify(content.gear.flat, null, 4) + '</pre></div>');});
	 $('#b').click(function(){$('#displayContent').html('<div>This is your user profile: <br><pre>' + JSON.stringify(user, null, 4) + '</pre></div>');});
	 $('#TAS').click(function(){$('#displayContent').html('<div>These are your tasks: <br><pre>' + JSON.stringify(tasksFromDb, null, 4) + '</pre></div>'); evaluateTasks();});
	 $('#INT').click(function(){
				htmlEnd = '<div>Wardrobe INT <br>';
				equip(intelligence);
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				addBorderToSelectedWardrobe('intelligence');
				});
	 $('#PER').click(function(){
	 			htmlEnd = '<div> Wardrobe PER <br>';
				equip(perception);
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				addBorderToSelectedWardrobe('perception');
				});
	  $('#CON').click(function(){
	 			htmlEnd = '<div> Wardrobe CON <br>';
				equip(constitution);
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				addBorderToSelectedWardrobe('constitution');
				});
	 $('#LEG').click(function(){
	 			htmlEnd = '<div>Wardrobe Legendary Equipment <br>';
				equip(legendary);
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				addBorderToSelectedWardrobe('legendary');
				});
	 $('#BLE').click(function(){
	 			htmlEnd = '<div>Wardrobe Blessing (CON + INT) <br>';
				equip(blessing);
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				addBorderToSelectedWardrobe('blessing');
				});		
	 $('#STR').click(function(){
	 			htmlEnd = '<div>Wardrobe Strength <br>';
				equip(strength);
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				addBorderToSelectedWardrobe('strength');
				});	
	 $('#TOT').click(function(){
	 			$('#modalContent').html('casting: Tools of the Trade');
				$("#modal").show();
				$.ajax({
					url: 'https://habitica.com/api/v3/user/class/cast/toolsOfTrade',
					type: 'POST',
					dataType: 'json',
					cache: false,
					beforeSend: function(xhr){
						xhr.setRequestHeader('x-api-user', userID);
						xhr.setRequestHeader('x-api-key',  apiToken);
						},
					success: function(){$("#modal").hide();},
					error: function(){$("#modal").hide();alert('Error using skill: Tools of the Trade');}
					}); //end of ajax
				}); //end of click
	$('#HLP').click(function(){
				htmlEnd =   '<div>Version 1.3 (Feb. 2019) <br><br>' +
							'For help see <a href="http://habitica.wikia.com/wiki/Habitican_Wardrobes">Habitican Wardrobes</a>' +
							'<br>';
				$('#displayContent').html(htmlEnd);
				$('#modalContent').html('Help pressed');
				$("#modal").show();
				setInterval(function(){
					$("#modal").hide();
					},3000);
				}); // end of click
	$('#DGR').click(function(){
			getMaxGear();
			var displayGear='<div><pre>Best INT Gear: ' + JSON.stringify(intelligence, null, 4) + '</pre></div>' +
							'<div><pre>Best PER Gear: ' + JSON.stringify(perception, null, 4) + '</pre></div>' +
							'<div><pre>Best STR Gear: ' + JSON.stringify(strength, null, 4) + '</pre></div>' +
							'<div><pre>Best CON Gear: ' + JSON.stringify(constitution, null, 4) + '</pre></div>' +
							'<div><pre>Best Blessing Gear: ' + JSON.stringify(blessing, null, 4) + '</pre></div>' +
							'<div><pre>Initial Gear: ' + JSON.stringify(user.items.gear.equipped, null, 4) + '</pre></div>' +
							'<div><pre>Legendary Gear: ' + JSON.stringify(legendary, null, 4) + '</pre></div>';
			$('#displayContent').html(displayGear);
			}); // end of click
	$('#RFR').click(function(){
			fetchData();
			}); // end of click


    //////////////////////////////////////////////////////////////////////
    ////   Display the HTML    (within paseData)   ///////////////////////
    //////////////////////////////////////////////////////////////////////
	$('#documentationAndForm').html(' ');
    $('#modal').hide();
    $('#output').html(htmlStart + html + htmlEnd);

} // End of parseData() and its nested functions
}); // end of global Function
</script>
<style>

/*********************************************************************
****   Page-wide   ***************************************************
*********************************************************************/

body {
    font-family: Helvetica, Arial, sans-serif;
    font-size: 14px;
    background-color: #4f2a93;
	color: #000000;
}

#outerFrame {
	margin: 0px;
	background-color: #4f2a93;
}

#innerBody {
    margin: 5px;
    padding: 5px; 
    background-color: #eeeeee;
	color: #000000;
	border-radius: 8px;
}

#loading {
    margin-right: 30px;
    margin-left: 30px;
    color: orange;
    font-size: 1.5em;
    font-weight: bold;
}

div.scroll {
    width: 95%;
    height: 200px;
    overflow: scroll;
}


#userNameDisplay {
    text-align: right;
    font-weight: bold;
    font-size: 1.5em;
    margin-bottom: 5px;
}
#headerExtras .showHideToggle {
    white-space: nowrap;
}
#explanationAndClearLinks span {
    padding-left: 10px;
}

.show {
    display: block;
}

.hide {
    display: none;
}

.clear {
    clear: both;
}

.flex-container {
  display: flex;
  flex-wrap: wrap;
  background-color: #dddddd;
  line-height: 250px;
  border-radius: 8px;

}

.flex-container>div {
  background-color: #eeeeee;
  border-radius: 8px;
  width:280px;
  margin: 10px;
  border: 10px;
  text-align: left;

  line-height: 13px;
  font-size: 12px;
}
.flex-displayContent {
	background-color: #eeeeee;
	display: flex;
	flex-wrap: wrap;
	margin: 10%
	width: 100%;
	height: 200px;
	overflow: scroll;

}
.flex-displayContent>div {
	width: 50%;
	margin: 10px;
	border: 10px;
	text-align: left;
	overflow:scroll;
}
/***************************
******Attriute Containers **
****************************/
.container {
    width: 97%;
    height: 80px;
    color: #4e4a57;
    margin: auto;
    padding: 0;
	border-radius: 8px;
}
.one {
    width: 47%;
    height: 70px;
	float: left;
	border-radius: 8px;
	border-style: solid;
	border-width: 3px;
	border-color: #ffffff
	
}
.two {
	width: 47%;
    margin-left: 50%;
    height: 70px;
	align: left;
	border-radius: 8px;
	border-style: solid;
	border-width: 3px;
	border-color: #ffffff


}

.innerContainer {
    width: 100%;
    height: 70px;
    background: #ffffff;
    margin: auto;
    padding: 0px;
	color: #4e4a57;
	font-family: "Roboto",sans-serif;
	
}
.innerOne {
	text-transform: uppercase;
	text-align: center;
	vertical-align: 5px;
	font-size: large;
    width: 45%;
    height: 70px;
    background: #ffffff;
	color: #4e4a57;
	float: left;
	

}
.innerTwo {
	font-size: x-small;
    margin-left: 45%;
    height: 70px;
    background: #ffffff;
	color: #4e4a57;

}

.containerMana {
    border-radius: 8px;
	width: 92%;
    height: 110px;
    color: #4e4a57;
    margin: auto;
    padding: 8px;
	background: #efffff;
	font-family: "Roboto",sans-serif;
}

.left {
    width: 58%;
    
	float: left;
}

.middle {
	width: 20%;
	text-align: right;
	float: left;
}
.right {
	width: 18%;
    margin-left: 76%;
	text-align: right;
	align: left;
}


.skills {
    width: 47%;
    height: 80px;
	float: left;
	border-radius: 8px;
	border-style: solid;
	border-width: 3px;
	border-color: #ffffff
	
}
.mana {
	width: 47%;
    margin-left: 50%;
    height: 80px;
	align: left;
	border-radius: 8px;
	border-style: solid;
	border-width: 3px;
	border-color: #ffffff


}




/***************************
*** IMG hovers *************
***************************/
.wrap {
  position: relative;
}

.description {
  border-radius: 8px;
  position: absolute;
  bottom: 5px;
  left: 1px;
  font-weight: bold;
  color: #333333;
  visibility: invisible;
  opacity: 0;
  background-color: #fefefe;
  margin: auto;
  padding: 5px;
  border: 1px solid #888888;
  width: 130px;
  z-index: 2;
}
.descriptionStats {
  border-radius: 8px;
  position: absolute;
  top: 5px;

  left: 90px;
  right: 50px;
  font-weight: bold;
  color: #333333;
  visibility: invisible;
  opacity: 0;
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888888;
  width: 150px;
  z-index: 2;
}


.wrap:hover .description {
  visibility: visible;
  opacity: 1;
}

.wrap:hover .descriptionStats {
  visibility: visible;
  opacity: 1;
}

/*********************************
Mana bars
************************************/
.manaContainer {
  width: 100%;
  background-color: #271b3d;
  color: #ffffff;
  font-size: 1.0em;

}

.manaBar {
  position: relative;
  line-height: 20px;
  height: 20px;



}
.manaText {
  position: absolute; z-index:1;
  text-align: right;
  padding-left: 10px;
  color: #d5c8ff;
  font-size: 0.8em;
	}

.current {width: 80%; background-color: #50b5e9;}
.cron {width: 95%; background-color: #50b5e9;}
.cap {width: 5%; background-color: #f74e52;}

/**********************************************************************
****** Modal **********************************************************
**********************************************************************/
/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 100px; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
	border-radius: 8px;
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 300px;
	font-weight: bold;
}



/*********************************************************************
****   Header   ******************************************************
*********************************************************************/

h1 {
    float: left;
	font-size: 1.5em;
}

h1>a:first-child { /* "Habitica" link in header */
    color: black;
    text-decoration: none;
}

h1>a:first-child:hover { /* "Habitica" link in header */
    text-decoration: underline;
}

h1 span {
    font-size: 0.5em;
}

</style>

</head>


<body>
<!-- infoModal -->
<div id="modal" class="modal">
  <!-- Modal content -->
  <div id="modalContent" class="modal-content">
    <p>Weapon_rouge_2 equipped</p>
  </div>
</div>
<!-- end infoModal -->

<div id="innerBody">

<h1>Habitican Wardrobes
	<span>(v 1.3 Feb. 2019)</span></h1>
<div id="headerExtras"></div>
<hr class="clear" />
<div id="loading">
    <div class="good hide">
        <p>Please wait. Syncronizing with Habitica server...</p>
    </div>
    <div class="bad hide">
        <p>There was an error obtaining the data.</p>
        <ul class="padded">
            <li>Please reload the page (but perhaps wait half an hour first in case Habitica is under heavy load).</li>
            <li>If you're using Internet Explorer, try another browser. <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> or <a href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a> will be more reliable.</li>
        </ul>
    </div>
</div>

<div id="userStats"></div>

<hr class="clear" />

<div id="buttons"></div>

<hr class="clear" />


<div id="documentationAndForm">
    <iframe src="null.htm" id="formPasswdSaveFix" name="formPasswdSaveFix" style="display:none"></iframe><!-- DAMN YOU CHROME!! DAMN YOU!!!! http://stackoverflow.com/a/9116737 -->
    <form id="userApiDetailsForm" method="POST" action="" target="formPasswdSaveFix">
        <fieldset>
            <legend><span class="highlight">Enter your Habitica API details</span>
            (from <a href="https://habitica.com/user/settings/api" target="_blank"> User Icon &gt; Settings &gt; API</a>)
            </legend>
            <label for="userId"><span>User ID</span>
                <input type="text" name="userId" id="userId"  > <!-- Value entfernen -->
            </label>
            <label for="apiToken"><span>API Token</span>
                <input type="password" name="apiToken" id="apiToken" "> <!-- Value entfernen -->
            </label>

            <input type="submit" value="Fetch My Data" />
			<p class="highlight">Datenschutzerklrung:</p>
			<ul>
			Die Nutzung dieser Webseite erfolgt unter Angabe Ihrer User-ID und Ihres API-Tokens der website habitica.com. <br> 
			abbhh.de/wardrobes.html speichert Ihre Eingaben nicht. Ihre Eingaben dienen nur dem Zweck, auf den von Ihnen eingerichteten Account bei Habitica zuzugreifen. <br>
			Der Hoster dieser Webseite speichert Server-Logs anonymisiert fr 3 Monate zu statistischen Zwecken. Nach Ablauf der drei Monate werden die Daten gelscht. 
			In den ServerLogs werden Ihre IP-Adresse, Ihr verwendeter Browser, die Refferer-URL gespeichert. <br>  
			Fr allgemeine Risiken des Internetverkehrs wird keine Haftung bernommen. Angreifern kann es mglich sein, Ihre Eingaben abzufangen und so Rckschlsse auf den bei Habitica 
			hinterlegten Inhalt zu erlagen, incl. der von Ihnen dort verwendeten email-Adresse. 
			</ul>
            <p class="highlight">Privacy and security notes:</p>
            <ul>
			For using this website you need to input your User-ID and API-token. You received those from www.habitica.com as login-legitimations from Habitica. <br>
			This website does not safe your input. Your input only serve the purpose to access your habitica account. <br>
			The hoster of this website saves anoymised sever-logs for 3 months for statistical matters. After three months data is deleted. 
			The server-logs save your ip-adress, your browser, refferer-url. 
			For general risks of internet traffic liability is excluded. Attacers could be able to gather your input and draw conclusions to your data, thats saved in Habitica, your email adress included. 
			  
            <li>Your API Token is a password - do not share it with anyone, not even the maintainer of this page if you are seeking help.</li>
            <li>This page does not save your User ID and API Token to any location, but your browser might, if it has been configured to
            save form and password information. If you are using this page on a shared computer, you should clear any data that the browser
            has saved.</li>
            <li>This page will make changes to your Habitica accout. It changes equipped gear. If anything goes wrong, you will probably be
			be able to change everything back using the official access paths (webpage, app).</li>
            <li>Changes to the Habitica user data made on this webpage will take effect immediately on the official webpage or on the app. Visibility of changes 
			occur after a sync there. </li>
			<li>This page is not Habitica code. It's third party. Autor is @Piti (user of Habitica and member of the guild 'Aspiring Comrades' and 'Habitican Wardrobes').</li>
            </ul>
        </fieldset>
    </form>
</div><!-- end of div id="documentationAndForm" -->

<div class="flex-displayContent">
  <fieldset><div id="displayContent"><legend><h3>This page is about battle gear for citizens of Habitica:</h3></legend>
  <br>
   Habitican Wardrobes offers six wardrobes out of which a Habitican can choose to reach their goals faster. <br>
   <br>
   Version 1.3<br>
   Class-specific Impacts of skills were added for all classes.<br>
   Bug-fixes: <br>
   Empty inventory sports are no longer shown. <br>
   In case multiple wardrobes contain the same inventory, all those wardrobes are displayed with a boarder. <br>
   Corrected focus for Tooltips for information about gear <br> 
   undefined situations in gear fixed<br>
   euip-function was adjusted to match exact number of items in each wardrobe<br>
   <br>
   Version 1.2<br>
   Two-handed weapons were implemented.  <br>
   code was overhauled. <br>
   <br>
   Whats to come...:<br>
   <br>
   tooltips are out of focus on the equipment items.<br>
   graphical information for each slot in each wardrobe, so each slot has its unique location everytime<br>
   Accessory is too strict in wardrobes blessing and constitution . <br>
   Border to indicate which wardrobe is equipped, may show on differen wardrobe if gear in the non-chosen wardrobe is equal to the chosen one. <br>
   Heavy-Metal button<br>
   Info on how many attribute points can be added/subtracted without influence on the skills effect. <br>
   
   <br>
   old Version 1.1<br>
  Fixed bug:  Items that were lost due to death were suggested in the wardrobe, and couldn't be equipped. 
   
   </div></fieldset>
  


</div>

</div><!-- end of div id="outerFrame" -->
</body>

</html>
