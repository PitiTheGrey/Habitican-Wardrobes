<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>habitican Wardrobes</title>
    <meta name="description" content="Wardrobes for Heros of Habitica">
    <meta name="author" content="@Piti! Code is based on Alys (Alice Harris) lady_alys@oldgods.net code from Data Display Tool">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	
<script type="text/javascript">
$(function() { // wraps around all our code to not pollute global namespace
//////////////////////////////////////////////////////////////////////
////   Global Variables                              /////////////////
//////////////////////////////////////////////////////////////////////
"use strict";
let globalRemaining = 30;
let globalReset = 60;
var abort = false;
var content = {}; // Habitica's content
var user = {}; // holds user content
var tasksFromDb = {}; // holds tasks
var party = {};
var serverUrl = 'https://habitica.com:443/api/v3';
var userID = '';
var apiToken = '';
var url = '';
var allowWerewolf = false;
var legendary = {"head":"head_special_2", "armor":"armor_special_2", "weapon":"weapon_special_2","shield":"shield_special_goldenknight"};
var costume = {"head":"head_special_2", "armor":"armor_special_2", "weapon":"weapon_special_2","shield":"shield_special_goldenknight"};
let costumes = [];
var preferences = {"hair": {"base": 0}, "chair": "none"};
var blessing = {};
var intelligence = {};
var perception = {};
var constitution = {};
var strength = {};
var initialGear = {};
var amountOfSkill = 0;
var rememberGear = "true"; // use string (required by localStorage)
var castOnBluestTask = "true"; // use string (required by localStorage)
var threshold = 3;
var alternativeAttribute = 'none';
var forceAetherAmulet = 'false';
var forceComicalArrow = 'false';
var frontEnd = "skills"; // for toggling between "wardrobes" and "skills" / later get content from localstorage
var cronHelperWardrobeForTasks = 'disabled';
var cronHelperWardrobeForCron = 'disabled';
var wardrobeEquipped = ['Initial'];
var wardrobeEquippedObject = {"head":"", "armor":"", "weapon":"", "shield":"", "back":"", "body":"", "eyewear":"", "headAccessory":""}; // e.g. {"head":"head_special_2", ...} for use of intelligence, perception ...
var avatar = '';
var equipCount = 0;
var equipCountSkip = 0;
var nameOfWardrobe = 'perception';
var werewolf = false;
let emptyCostume = {
         'head':'',
         'armor':'',
         'weapon':'',
         'shield':'',
         'back':'',
         'body':'',
         'eyewear':'',
         'headAccessory':'',
         'preferences' : {'hair': {
                                   'color': '',
                                   'base': '',
                                   'bangs': '',
                                   'beard': '',
                                   'mustache': '',
                                   'flower': ''},
                          'skin': '',
                          'shirt': '',
                          'chair': '',
                          'size': '',
                          'background': ''}
        };
var skills = {"rogue": {
				"field1": {
					"name": "Tools of the Trade",
                    "API": "https://habitica.com/api/v3/user/class/cast/toolsOfTrade",
                    "cost": 25,
					"nameOfWardrobe": "Perception",
					"unlock": 13,
					"wardrobe": "perception"   // will be replaced by wardrobe-object
					},
				"field2": {
					"name": "Stealth",
                    "API": "https://habitica.com/api/v3/user/class/cast/stealth",
                    "cost": 45,
					"nameOfWardrobe": "Perception",
					"unlock": 14,
					"wardrobe": "perception" },
				"field3": {
					"name": "Pickpocket",
                    "API": "https://habitica.com/api/v3/user/class/cast/pickPocket",
                    "cost": 10,
					"nameOfWardrobe": "Perception",
					"wardrobe": "perception",
					"unlock": 11,
					"task": "pending",  // will be replaced by getBluestTask();
					"taskId": "pending"},
				"field4": {
					"name": "Backstab",
                    "API": "https://habitica.com/api/v3/user/class/cast/backStab",
                    "cost": 15,
					"nameOfWardrobe": "Strength",
					"wardrobe": "strength",
					"unlock": 12,
					"task": "pending",
					"taskId": "pending" }
				},
			  "wizard": {
				"field1": {
					"name": "Earthquake",
                    "API": "https://habitica.com/api/v3/user/class/cast/earth",
                    "cost": 35,
					"nameOfWardrobe": "Intelligence",
					"unlock": 13,
					"wardrobe": "intelligence" },
				"field2": {
					"name": "Burst of Flames",
                    "API": "https://habitica.com/api/v3/user/class/cast/fireball",
                    "cost": 10,
					"nameOfWardrobe": "Intelligence",
					"wardrobe": "intelligence",
					"unlock": 11,
					"task": "pending",
					"taskId": "pending"
					},
				"field3": {
					"name": "Ethereal Surge", 
                    "API": "https://habitica.com/api/v3/user/class/cast/mpheal",
                    "cost": 30,
					"nameOfWardrobe": "Intelligence",
					"unlock": 12,
					"wardrobe": "intelligence"
					},
				"field4": {
					"name": "Chilling Frost",
                    "API": "https://habitica.com/api/v3/user/class/cast/frost",
                    "cost": 40,
					"nameOfWardrobe": "Intelligence",
					"unlock": 14,
					"wardrobe": "intelligence" }
				},
			  "warrior": {
				"field1": {
					"name": "Valorous Presence",
                    "API": "https://habitica.com/api/v3/user/class/cast/valorousPresence",
                    "cost": 20,
					"nameOfWardrobe": "Strength",
					"unlock": 13,
					"wardrobe": "strength" },
				"field2": {
					"name": "Brutal Smash",
                    "API": "https://habitica.com/api/v3/user/class/cast/smash",
                    "cost": 10,
					"nameOfWardrobe": "Strength",
					"wardrobe": "strength",
					"unlock": 11,
					"task": "pending",
					"taskId": "pending" },
				"field3": {
					"name": "Intimidating Gaze",
                    "API": "https://habitica.com/api/v3/user/class/cast/intimidate",
                    "cost": 15,
					"nameOfWardrobe": "Constitution",
					"unlock": 14,
					"wardrobe": "constitution" },
				"field4": {
					"name": "Defensive Stance",
                    "API": "https://habitica.com/api/v3/user/class/cast/defensiveStance",
                    "cost": 25,
					"nameOfWardrobe": "Constitution",
					"unlock": 12,
					"wardrobe": "constitution" }
				},
			  "healer": {
				"field1": {
					"name": "Protective Aura",
                    "API": "https://habitica.com/api/v3/user/class/cast/protectAura",
                    "cost": 15,
					"nameOfWardrobe": "Blessing",
					"unlock": 13,
					"wardrobe": "blessing" },
				"field2": {
					"name": "Searing Brightness",
                    "API": "https://habitica.com/api/v3/user/class/cast/brightness",
                    "cost": 15,
					"nameOfWardrobe": "Constitution",
					"unlock": 12,
					"wardrobe": "constitution" },
				"field3": {
					"name": "Blessing",
                    "API": "https://habitica.com/api/v3/user/class/cast/healAll",
                    "cost": 25,
					"nameOfWardrobe": "Blessing",
					"unlock": 14,
					"wardrobe": "blessing" },
				"field4": {
					"name": "Healing Light",
                    "API": "https://habitica.com/api/v3/user/class/cast/heal",
                    "cost": 15,
					"nameOfWardrobe": "Blessing",
					"unlock": 11,
					"wardrobe": "blessing" }
				}
			};		//end skill...

//////////////////////////////////////////////////////////////////////
////   Get UUID from URL      ////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
var url_vars = getUrlVars();
if (url_vars.uuid) {
    $('#userId').val(url_vars.uuid);
}
function getUrlVars() {
    // Function found at http://stackoverflow.com/questions/4656843/jquery-get-querystring-from-url#answer-4656873
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}
//////////////////////////////////////////////////////////////////////
////   Login events      /////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
$('#userApiDetailsForm').submit(function(event){
    userID   = $('#userId').val();
    apiToken = $('#apiToken').val();
    fetchData();
});
//////////////////////////////////////////////////////////////////////
//// LocalStorage with Fallback to cookies ///////////////////////////
//////////////////////////////////////////////////////////////////////
var storeData = function storeData(key, value) {
    var lsSupport = false;
    // Check for native support
		lsSupport = (function() {
			try {
				localStorage.setItem("Test", "Test");
				localStorage.removeItem("Test");
				return true;
			} catch (exception) {
				return false;
			}
		}());
  
    // If value is detected, set new or modify store
    if (typeof value !== "undefined" && value !== null) {
        // Convert object values to JSON
        if ( typeof value === 'object' ) {
            value = JSON.stringify(value);
        }
        if (lsSupport) { 
            localStorage.setItem(key, "" + value);
        } else { // Use Cookie
            createCookie(key, value, 30);
        }
    }
    // No value supplied, return value
    if (typeof value === "undefined") {
        // Get value
        var data = null; 
		if (lsSupport) { // Native support
            data = localStorage.getItem(key);
        } else { // Use cookie 
            data = readCookie(key);
        }
        return data;
    }
    // Null specified, remove store
    if (value === null) {
        if (lsSupport) { // Native support
            localStorage.removeItem(key);
        } else { // Use cookie
            createCookie(key, '', -1);
        }
    }
    
    function createCookie(key, value, exp) {
        var date = new Date();
        date.setTime(date.getTime() + (exp * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
        document.cookie = key + "=" + value + expires + "; path=/";
    }

    function readCookie(key) {
        var nameEQ = key + "=";
        var ca = document.cookie.split(';');
        for (var i = 0, max = ca.length; i < max; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }
};

function wait(waitTime) {
  return new Promise(resolve => setTimeout(() => {
    resolve();
  }, waitTime));
}

async function rateLimit(remaining, reset) {
    // limit = total amount of requests that can be made in a 60s period, will always be 30
    // remaining = the number of remaining requests that can be made in the current 60s period
    // reset = when the current 60s period will end

    if (!remaining) {
        // called prior to 'await $.ajax' (without parameters)
        if (globalRemaining < 20) { // 20 for testing, 1 or to for production
            const secondsToReset = Math.ceil((Date.parse(globalReset) - new Date().getTime()) / 1000);
            $('#rateLimiter').show();
            for (var i=0; i < secondsToReset; i++) {
                $('#rateLimiterCountdown').html(secondsToReset - i + ' seconds');
                await wait(1010);
            }
            $('#rateLimiter').hide();
            globalRemaining = 30; // reset according to Habitica
        }
    } else {
        // invoked during 'await $.ajax' (with parameters)
        globalRemaining = remaining;
        globalReset = reset;
    }
} // end function rateLimit

async function fetchData() {
    $('#loading .bad').hide();
    $('#modalContent').html('Please wait, fetching data...');
    $('#modal').show();
    
    user = await doAjax('https://habitica.com/api/v3/user', 'GET');
    content = await doAjax('https://habitica.com/api/v3/content', 'GET');
    tasksFromDb = await doAjax('https://habitica.com/api/v3/tasks/user', 'GET');
    
    $('#modal').hide();
    parseData();
}

async function doAjax(url, method, payload){   // https://petetasker.com/using-async-await-jquerys-ajax/
    if (!method) {method = 'POST';}
    console.log(url + " // " + JSON.stringify(payload));
    let result;
    await rateLimit();
    try {
		result = await $.ajax({
			url: url,
            data: payload,
			type: method,
			dataType: 'json',
			cache: false,
			beforeSend: function(xhr){
				xhr.setRequestHeader('x-client', '9226cae6-d852-45da-a51b-ec2c9cb759e6-Habitican Wardrobes v.2.5');
				xhr.setRequestHeader('x-api-user', userID);
				xhr.setRequestHeader('x-api-key',  apiToken);
			},
			success: function(result, status, xhr){
                rateLimit(xhr.getResponseHeader('x-ratelimit-remaining'), xhr.getResponseHeader('x-ratelimit-reset'));
            }
		});
	} catch (error) {
		$('#modalContent').html(url + " / " + error.responseText + " / " + JSON.stringify(payload));
        $('#modal').show();
	}
    if (abort) {result.abort();}
    return result.data;
}; // end ajax

function storageFirstLoad() {
	//front End (wardrobes and skills)
	frontEnd = storeData('FrontEnd');
		if (!frontEnd) {
		 	frontEnd = 'wardrobes';
			storeData('FrontEnd', 'wardrobes'); // set FrontEnd to "wardrobes" on first time opening code in browser
		}
		if (frontEnd == 'wardrobes') {
			$('.skills-Container').hide();
            $('.costumes-Container').hide();
			$('.wardrobes-Container').show();
            }
		if (frontEnd == 'skills') {
			$('.skills-Container').show();
            $('.costumes-Container').hide();
			$('.wardrobes-Container').hide();
            }
        if (frontEnd == 'costumes') {
            $('.skills-Container').hide();
            $('.costumes-Container').show();
			$('.wardrobes-Container').hide();
            }
        storeData('FrontEnd', frontEnd);
        
		forceAetherAmulet = storeData("Amulet");
			if (forceAetherAmulet == "true") {$("#forceAetherAmulet").prop('checked', true);}
			if (forceAetherAmulet == null) {
				forceAetherAmulet = "true";
				storeData("Amulet", "true");
				$('#forceAetherAmulet').prop('checked', true);
			}
		
		forceComicalArrow = storeData("Arrow"); 
			if (forceComicalArrow == "true") {$("#forceAetherAmuletAndComicalArrow").prop('checked', true);}
			if (forceComicalArrow == null) {
				forceComicalArrow = "true";
				storeData("Arrow", "true");
				$('#forceComicalArrow').prop('checked', true);
			}
		
		allowWerewolf = storeData("Werewolf");
			if (allowWerewolf == 'true') {
				$('#allowWerewolf').prop('checked', true);
				$('#werewolf').show();
				storeData('Werewolf', 'true');
			} else {
				$('#allowWerewolf').prop('checked', false);
				$('#werewolf').hide();
				storeData('Werewolf', 'false');
				allowWerewolf = false;
			}
				
		rememberGear = storeData("Remember Gear");
			if (rememberGear != "false")
				{$('#rememberGear').prop('checked', true); rememberGear = "true";}
			else {
				{$('#rememberGear').prop('checked', false); rememberGear = "false";}
			}
			storeData("Remember Gear", rememberGear);
			
		castOnBluestTask = storeData("Bluest Task");
			if (castOnBluestTask != "false") {
				castOnBluestTask = "true";
			} else {
				castOnBluestTask = "false";
			}
			storeData("Bluest Task", castOnBluestTask);
			
		threshold = parseInt(storeData('Hard Mode')); // typeop(threshold) = number
		if (threshold <= 9 && threshold >= 1) {
			$('#threshold').prop('value', threshold);
		} else {
			threshold = 3;
			$('#threshold').prop('value', threshold);
			storeData('Hard Mode', JSON.stringify(threshold));
		}
        
		alternativeAttribute = storeData('Alt. Attribute'); //typeof(alternativeAttribute) = string
		if (alternativeAttribute != null) {
			$('#alternativeAttribute').prop('value', alternativeAttribute);
		} else {
			alternativeAttribute = 'none';
			$('#alternativeAttribute').prop('value', alternativeAttribute);
			storeData('Alt. Attribute', alternativeAttribute);
		} 
		
		cronHelperWardrobeForTasks = storeData('Tasks');
		if (cronHelperWardrobeForTasks != null) {
			$('#cronHelperWardrobeForTasks').prop('value', cronHelperWardrobeForTasks);
		} else {
			cronHelperWardrobeForTasks = 'disabled';
			$('#cronHelperWardrobeForTasks').prop('value', cronHelperWardrobeForTasks);
			storeData('Tasks', cronHelperWardrobeForTasks);
		}
		
		cronHelperWardrobeForCron = storeData('Cron');
		if (cronHelperWardrobeForCron != null) {
			$('#cronHelperWardrobeForCron').prop('value', cronHelperWardrobeForCron);
		} else {
			cronHelperWardrobeForCron = 'disabled';
			$('#cronHelperWardrobeForCron').prop('value', cronHelperWardrobeForCron);
			storeData('Cron', cronHelperWardrobeForCron);
		}
		var isCostume = storeData('Costume');
		if (isCostume == null) {
			['head', 'armor', 'weapon', 'shield', 'headAccessory', 'back', 'body', 'eyewear'].forEach(function(element){
				costume[element] = user.items.gear.costume[element];
			})  
			storeData('Costume', JSON.stringify(costume));
		} 
		var isPreferences = storeData('Preferences');
		if (isPreferences == null) {
			preferences.chair = user.preferences.chair;
			preferences.hair.base = user.preferences.hair.base;
			storeData('Preferences', JSON.stringify(preferences));
		}
	
	} // end of funciton storageFirstLoad



//////////////////////////////////////////////////////////////////////
////   Parse Data Function   /////////////////////////////////////////
//////////////////////////////////////////////////////////////////////
function parseData() {
    var htmlStats = ''; // displaying name, class, current equipment, int, per, str, con
	var htmlStart = '';
    var html = '';
	var htmlEnd = '';
	var int = 0;
	var per = 0;
	var str = 0;
	var con = 0;
	var dailyTotal = 0;
	var dailyTotalStealth = 0;
	var dailyCompleted = 0;
	var wardrobeEquipped = ['Initial'];
	var mostValueableTaskValue = 0;
	var mostValueableTaskName = "";

    storageFirstLoad();
	werewolf();

	function getTasks(){
	for (var i in tasksFromDb){
		//exclude challengedata:
		if (jQuery.isEmptyObject(tasksFromDb[i].challenge)) {
			$('#selectTask').append($('<option>', {
				//style: "overflow: hidden;", 
				value: tasksFromDb[i].id, 
				text: tasksFromDb[i].text.slice(0, 35) + ' (val: ' + Math.round(tasksFromDb[i].value) + ')'
			}) 
			)
		}
	} // end for var i
} // end function getTasks

function displayTasks() {
	if (user.stats.class == 'wizard' || user.stats.class == 'warrior') {
		$('.bluestTask').show();  // checkbox "Cast Skill on bluest task"
		$('.skillOnTask').show(); // Textfield displayed underneath the skill-button on:...
		if (castOnBluestTask == 'true') {
			getBluestTask();
			$('.skillOnTask').html('on ' + skills[user.stats.class].field2.task)
			$('#selectTask').hide();  // dropdown select options
		    $('.taskSelector').hide();// 6th flexbox to display the dropdown select option
		} else {
			skills[user.stats.class].field2.task = $('#selectTask option:selected').text();
			skills[user.stats.class].field2.taskId = $('#selectTask option:selected').val(); 
			$('.skillOnTask').html('on ' + skills[user.stats.class].field2.task);		
			$('#selectTask').show();  // dropdown select options
		    $('.taskSelector').show();// 6th flexbox to display the dropdown select option
		}
	} else { 
		getBluestTask(); 
		$('.skillOnTask').html();
		$('.bluestTask').hide();
		$('.skillOnTask').show(); 
		$('.taskSelector').hide(); 
	}
}

function getBluestTask() {
	// get bluest Task for (Burst of Flames(Mage))   // challenge {}: Skill can only be cast on non-challenge tasks, but on habits, dailies and todos
	var bluestTaskId = "";
	var bluestTaskValue = 0;
	var bluestTaskName = "";
	for (var i in tasksFromDb){
		if (jQuery.isEmptyObject(tasksFromDb[i].challenge)) {
			if (bluestTaskValue < tasksFromDb[i].value) {
				bluestTaskValue = tasksFromDb[i].value;
				bluestTaskId = tasksFromDb[i].id
				bluestTaskName = tasksFromDb[i].text;
			}
		}
	} // end for var i in tasksFromDb
	skills.wizard.field2.task = bluestTaskName;
	skills.wizard.field2.taskId = bluestTaskId;
	skills.rogue.field3.task = bluestTaskName;
	skills.rogue.field3.taskId = bluestTaskId;
	skills.rogue.field4.task = bluestTaskName;
	skills.rogue.field4.taskId = bluestTaskId;
	skills.warrior.field2.task = bluestTaskName;
	skills.warrior.field2.taskId = bluestTaskId;
		for (var i in tasksFromDb) {
		if (tasksFromDb[i].type == 'habit') {
			if (mostValueableTaskValue < tasksFromDb[i].value) {
				mostValueableTaskValue = tasksFromDb[i].value;
				mostValueableTaskName = tasksFromDb[i].text;
			}
      			} // endIf daily or habit
		if (tasksFromDb[i].type == 'daily') {
			dailyTotalStealth++;
			if (tasksFromDb[i].isDue == true) {
				dailyTotal ++;
				}
			if (tasksFromDb[i].completed == true) {
				dailyCompleted ++;
				}
			} // end if daily
	}; // end for
	dailyCompleted += user.stats.buffs.stealth; // Rouges can go stealth and imitate dalies as done
	if (dailyCompleted > dailyTotal) {dailyCompleted = dailyTotal;} 
}; // end of function getBluestTask;

	function getMaxGear() {
		var maxInt = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
		var maxPer = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
		var maxStr = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
		var maxCon = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
		var maxBles = {"head" : 0, "armor": 0, "weapon": 0, "shield" : 0, "headAccessory": 0, "back": 0, "body": 0, "eyewear": 0};
		var factor = 1;
		var key = '';
				
		//prefill all wardrobes with the current equipment
		[intelligence, perception, strength, constitution, blessing, legendary, initialGear].forEach(function(container){
			['head', 'armor', 'weapon', 'shield', 'headAccessory', 'back', 'body', 'eyewear'].forEach(function(element){
				container[element] = user.items.gear.equipped[element];
			})
		})
		
		threshold = parseInt(storeData("Hard Mode")); // read threshold (hard mode) 
		// adjust legendary
		if (user.items.gear.owned.head_special_2 == true) {legendary.head = 'head_special_2'} // fill up legendary
		if (user.items.gear.owned.armor_special_2 == true) {legendary.armor = 'armor_special_2'}
		if (user.items.gear.owned.weapon_special_2 == true) {legendary.weapon = 'weapon_special_2'}
		if (user.items.gear.owned.shield_special_goldenknight == true) {legendary.shield = 'shield_special_goldenknight'}

		// first run: check if there is better equipment in inventory, than the epquipment currently equipped
		for (var item in user.items.gear.owned){

			key = content.gear.flat[item];
			(key.klass == user.stats.class ||
			 key.specialClass == user.stats.class) ? factor = 1.5 : factor = 1;

			if (!key.twoHanded && user.items.gear.owned[item]) {

				['head', 'armor', 'weapon', 'shield', 'headAccessory', 'back', 'body', 'eyewear'].forEach(function(element){
				// INT
					if ( 	factor * key.int > maxInt[element] &&
							key.int > 0 &&
							key.type == element &&
						    factor * key.int >= threshold) {
						intelligence[element] = key.key;
						maxInt[element] = (factor * key.int);
					} // end if
				// PER 
					if ( 	factor * key.per > maxPer[element] &&
							key.per > 0 &&
							key.type == element &&
						    factor * key.per >= threshold) {
						perception[element] = key.key;
						maxPer[element] = (factor * key.per);
					} // end if
				// CON
					if ( 	factor * key.con > maxCon[element] &&
							key.con > 0 &&
							key.type == element &&
							factor * key.con >= threshold)
						{
						constitution[element] = key.key;
						maxCon[element] = (factor * key.con);
					} // end if
				// STR
					if ( 	factor * key.str > maxStr[element] &&
							key.str > 0 &&
							key.type == element &&
							factor * key.str >= threshold)
						{
						strength[element] = key.key;
						maxStr[element] = (factor * key.str);
					} // end if
				// Blessing for Healers INT+CON
					if ( 	factor * (key.con + key.int)  > maxBles[element] &&
							(key.con + key.int) > 0 &&
							key.type == element && 
							factor * (key.con + key.int) >= threshold)
						{
						blessing[element] = key.key;
						maxBles[element] = (factor * (key.con + key.int));
						} // end if
				}) // end forEach
			} // end if twohanded
		} // end for var Item in user.items.gear.owned = end first run

		//second run: checking if there is a two-handed weapon more valueable than single handed weapon + shield
		//content.gear.flat["weapon_wizard_6"].int = 35; // corrupting one entry for testing purpose and set its INT higher as 32 so it will be chosen... delete if works
		var weaponPoints = 0;
		var shieldPoints = 0;
		var twoHandedPoints = 0;

		//INT
		if ('weapon' in intelligence) {
			(content.gear.flat[intelligence.weapon].klass == user.stats.class ||
			content.gear.flat[intelligence.weapon].specialClass == user.stats.class) ? factor = 1.5 : factor = 1;
			weaponPoints = factor * content.gear.flat[intelligence.weapon].int;
			}
		if ('shield' in intelligence) {
			(content.gear.flat[intelligence.shield].klass == user.stats.class ||
			content.gear.flat[intelligence.shield].specialClass == user.stats.class) ? factor = 1.5 : factor = 1;
			shieldPoints = factor * content.gear.flat[intelligence.shield].int;
			}
			
		for (var item in user.items.gear.owned){ // check twoHanded
			content.gear.flat[item].klass == user.stats.class ? factor = 1.5 : factor = 1;
			twoHandedPoints = factor * content.gear.flat[item].int;	
				
			if (content.gear.flat[item].twoHanded == true && twoHandedPoints > (weaponPoints + shieldPoints)) {
				intelligence.weapon = item;
				delete intelligence.shield;
			} // end if 
		} // end for var item in user.items.gear.ownded (check twoHanded)

		//PER
		if ('weapon' in perception) {
			(content.gear.flat[perception.weapon].klass == user.stats.class ||
			content.gear.flat[perception.weapon].specialClass == user.stats.class) ? factor = 1.5 : factor = 1;
			weaponPoints = factor * content.gear.flat[perception.weapon].per;
			}
		if ('shield' in perception) {
			(content.gear.flat[perception.shield].klass == user.stats.class ||
			content.gear.flat[perception.shield].specialClass == user.stats.class) ? factor = 1.5 : factor = 1;
			shieldPoints = factor * content.gear.flat[perception.shield].per;
			}

		for (var item in user.items.gear.owned){ // check twoHanded
			content.gear.flat[item].klass == user.stats.class ? factor = 1.5 : factor = 1;
			twoHandedPoints = factor * content.gear.flat[item].per;

			if (content.gear.flat[item].twoHanded == true && twoHandedPoints > (weaponPoints + shieldPoints)) {
				perception.weapon = item;
				delete perception.shield;
			} // end if
		}	// end for var item in user.items.gear.owned
		// end second run: for var item in user.items.gear.owned

		// third run - check for equipment with alternative attribute exceeding current equipment

		if (alternativeAttribute != 'none'){
			var key = content.gear.flat;
			for (var item in user.items.gear.owned){
				[intelligence, perception, strength, constitution, blessing, legendary].forEach(function(wardrobe){
					['headAccessory', 'back', 'body', 'eyewear'].forEach(function(element){
						['int', 'str', 'per', 'con'].forEach(function(attribute){ // these are meant as Habitica attributs, not 3rd-party alternativeAttributes
							if (wardrobe[element] != undefined) {
							if (key[wardrobe[element]].type == key[item].type && key[item].twhoHanded != true) {
								if (wardrobe == intelligence && key[wardrobe[element]].int < threshold) { furtherChecking() }
								if (wardrobe == perception && key[wardrobe[element]].per < threshold) { furtherChecking() }
								if (wardrobe == strength && key[wardrobe[element]].str < threshold) { furtherChecking() }
								if (wardrobe == constitution && key[wardrobe[element]].con < threshold) { furtherChecking() }
								if (wardrobe == blessing && key[wardrobe[element]].bles < threshold) { furtherChecking() }
							} // end if
								function furtherChecking() {
								if (key[item][alternativeAttribute] >= threshold && // strong alternative item
									key[wardrobe[element]][attribute] <= threshold &&  // weak element in wardorbe
									key[item][alternativeAttribute] >= key[wardrobe[element]][alternativeAttribute]) { // better alternative than wardrobes alternative

											wardrobe[element] = item;
							 				//console.log('Alternative Equipment: ' + key[item].key);
								}
							} // end funciton furtherChecking

							} else {console.log('undefined element: ' + element);} // end if undefined
						}) // end loop attribute
					}) // end loop element
				}) // end loop wardrobe 
			} // end of third for var item in user.items.gear.owned
		} // end if alternativeAttribute != 'none'
		
		
		// force Aether Amulet and Comical Arrow
		forceAetherAmulet = storeData("Amulet");
		if (forceAetherAmulet == "true") {
			$("#forceAetherAmulet").prop('checked', true);
			if (user.items.gear.owned.body_special_aetherAmulet == true) {
				[intelligence, strength, constitution, blessing, legendary].forEach(function(wardrobe){
					wardrobe.body = 'body_special_aetherAmulet';
				})
			}
		}
		forceComicalArrow = storeData("Arrow");
		if (forceComicalArrow == "true") {
			$("#forceComicalArrow").prop('checked', true);
			if (user.items.gear.owned.headAccessory_armoire_comicalArrow == true) {
				[intelligence, strength, constitution, blessing, legendary].forEach(function(wardrobe){
					wardrobe.headAccessory = 'headAccessory_armoire_comicalArrow';
				})
			}
		}
		
		// write skills to wardrobe variable
		var field = ['field1', 'field2', 'field3', 'field4'];
		field.forEach(function(item, value){
		const s = skills[user.stats.class][item].nameOfWardrobe;
			if (s == 'Intelligence') {skills[user.stats.class][item].wardrobe = intelligence}
			if (s == 'Perception') {skills[user.stats.class][item].wardrobe = perception}
			if (s == 'Strength') {skills[user.stats.class][item].wardrobe = strength}
			if (s == 'Blessing') {skills[user.stats.class][item].wardrobe = blessing}
			if (s == 'Constitution') {skills[user.stats.class][item].wardrobe = constitution}
		}); // end field.forEach

		getEquippedWardrobes();

} // end of getMaxGear



function getEquippedWardrobes() {
		// get array with all wardrobes currently equipped
		wardrobeEquipped.includes('Initial') ? wardrobeEquipped = ['Initial'] : wardrobeEquipped = [];

        if (isWardrobe(intelligence) && !wardrobeEquipped.includes('intelligence')) {wardrobeEquipped.push('intelligence');};
        if (isWardrobe(perception) && !wardrobeEquipped.includes('perception')) {wardrobeEquipped.push('perception');};
        if (isWardrobe(strength) && !wardrobeEquipped.includes('strength')) {wardrobeEquipped.push('strength');};
        if (isWardrobe(blessing) && !wardrobeEquipped.includes('blessing')) {wardrobeEquipped.push('blessing');};
        if (isWardrobe(constitution) && !wardrobeEquipped.includes('constitution')) {wardrobeEquipped.push('constitution');};
        if (isWardrobe(legendary) && !wardrobeEquipped.includes('legendary')) {wardrobeEquipped.push('legendary');};
        if (wardrobeEquipped.length > 1) {wardrobeEquipped = wardrobeEquipped.filter(function(item){return item !== 'Initial'}); }; // get rid of 'Initial' in case any other wardrobe matches
 		addBorderToSelectedWardrobe();
		
        function isWardrobe(wardrobe){ //checks if the currently equipped gear is equal to one of the wardrobes
			var equipped = true;
			["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(element) {
				if (wardrobe[element] == user.items.gear.equipped[element]) {
					wardrobeEquippedObject[element] = wardrobe[element];
				} else {
					equipped = false;
				}// end if
			}) // end forEach
			return equipped;
        }; // end of function isWardrobe
} // end of getEquippedWardrobes 

function calculateAttributes(wardrobe) {
	var equipment = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
	var bonus = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
	var total = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
	var totalUnbuffed = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
	var totalPerfectDay = {"int" : 0, "per" : 0, "str" : 0, "con" : 0};
	var level = 0;
	var perfectDay = 0;
	var manaRefresh = 0;
	var impactSkill = 0;
	var stealth = 0; // rogue
	var backstab = 0;
	var pickpocket = 0;
	var blessing = 0;
	var protectiveAura = 0;
	var valorousPresence = 0;
	var earthquake = 0;  // mage
	var burstOfFlames = 0;
	var etherealSurge = 0;
	var chillingFrost = 0;
    
    ['head', 'armor', 'weapon', 'shield', 'headAccessory', 'back', 'body', 'eyewear'].forEach(function(element){
        if (wardrobe[element] && content.gear.flat[wardrobe[element]]) {
            ['int', 'per', 'str', 'con'].forEach(function(attr) {
                if (content.gear.flat[wardrobe[element]].klass == user.stats.class ||
    				content.gear.flat[wardrobe[element]].specialClass == user.stats.class) {
                        bonus[attr] += 0.5 * content.gear.flat[wardrobe[element]][attr];
                }
                equipment[attr] += content.gear.flat[wardrobe[element]][attr];
            })
        }
    });


	level = Math.floor(user.stats.lvl / 2);
	perfectDay = Math.round(user.stats.lvl / 2);
	if (perfectDay >= 50) {perfectDay = 50;}
	if (level > 50) {level = 50;}
	
	["int", "per", "str", "con"].forEach(function(attr) {
		totalUnbuffed[attr] = level + equipment[attr] + bonus[attr] + user.stats[attr];
		total[attr] = totalUnbuffed[attr] + user.stats.buffs[attr];
		totalPerfectDay[attr] = totalUnbuffed[attr] + perfectDay;
	});
	
		var manaRefreshPerfectDay 	  = (2 * totalPerfectDay.int + 30) / 10; // manaRefreshPerfectDay is based on 100% completion rate before cron including only Perfect Day buff
		var manaRefreshCompletionRate = ((2 * totalUnbuffed.int + 30) / 10) * dailyCompleted / dailyTotal; // manaRefreshCompletionRate includes no buffs and is multipied with completion rate
		var manaMax = Math.round(2 * total.int + 30); // maximum mana points until cron = ( 2 * buffedINT + 30)
		var habit = 0.0025 * manaMax;
		var dailyToDo = 0.01 * manaMax; 
		if (manaMax < 100) {habit = 0.25; dailyToDo = 1;}
		var manaMaxAfterCronCompletionRate = Math.round(2 * totalUnbuffed.int + 30); // at cron on a non-Perfect Day, all buffs are reset to zero
		var manaMaxAfterCronPerfectDay 	   = Math.round(2 * totalPerfectDay.int + 30)//;  + Math.round(level / 2); // at cron on a Perfect Day all buffs are reset to zero, except Perfect Day buff
		var manaAfterCronCompletionRate	   = Math.round(user.stats.mp + manaRefreshCompletionRate); // before checking if manaMaxAfterCron is exceeded.
		var manaAfterCronPerfectDay		   = Math.round(user.stats.mp + manaRefreshPerfectDay); // before checking if manaMaxAfterCron is exceeded.
		var manaCapCompletionRate = 0;
		var manaCapPerfectDay = 0;
		if (dailyCompleted == dailyTotal) { // fixes bug displaying mana max after cron without perfect day buff on the left column when all dailies are completed 
			manaMaxAfterCronCompletionRate = manaMaxAfterCronPerfectDay;
			manaRefreshCompletionRate = manaRefreshPerfectDay; 
			manaAfterCronCompletionRate = manaAfterCronPerfectDay; 
		}
		if (manaAfterCronCompletionRate >= manaMaxAfterCronCompletionRate) {
			manaCapCompletionRate = manaAfterCronCompletionRate - manaMaxAfterCronCompletionRate;
		}
		if (manaAfterCronPerfectDay >= manaMaxAfterCronPerfectDay) {
			manaCapPerfectDay = manaAfterCronPerfectDay - manaMaxAfterCronPerfectDay;
		}
		//rogue
		function toolsOfTheTrade(unbuffedPer) {return Math.ceil(100 * unbuffedPer / (unbuffedPer + 50));}
		var stealth = Math.ceil(0.64 * dailyTotalStealth * total.per / (total.per + 55));
		var backstab = (mostValueableTaskValue + 1) +( 0.5 * total.str); 
		var pickpocket =(100*(mostValueableTaskValue + 1 + (0.5 * total.per))) / 100;  
		//healer
		var blessing = Math.round((total.int + total.con + 5) * 0.04);
		var protectiveAura = Math.round((200 * totalUnbuffed.con) / (200 + totalUnbuffed.con));
		var healingLight =  Math.ceil((total.con + total.int + 5) * 0.075); 
		var searingBrightness = Math.round(4 * (total.int / (total.int + 40))); 
		//warrior
		var brutalSmashTask = Math.round((2.5 * total.str / (total.str + 35)));
		var brutalSmashDamage = Math.round(55 * total.str / (total.str + 70));
		var valorousPresence = Math.ceil((20 * totalUnbuffed.str) / (200 + totalUnbuffed.str));
		var defensiveStance = Math.ceil(40 * totalUnbuffed.con / (totalUnbuffed.con + 200));
		var intimidatingGaze = Math.ceil(24 * totalUnbuffed.con / (totalUnbuffed.con + 200)); 
		 //mage
		var earthquake = Math.ceil((30 * totalUnbuffed.int) / (200 + totalUnbuffed.int));
		var burstOfFlames = (mostValueableTaskValue +1) * 0.075 * total.int;
		var etherealSurge = Math.ceil((total.int * 25) / (total.int + 125)); 
		htmlStats +='<section class="container">' +
					'<div class="one"><section class="innerContainer"><div class="innerOne"><a style="color: #f74e52; vertical-align: middle">STR:</a><h3>' + total.str + '</h3></div>' +
					'<div class="innerTwo"><a>Level: ' + level + '<br></a><a>Equipment: ' + equipment.str + '<br></a><a>Bonus: ' + bonus.str + '<br></a><a>Allocation: ' + user.stats.str + '<br></a><a>Buffs: ' + user.stats.buffs.str + '</a></div></section></div>' +
					
					'<div class="two"><section class="innerContainer"><div class="innerOne"><a style="color: #2995cd; vertical-align: middle">INT:</a><h3>' + total.int + '</h3></div>' +
					'<div class="innerTwo"><a>Level: ' + level + '<br></a><a>Equipment: ' + equipment.int + '<br></a><a>Bonus: ' + bonus.int + '<br></a><a>Allocation: ' + user.stats.int + '<br></a><a>Buffs: ' + user.stats.buffs.int + '</a></div></section></div>' +
					'</section>';
		htmlStats +='<section class="container">' +
					'<div class="one"><section class="innerContainer"><div class="innerOne"><a style="color: #ffa623; vertical-align: middle">CON:</a><h3>' + total.con + '</h3></div>' +
					'<div class="innerTwo"><a>Level: ' + level + '<br></a><a>Equipment: ' + equipment.con + '<br></a><a>Bonus: ' + bonus.con + '<br></a><a>Allocation: ' + user.stats.con + '<br></a><a>Buffs: ' + user.stats.buffs.con + '</a></div></section></div>' +
					
					'<div class="two"><section class="innerContainer"><div class="innerOne"><a style="color: #4f2a93; vertical-align: middle">PER:</a><h3>' + total.per + '</h3></div>' +
					'<div class="innerTwo"><a>Level: ' + level + '<br></a><a>Equipment: ' + equipment.per + '<br></a><a>Bonus: ' + bonus.per + '<br></a><a>Allocation: ' + user.stats.per + '<br></a><a>Buffs: ' + user.stats.buffs.per + '</a></div></section></div>' +
					'</section>';
		// Progression of Mana: 
		var manaLostOnCapCompletionRate = (user.stats.mp + manaRefreshCompletionRate - manaMaxAfterCronCompletionRate);
						if (manaLostOnCapCompletionRate < 0) {
							manaLostOnCapCompletionRate = 0;
						} else { // Perfect Day
							manaAfterCronCompletionRate = manaMaxAfterCronCompletionRate;
						}
		var manaLostOnCapPerfectDay = (user.stats.mp + manaRefreshPerfectDay - manaMaxAfterCronPerfectDay);
						if (manaLostOnCapPerfectDay < 0) {
							manaLostOnCapPerfectDay = 0;
							manaAfterCronPerfectDay = user.stats.mp + manaRefreshPerfectDay;
						} else {
							manaAfterCronPerfectDay = manaMaxAfterCronPerfectDay;
						}
		// Progression of Mana around Cron time
		if (user.stats.buffs.stealth > 0) {
			htmlStats +='<section class="containerMana"><div style="font-weight: bold">&nbsp; Progression of Mana <span style="font-weight: normal">(stealth: ' + user.stats.buffs.stealth + ' dailies)</span></div>';
		} else {htmlStats +='<section class="containerMana"><div style="font-weight: bold">&nbsp; Progression of Mana</div>';}
		 
		htmlStats +='<div class="left">Dailies completed:<br><br>' + //first column
					'current Mana:<br>' +
					'Mana refresh at cron:<br>'+
					'Mana lost on cron:<br>'+
					'Mana after Cron:<br>'+
					'Mana max after Cron:'+
					'</div>'+
					'<div class="middle">'+ // second column 
					 + dailyCompleted + '/' + dailyTotal +'<br>'+ // not all Dailies completed
					'<br>'+
					Math.round(user.stats.mp) +'<br>'+ //current mana
					Math.round(manaRefreshCompletionRate) +'<br>'+ // mana refresh calculated on ratio of completed dailies
					Math.round(-manaLostOnCapCompletionRate) +'<br>'+
					Math.round(manaAfterCronCompletionRate) +'<br>'+
					manaMaxAfterCronCompletionRate +
					'</div>'+
					'<div class="right">'+ // third column
					 + dailyTotal + '/' + dailyTotal +'<br>'+ // all Dailies completed
					'<br>'+
					 Math.round(user.stats.mp) +'<br>'+ // current mana
					 Math.round(manaRefreshPerfectDay) +'<br>'+
					 Math.round(-manaLostOnCapPerfectDay) +'<br>'+
					 Math.round(manaAfterCronPerfectDay) +'<br>' +
					 manaMaxAfterCronPerfectDay +
					'</div></section>';
		// Skills
		htmlStats +='<section class="container" style="margin: 5px">'+
					'<div class="skills" style="background-color: #ffffff"> Impact of Skills<br>';
					// ROGUE
					if (user.stats.class == 'rogue') {
						var x = totalUnbuffed.per;
						var y = toolsOfTheTrade(x); // y = toolsOfTheTrade variable
						var z = y;  // z = toolsOfTheTrade fix
						var high = 0;
						var low = 0;
						// Schleife nach unten
						while (y == z) {
							x--;
							y  = toolsOfTheTrade(x);
							}
							low = x + 1;
						// Schleife nach oben
						x = totalUnbuffed.per;
						y = toolsOfTheTrade(x);
						z = y;
						while (y == z) {
							x++;
							y  = toolsOfTheTrade(x);
							}
							high = x - 1;
							
						// start display Skills-section
						htmlStats += '<a class="wrap">';
						htmlStats += '<font size="-2">Tools of the Trade: +' + z +'PER<br>';
						//htmlStats += 'PER<sub>unb</sub>=' + totalUnbuffed.per + '&#8712;{' + low + ',..,' + high + '}<br>';
						htmlStats += 'Stealth: ' + stealth + ' dailies<br>';
						var xp = Math.round(10 * 75*backstab / (backstab + 50)) / 10;
						var goldBackstab = Math.round(100*18 * backstab / (backstab + 75)) / 100;
						htmlStats += 'Backstab: ' + xp + 'XP+' + goldBackstab + 'GP<br>' ;
						var goldPickpocket = Math.round(100 * 25 * pickpocket / (pickpocket + 75)) / 100;
						htmlStats +='Pickpocket: ' + goldPickpocket + 'GP</font>';
						// Tooltips
						htmlStats += '<p class="descriptionSkills">Tools of the Trade: +' + z + ' PER.<br><font size ="-2">Based on unbuffed Per: (' + totalUnbuffed.per + ')<br>';
						htmlStats += 'Unbuffed Per in range of ' + low + ' ... ' + high + ' will have same effect.</font><br><br>'; 
						htmlStats += 'Stealth: <font size="-2"> you will avoid </font>' + stealth + '<font size ="-2"> dailies<br>based on Per: (' + total.per + ')</font><br><br>';
						htmlStats += 'Backstab: +' + xp + ' XP +' + goldBackstab + ' GP<br><font size ="-2">Base on STR: (' + total.str + ')<br>';
						htmlStats += 'and your task: ' + mostValueableTaskName + ' with a value of ' + (Math.round(mostValueableTaskValue)) + '</font><br><br>';
						htmlStats += 'Pickpocket: ' + goldPickpocket + '<font size = "-2"><br>Based on Per: (' + total.per + ') and your task: ' + mostValueableTaskName + ' with a value of ' + (Math.round(mostValueableTaskValue)) + '</font>';
						htmlStats += '</p></a>';
						} // end if ROGUE & continue Flexbox 2, 4, 6
					//MAGE
					if (user.stats.class == 'wizard') {
						var x = totalUnbuffed.int;
						var y = earthquake;
						var high = 0;
						var low = 0;
						// Schleife nach unten
						while (y == earthquake) {
							x--;
							y = Math.round((30 * x) / (200 + x));
							}
							low = x + 1;
						// Schleife nach oben
						var x = totalUnbuffed.int;
						var y = earthquake;
						while (y == earthquake) {
							x++;
							y = Math.round((30 * x) / (200 + x));
							}
							high = x - 1;
						htmlStats += '<a class="wrap">';
						htmlStats += '<font size="-2">Earthquake: +' + earthquake + 'INT<br>';
						//htmlStats += 'INT<sub>unb</sub> = ' + totalUnbuffed.int  + '&#8712;{' + low + ',..,' + high + '}<br>';
						htmlStats += 'Eth.Surge : +' + etherealSurge + 'MP<br>';
						var xp = Math.round(75 * burstOfFlames / (burstOfFlames + 37.5));
						htmlStats += 'BrstfFlms: ' + total.int / 10 + 'dmg, ' + xp + 'XP<br></font>';
						// Tooltips
						htmlStats += '<p class="descriptionSkills">Earthquake: +' + earthquake + ' INT.<br><font size ="-2">Based on unbuffed Int: (' + totalUnbuffed.int + ')<br>';
						htmlStats += 'Unbuffed Int in range of ' + low + ' ... ' + high + ' will have same effect.</font><br><br>';
						htmlStats += 'Ethereal Surge: +' + etherealSurge + 'MP <font size ="-2">for non Mages<br>based on Int: (' + total.int + ')</font><br><br>';
						htmlStats += 'Burst of Flames: +' + (Math.ceil(total.int / 10)) + 'DMG +' + xp + 'XP<br><font size ="-2">Base on Int: (' + total.int + ')<br></font>';
						htmlStats += '</p></a>';
						}
					
					// HEALER
					if (user.stats.class == 'healer') {
						htmlStats += '<font sitze ="-2">Healing Light: +' + healingLight + 'HP <br>';
						htmlStats += 'Sear.Brightness: ' + searingBrightness + '<br>'; 
						htmlStats += 'Protective Aura: +' + protectiveAura + 'CON<br>';
						htmlStats += 'Blessing: +' + blessing + 'HP</font>';
						}
					//WARRIOR
					if (user.stats.class == 'warrior') {
						htmlStats += '<font size="-2">BrtSmsh: ' + brutalSmashTask + 'TskVal, +' + brutalSmashDamage + 'dmg<br>';
						htmlStats += 'DefStance: +' + defensiveStance + 'CON<sub>You</sub><br>'; 
						var x = totalUnbuffed.str;
						var y = valorousPresence;
						var high = 0;
						var low = 0;
						// Schleife nach unten
						while (y == valorousPresence) {
							x--;
							y = Math.round((20 * x) / (200 + x));
							}
							low = x + 1;
						// Schleife nach oben
						var x = totalUnbuffed.str;
						var y = valorousPresence;
						while (y == valorousPresence) {
							x++;
							y = Math.round((20 * x) / (200 + x));
							}
							high = x - 1;
						htmlStats += 'Val.Pres.: +' + valorousPresence + 'STR<sub>Party</sub><br>';	
						htmlStats += 'STR<sub>unb</sub> = ' + totalUnbuffed.str  + '&#8712;{' + low + ',..,' + high + '}<br>';
						htmlStats +='Int.Gaze: +' + intimidatingGaze + 'CON<sub>Party</sub></font>';
						} // end if WARRIOR
		htmlStats +='</div>'+
					'<div class="mana" style="background-color: #ffffff"> Maximum Mana: ' + manaMax + '<br>' +
					'Mana refresh ...<br>' +
					'- per Habit: ' + (Math.round((habit * 100)) / 100) + '<br>' +
					'- per Daily: ' + (Math.round((dailyToDo * 100)) / 100) + '<br>' +
					'- per To-Do: ' + (Math.round((dailyToDo * 100)) / 100) + '<br>' +
					'</div></section>';

}; // end of function calculateAttributes
//////////////////////////////
//// calculate and display Skills, Wardrobes and stats
//////////////////////////////	


///////////push in skills container 

getBluestTask();
htmlStats =		'<div class="skills-Container">'; //needs class for toggling between Wardrobes and Skills FrontEnds
htmlStats +=	'<div id="skill1"><br>'+
				'<button type="button" id="castSkill1" style="color: #2995cd"> Cast ' + skills[user.stats.class].field1.name + '</button>'+
				'<br><br>'+
				'current Mana points: ' + Math.floor(user.stats.mp) + '<br>' +
				'cost of buff: ' + skills[user.stats.class].field1.cost + '<br>' +
				'effective number of buffs: ' + Math.floor(user.stats.mp / skills[user.stats.class].field1.cost) + '<br>' +
				'<br>' +
				'<button type="button" id="sub1" class="sub">-</button>'+
    			'<input type="textfield" id="amount1" value="1" class="number" min="1" max="20">'+
    			'<button type="button" id="add1" class="add">+</button><br>'+
				'<br>'+
				'</div>'+
				'<div id="skill2"><br>'+
				'<button type="button" id="castSkill2" style="color: #2995cd"> Cast ' + skills[user.stats.class].field2.name + '</button>'+
				'<p class="skillOnTask"></p>';
				
htmlStats +=	'current Mana points: ' + Math.floor(user.stats.mp) + '<br>' +
				'cost of buff: ' + skills[user.stats.class].field2.cost + '<br>' +
				'effective number of buffs: ' + Math.floor(user.stats.mp / skills[user.stats.class].field2.cost) + '<br>' +
				'<br>' +
				'<button type="button" id="sub2" class="sub">-</button>'+
    			'<input type="textfield" id="amount2" value="1" class="number" min="1" max="20">'+
				'<button type="button" id="add2" class="add">+</button>'+
				'<br>'+
				'</div>'+
				'<div id="skill3"><br>'+
				'<button type="button" id="castSkill3" style="color: #2995cd"> Cast ' + skills[user.stats.class].field3.name + '</button>';
				if (user.stats.class == 'rogue') {htmlStats += '<br>on ' + skills.rogue.field3.task};
htmlStats += 	'<br><br>'+
				'current Mana points: ' + Math.floor(user.stats.mp) + '<br>' +
				'cost of buff: ' + skills[user.stats.class].field3.cost + '<br>' +
				'effective number of buffs: ' + Math.floor(user.stats.mp / skills[user.stats.class].field3.cost) + '<br>' +
				'<br>' +
				'<button type="button" id="sub3" class="sub">-</button>'+
    			'<input type="textfield" id="amount3" value="1" class="number" min="1" max="20">'+
    			'<button type="button" id="add3" class="add">+</button>'+
				'<br>'+
				'</div>'+
				'<div id="skill4"><br>'+
				'<button type="button" id="castSkill4" style="color: #2995cd"> Cast ' + skills[user.stats.class].field4.name + '</button>';
				if (user.stats.class == 'rogue') {htmlStats += '<br>on ' + skills.rogue.field4.task};
htmlStats += 	'<br><br>'+
				'current Mana points: ' + Math.floor(user.stats.mp) + '<br>' +
				'cost of buff: ' + skills[user.stats.class].field4.cost + '<br>' +
				'effective number of buffs: ' + Math.floor(user.stats.mp / skills[user.stats.class].field4.cost) + '<br>' +
				'<br>' +
				'<button type="button" id="sub4" class="sub">-</button>'+
    			'<input type="textfield" id="amount4" value="1" class="number min="1" max="20" />'+
    			'<button type="button" id="add4" class="add">+</button>'+
				'<br>'+
				'</div>';
	 			
htmlStats += 	'<div>Return to Wardrobe Intelligence: ';
				rememberGear == "true" ? htmlStats += '<input type="checkbox" id="rememberGear" checked="checked"/>' : htmlStats += '<input type="checkbox" id="rememberGear" />';
				
htmlStats += 	'<div class="bluestTask">Cast Skill on bluest task:';
				castOnBluestTask == "true" ? htmlStats += '<input type="checkbox" id="castOnBluestTask" checked="checked"/>' : htmlStats += '<input type="checkbox" id="castOnBluestTask" />';
				htmlStats += '</div>';
				// show + hide class "bluestTask" and "taskSelector" on document.ready
				htmlStats += '<div class="avatar"></div>' +
				// display Avatar later because getMaxGear() has not jet finished!
				'</div>';
				// loop through tasks and fill "select options" with all possible options
htmlStats +=	'<div class="taskSelector">Choose task for your skill:<br><select style="width: 250px !important; max-width: 250px; overflow: hidden;" id="selectTask" ></select></div>';

htmlStats += '</div>'; //end div skills-Container

// push in costumes-Container

setCostumesArray();


htmlStats +=	'<div class="costumes-Container">';
htmlStats +=	'<div style="height: 300px; background-color: #c42870; border: solid; border-radius: 10px; border-color: rgb(79, 42, 147)">' +
                '<h3> Your current Costume  <input id="UDC" type="submit" value="Undress"></h3><br>'+
                '<div id="costume0">' + costumeAvatar(costumes[0]) + '</div>' +
                '</div>';
htmlStats +=	'<div style="height: 300px; background-color: #d70e14">'+
                '<h3> Favorite Costume One  <input id="CS1" type="submit" value="dress up"></h3><br>'+
                '<div id="costume1">' + costumeAvatar(costumes[1]) + '</div>' +
                '<div style="padding-left: 65px;"><br><input id="SC1" type="submit" value="put your costume here"></div>' +
                '</div>';
htmlStats +=	'<div style="height: 300px; background-color: #c24d00">'+
                '<h3> Favorite Costume Two  <input id="CS2" type="submit" value="dress up"></h3><br>'+
                '<div id="costume2">' + costumeAvatar(costumes[2]) + '</div>'+
                '<div style="padding-left: 65px;"><br><input id="SC2" type="submit" value="put your costume here"></div>' +
                '</div>';
htmlStats +=	'<div style="height: 300px; background-color: #9e650f">'+
                '<h3>Favorit Costume Three  <input id="CS3" type="submit" value="dress up"></h3><br>'+
                '<div id="costume3">' + costumeAvatar(costumes[3]) + '</div>'+
                '<div style="padding-left: 65px;"><br><input id="SC3" type="submit" value="put your costume here"></div>' +
                '</div>';
htmlStats +=	'<div style="height: 300px; background-color: #2b8363">'+
                '<h3>Dressing Room  <input id="CS4" type="submit" value="dress up"></h3><br>'+
                '<div id="costume4">' + costumeAvatar(emptyCostume) + '</div>'+
                //'<div style="padding-left: 65px;"><br><input id="SC4" type="submit" value="put your costume here"></div>' +
                '</div>';
htmlStats +=	'<div style="height: 300px; background-color: #167e87">'+
                '<h3>Note</h3><br>'+
                '<div id="costume5">' +
                '</div></div>';
htmlStats += '</div>'; //end div costumes-Container

//////////end push in skills container

//	drawFlexboxes;
//function drawFlexboxes() {
	function picsToFlexbox(copyGear) {
		htmlStats +='<br>'; 
		["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(element){
			if (copyGear[element] != 'undefined' && copyGear.hasOwnProperty(element) && copyGear[element] != '' && typeof wardrobeEquippedObject[element] != 'undefined') {
				if (copyGear[element] && copyGear[element] != (element + '_base_0')) {
					htmlStats += '<a class="wrap"><img src="https://habitica-assets.s3.amazonaws.com/mobileApp/images/shop_' + copyGear[element] + '.png">' +
  						'<p class="description">' + content.gear.flat[copyGear[element]].text +
						'<br>INT: ' + content.gear.flat[copyGear[element]].int + ' PER: ' + content.gear.flat[copyGear[element]].per +
						'<br>STR: ' + content.gear.flat[copyGear[element]].str + ' CON: ' + content.gear.flat[copyGear[element]].con + '</p>';
				}
			} else {
				htmlStats += '<a class="wrap" style="width: 68px; height: 68px; opacity: 0;"><img src="https://abbhh.de/Images/68x68.png"</a>';
			} // end if copyGear[gear]
		}) // end for each
	
		htmlStats +='</a></div>'; // end single box (flexbox 2 - intelligence)
	} // end function picsToFlexboxes
	$('H1').hide();
	$('#headerExtras').html(
		'<div class="navbar">' +
			'<b>Habitican Wardrobes' +
			'</b>' +
			//'<a id="FrontEnd"><i class="fa fa-copy" aria-hidden="true"></i>&nbsp; Wardrobes/Skills</a>' +
  			'<div class="dropdown">' +
                '<button class="dropbtn"><i class="fa fa-bars fa-fw" aria-hidden="true"></i>&nbsp; Wardrobes/Skills' +
      			'<i class="fa fa-caret-down"></i>' +
    			'</button>' +
    			'<div class="dropdown-content">' +
					'<a id="FEW">Battle Gear (efficiency)</a>' +
      				'<a id="FEC">Costumes (for the looks)</a>' +
      				'<a id="FES">Skills</a>' +
    			'</div>' +
  			'</div> ' +
            '<div class="dropdown">' +
				'<button class="dropbtn"><i class="fa fa-book fa-fw" aria-hidden="true"></i>&nbsp; Data ' +
      			'<i class="fa fa-caret-down"></i>' +
    			'</button>' +
    			'<div class="dropdown-content">' +
					'<a id="PAR">Party Cron times</a>' +
      				'<a id="USR">User Data</a>' +
      				'<a id="HCT">Habitica Content</a>' +
      				'<a id="SKL">Skills</a>' +
	  				'<a id="DGR">Equipment (efficiency)</a>' +
                    '<a id="DCS">Costumes (looks)</a>' +
	  				'<a id="TAS">Tasks</a>' +
					'<a id="ICO">Avatar</a>' +
	  				'<a id="HLP">Help</a>' +
	  				'<a id="VER">Version Info</a>' +
    			'</div>' +
  			'</div> ' +
			'<a id="CRO">Cron-Helper</a>' +
			'<a id="SET"><i class="fa fa-cog fa-fw" aria-hidden="true"></i>&nbsp; Settings</a>' +
  			'<div class="topnav-right">' +  
  				'<a id="RFR"><i class="fa fa-refresh" aria-hidden="true"></i>&nbsp; Refresh</a>' +
				'<b>' + user.profile.name + '<br><span class="small">' + user.stats.class + '</span></b>' +
			'</div>' +
		'</div>'
	);

	getMaxGear();
	
	htmlStats += '<div class="wardrobes-Container">'; 
	var copyGear = JSON.parse(JSON.stringify(user.items.gear.equipped)); // make a deep copy of user.items.gear.equipped so not to corrupt the origninal var

	//start flexbox 1
	// initialGear:
	htmlStats += '<div id="Initial" style="background-color: #cccccc"><h3>Equipped Gear:</h3>';
	calculateAttributes(copyGear); // continue with content of flexbox 1 there
	htmlStats +='<br>';
		["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(element){
			if (copyGear[element] != 'undefined' && copyGear.hasOwnProperty(element) && copyGear[element] != ''  && typeof wardrobeEquippedObject[element] != 'undefined') {
				if (copyGear[element] != (element + '_base_0')) {
					htmlStats += '<a class="wrap"><img src="https://habitica-assets.s3.amazonaws.com/mobileApp/images/shop_' + copyGear[element] + '.png">' +
  						'<p class="description">' + content.gear.flat[copyGear[element]].text +
						'<br>INT: ' + content.gear.flat[copyGear[element]].int + ' PER: ' + content.gear.flat[copyGear[element]].per +
						'<br>STR: ' + content.gear.flat[copyGear[element]].str + ' CON: ' + content.gear.flat[copyGear[element]].con + '</p>' ;
				} else {console.log(element + " has empty gear slot"); }
			} else {
				htmlStats += '<a class="wrap" style="width: 68px; height: 68px; opacity: 0;"><img src="https://abbhh.de/Images/68x68.png"</a>';
			} // end if copyGear[gear]
		}) // end for each
	htmlStats +='</a></div>'; // end single box (flexbox 2, 3, ...6)
	// start Flexbox 2
	// INTELLIGENCE
	htmlStats +='<div id="Intelligence" style="background-color: #2995cd"><h3>Wardrobe Intelligence:  <input id="INT" type="submit" value=" Equip "></h3>'; //e0ffff
	// copy intelligence to copyGear so not to pullute user.items.gear.equipped anymore. 
	copyGear = {};
	["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(gear) {
		if (gear in intelligence) {
				copyGear[gear] = intelligence[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
	
	// start flexbox 3
	// PERCEPTION
	htmlStats +='<div id="Perception" style="background-color: #4f2a93"; border: solid><h3>Wardrobe Perception:  <input id="PER" type="submit" value=" Equip "></h3>'; //continue Flexbox 5 ffdfff
	copyGear = {};
	["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(gear) {
		if (gear in perception) {
				copyGear[gear] = perception[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
		
	// start Flexbox 4
	// STRENGTH
	htmlStats +='<div id="Strength" style="background-color: #f74e52"><h3>Wardrobe Strength:  <input id="STR" type="submit" value=" Equip "></h3>'; //continue Flexbox 7 ff9999
	copyGear = {};
	["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(gear) {
		if (gear in strength) {
				copyGear[gear] = strength[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
	
	// start Flexbox 5 
	// CONSTITUTION
	htmlStats +='<div id="Constitution" style="background-color: #ffa623"><h3>Wardrobe Constitution:  <input id="CON" type="submit" value=" Equip "></h3>'; //continue Flexbox 9 f9f9c9
	copyGear = {};
	["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(gear) {
		if (gear in constitution) {
				copyGear[gear] = constitution[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 	
	
	// Start Flexbox 6
	// BLESSING
	htmlStats +='<div id="Blessing" style="background-color: #f9f9c9"><h3>Wardrobe Blessing:  <input id="BLE" type="submit" value=" Equip "></h3>'; //continue Flexbox 9
	copyGear = {};
	["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(gear) {
		if (gear in blessing) {
				copyGear[gear] = blessing[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
	// Start Flexbox 7
	// LEGENDARY
	htmlStats +='<div id="Legendary" style="background-color: #aabb88"><h3>Wardrobe Legendary: <input id="LEG" type="submit" value=" Equip "></h3>'; //continue Flexbox 9
	copyGear = {};
	["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"].forEach(function(gear) {
		if (gear in legendary) {
				copyGear[gear] = legendary[gear];
				}
		})
	calculateAttributes(copyGear);
	picsToFlexbox(copyGear); 
	
	// Flexbox for info about which wardrobe is currently equipped and for some buttons
	htmlStats +='<div id="Overview">You are wearing:' +
				'<div id="percept">Wardrobe PER</div>' +
				'<div id="blessin">Wardrobe Blessing</div>' +
				'<div id="strengt">Wardrobe STR</div>' +
				'<div id="initial">Initial wardrobe</div>' +
				'<div id="intelli">Wardrobe INT</div>' +
				'<div id="constit">Wardrobe CON</div>' +
				'<div id="legenda">Legendary wardrobe</div>' +
				'<div>You have ' + dailyCompleted + ' of ' + dailyTotal + ' dailies completed.<div></div></div>' +
				'<div>Your most valueable task is: </div><div> ' + mostValueableTaskName + '<div></div><div> with a value of: ' + Math.round(mostValueableTaskValue) + '</div><div></div>' +
				'</div>' + // end single box;
				'</div>'; // end Flexboxes
		
	$('#userStats').html(htmlStats);
	addBorderToSelectedWardrobe();
    adjustCostumesContainer();
	$('#Overview').hide(); 	
	
//	} // end function drawFlexboxes; 

function addAvatar(wardrobe) {
	avatar= '' +
	'<div style="margin: -10px auto 0px 46px; width: 90px; height: 90px;">'+
	'<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/skin_' + user.preferences.skin + '.png" style="position: absolute;">';
	["eyewear", "headAccessory", "back", "body", "weapon", "armor", "head", "shield"].forEach (function(element) {
		if (wardrobeEquippedObject[element] != 'undefined' && wardrobeEquippedObject[element] != '' && typeof wardrobeEquippedObject[element] != 'undefined') {
			//console.log(element + " " + wardrobeEquippedObject[element] + " " + typeof wardrobeEquippedObject[element]);
			if (!wardrobeEquippedObject[element].includes('base_0')){
				if (element != "armor") {
					avatar += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/' + wardrobe[element] + '.png" style="position: absolute;">'
				} else {
					avatar += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/broad_' + wardrobe[element] + '.png" style="position: absolute;">'
				}
			}
		}	
	})
	avatar += '</div>';
	$('.avatar').html(avatar);
}

function addBorderToSelectedWardrobe() {

	// display of data in last Flexbox
	$("#percept").hide();
	$("#constit").hide();
	$("#strengt").hide();
	$("#blessin").hide();
	$("#intelli").hide();
	$("#legenda").hide();
	$("#initial").hide();
	
	//border to displayed wardrobes
	$("#Intelligence").css({"border": "none", "border-color": "yellow"});
	$("#Perception").css({"border": "none", "border-color": "yellow"});
	$("#Constitution").css({"border": "none", "border-color": "yellow"});
	$("#Strength").css({"border": "none", "border-color": "yellow"});
	$("#Blessing").css({"border": "none", "border-color": "yellow"});
	$("#Legendary").css({"border": "none", "border-color": "yellow"});
	if (wardrobeEquipped == 'Initial') { // show if initial wardrobe is not one of Habitican Wardrobes, else hide Initial
		$('#Initial').css({"border": "solid", "border-color": "#4f2a93"});
		} else
		{$('#Initial').hide();}
	if (wardrobeEquipped.includes('intelligence')) {$('#intelli').show(); $("#Intelligence").css({"border": "solid", "border-color": "#4f2a93"});}
	if (wardrobeEquipped.includes('perception')) {$('#percept').show(); $("#Perception").css({"border": "solid", "border-color": "#af8af3"});}
	if (wardrobeEquipped.includes('constitution')) {$('#constit').show();$("#Constitution").css({"border": "solid", "border-color": "#4f2a93"});}
	if (wardrobeEquipped.includes('strength')) {$('#strengt').show();$("#Strength").css({"border": "solid", "border-color": "#4f2a93"});}
	if (wardrobeEquipped.includes('blessing')) {$('#blessin').show();$("#Blessing").css({"border": "solid", "border-color": "#4f2a93"});}
	if (wardrobeEquipped.includes('legendary')) {$('#legenda').show();$("#Legendary").css({"border": "solid", "border-color": "#4f2a93"});}
	addAvatar(wardrobeEquippedObject);
}; // end of function addBorderToSelectedWardrobe
function prepareSkillAmounts () {
	var skillAmount = [];
	for (var i = 1; i <= 4; i++) {
		var fetchField = "skill" + JSON.stringify(i);
		var fetchAmount = "amount" + JSON.stringify(i);
		var inputFieldLS = storeData(fetchField);
		
		if (storeData(fetchField) == null || (storeData(fetchField) == "undefined")) {
				skillAmount[i-1] = "1";
				}
		if ((storeData(fetchField) != null) && (storeData(fetchField) != "undefined")) {
				skillAmount[i-1] = storeData(fetchField);
			}
			storeData(fetchField, skillAmount[i-1]);
			document.getElementById(fetchAmount).value = skillAmount[i-1];
	}	// end for
} // end function prepareSkillAmounts


// limit the amount of skills to the current Mana-level
function limitAmountOfSkill(field) {

    let amount;
    const f = field.substr(-1); // get last digit of "field1"...

    amount = parseInt($('#amount' + f).val());
    amount = Math.min(20, Math.max(amount, 1));
    storeData(('skill' + f), amount);
    amount = Math.max(0, Math.min(Math.floor(user.stats.mp / skills[user.stats.class][field].cost), amount));

    return amount;
} // end of limitAmountOfSkill


async function werewolf() {
	var element = ['head', 'armor', 'weapon', 'shield', 'headAccessory', 'back', 'body', 'eyewear'];
	var costumeEquip = {'head': '', 'armor': '', 'weapon': '', 'shield': '', 'headAccessory':'', 'back':'', 'body':'', 'eyewear':''};
	var costumeResult = {'head': '', 'armor': '', 'weapon': '', 'shield': '', 'headAccessory':'', 'back':'', 'body':'', 'eyewear':''}; // we need ..Result for writing back to user data
	var preferencesEquip = {'hair': {'base': 0}, 'chair': 'none'};
	var today = new Date();
	var year = today.getFullYear();
	var month = today.getMonth();
	var date = today.getDate();
	// get moon phase (ben-daglish.net) (full moon always on phase 15)
	var lp = 2551443;
	var now = new Date(year,month+1,date,20,35,0);
	var new_moon = new Date(1970, 0, 7, 20, 35, 0);
	var phase = ((now.getTime() - new_moon.getTime()) / 1000) % lp;
	var fullMoon = false;
	allowWerewolf = $('#allowWerewolf').is(':checked');
	if ((Math.floor(phase / (24*3600) + 1)) == 15) {fullMoon = true;} // for testing: != , for work: ==
	
	if (fullMoon && allowWerewolf) {
		//check if werewolf costume is equipped
		if (user.items.gear.costume.armor == "armor_mystery_201509" &&
			user.items.gear.costume.head == "head_mystery_201509" ) {
				console.log("Full moon and werewolf costume equipped");
		} else {
			$('#modalContent').html('today is full moon... you turn into a werewolf!');
			$('#modal').show();
			console.log("Full moon but werewolf costume not equipped");
			// equipping werewolfCostume and unequip rest (hair would be cool, but there is no API. ... Oh, wait... there is!)
			for (var i=0; i<=7; i++) {
				costume[element[i]] = user.items.gear.costume[element[i]]; // costume holds the initially equipped costume items
				if (element[i] == 'armor' && user.items.gear.costume.armor != "armor_mystery_201509"){
					costumeEquip.armor = 'armor_mystery_201509';
					costumeResult.armor = 'armor_mystery_201509';
				} else
				if (element[i] == 'head' && user.items.gear.costume.head != "head_mystery_201509"){
					costumeEquip.head = 'head_mystery_201509';
					costumeResult.head = 'head_mystery_201509';
				} else
				if (user.items.gear.costume[element[i]] != element+'_base_0') {
					costumeEquip[element[i]] = user.items.gear.costume[element[i]]; // replace with same item to unequip
					costumeResult[element[i]] = element[i] + '_base_0' // results in "nothing equipped"
				}
				
			}   // end for i
			storeData('Costume', JSON.stringify(costume));
			await callCostume(costumeEquip, costumeResult);
			// ... then handle preferences
			preferences.hair.base = user.preferences.hair.base;
			preferences.chair = user.preferences.chair;
			storeData('Preferences', JSON.stringify(preferences));
			preferencesEquip.hair.base = 0;
            await doAjax('https://habitica.com/api/v3/user', 'PUT', {'preferences.hair.base': 0});
			user.preferences.hair.base = 0;
			await doAjax('https://habitica.com/api/v3/user', 'PUT', {'preferences.chair': 'none'});
            user.preferences.chair = 'none';
			} // end else (full moon but werewolf not equipped)
			
			
	} else {
		// not full moon or werewolf not allowed  // equipping old costume back
		if (user.items.gear.costume.armor == "armor_mystery_201509" && user.items.gear.costume.head == "head_mystery_201509") {
				$('#modalContent').html('... you are no werewolf anymore!');
				$('#modal').show();
				costume = JSON.parse(storeData('Costume'));
				console.log(costume);
				for (var i = 0; i <= 7; i++) {
					if (costume[element[i]] != element[i]+'_base_0' && costume[element[i]] != user.items.gear.costume[element[i]]){
						costumeEquip[element[i]] = costume[element[i]];
						costumeResult[element[i]] = costume[element[i]];
					}	
					if (costume[element[i]] == user.items.gear.costume[element[i]]) { // item already equipped...
						costumeEquip[element[i]] = costume[element[i]]; // skip equipping later in callCostume function
						costumeResult[element[i]] = costume[element[i]];
					}
					if (costume[element[i]] == element[i]+'_base_0') { // nothing shall be equipped
						costumeEquip[element[i]] = costume[element[i]]; // skip equipping later in callCostume function
						costumeResult[element[i]] = element[i]+'_base_0';
					}
				} // end for i
				await callCostume(costumeEquip, costumeResult);
				preferences = storeData('Preferences');
				// now to the preferences:
				preferences = JSON.parse(storeData('Preferences'));
				console.log(preferences.hair.base);
                await doAjax('https://habitica.com/api/v3/user', 'PUT', {'preferences.hair.base': preferences.hair.base}); // url, method, data
				user.preferences.hair.base = preferences.hair.base;
				await doAjax('https://habitica.com/api/v3/user', 'PUT', {'preferences.chair': preferences.chair});
				user.preferences.chair = preferences.chair;
					
		} else {
			console.log("Not full moon and werewolf costume not equipped -> write costume to localStorage");
			for (var i = 0; i <= 7; i++) {
				costume[element[i]] = user.items.gear.costume[element[i]];
			} // end for i
			preferences.hair.base = user.preferences.hair.base;
			preferences.chair = user.preferences.chair; 
			storeData('Preferences', JSON.stringify(preferences));
		} // end else werewolf not equipped
	} // end else (not full moon)
} // end function werewolf

async function callSkill(amount, url, name, cost, nameOfWardrobe, field) {
  $('#modalContentAbort').css("top", "27%");
  $('#modalContentAbort').show();
  if (amount > 20) {
  	amount = 20;
	alert("The number of skills to be cast is reduced to 20 \n The field value is set back to 1 \n Please do not overload the Habitica Server");
  }
  const target = skills[user.stats.class][field].taskId; // some skills are cast on tasks
  if (target) {url += '?targetId=' + target};

  for (var i = 1; i <= amount; i++) {
  	if (!abort){
		if (target) {
			$('#modalContent').html('casting: ' + name + '<br> on ' + skills[user.stats.class][field].task + '<br>' + i + '/' + amount + '<br>&nbsp;<br>&nbsp;');
		} else {
            $('#modalContent').html('casting: ' + name + '<br>' + i + '/' + amount + '<br>&nbsp;<br>&nbsp;');
        }
		await doAjax(url);
		await wait(2000);
        user.stats.mp -= cost;
  	} // end if abort
  } //end for
  parseData();
  $('#modalContentAbort').hide();
} // end callSkills...

async function callCostume(costumeEquip, costumeResult) {
		// {"preferences.hair.base":15} to ...api/v3/user PUT
		var itemToEquip = '';
		var typeOfItem = '';
		equipCount = 0;
		equipCountSkip = 0;
		$('#modalContent').html('Equipping...');
		$('#modal').show();
		for (var i in ["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"]) {
				var element = costumeEquip[["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"][i]];  // fromat gear: head_base_0 e.g.
			// First determine the type [Helm, Armor ...] of the Item that is goint to be equipped (The type is taken from Habitica's content)
			typeOfItem = content.gear.flat[element].type; //eg displays: head (good)
			// verify if item is already equipped
			htmlEnd += content.gear.flat[element].text + '<br>';
					
			if (element == typeOfItem + '_base_0') {
					equipCountSkip++;
					if (equipCountSkip===Object.keys(costumeEquip).length){
						$('#modalContent').html('already equipped');
						await wait(1000);
					} // end if equipCountSkip
			} else {	
				url = 'https://habitica.com/api/v3/user/equip/costume/' + element;
				$('#modalContent').html('Equipping ' + itemToEquip + '<br>' + (equipCountSkip + equipCount + 1) + '/8<br>');
				console.log(url);
				await doAjax(url);
				user.items.gear.costume[typeOfItem] = costumeResult[typeOfItem];
				equipCount++;
				await wait(500);
			} // end else
		}; // end for var i
		await wait(50);
		$('#modal').hide();
		$('#modalContentAbort').hide();
} // end function callCostume

async function callWardrobe(wardrobe, nameOfWardrobe) {  // wardrobe is intelligence, perception or legendary, each with head, armor, shield and weapon
		
		var itemToEquip = '';
		var typeOfItem = '';
		equipCount = 0;
		equipCountSkip = 0; 
		$('#modalContentAbort').css("top", "32%");
		$('#modalContentAbort').show(); 
		$('#modalContent').html('Equipping...');
		$('#modal').show();
		
		
		for (var i in ["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"]) {
			if (!abort) { 
			itemToEquip = wardrobe[["head", "armor", "weapon", "shield", "headAccessory", "back", "body", "eyewear"][i]];  // fromat gear: head_base_0 e.g.
			// First determine the type [Helm, Armor ...] of the Item that is goint to be equipped (The type is taken from Habitica's content)
			if (typeof(content.gear.flat[itemToEquip]) != "undefined") {
				typeOfItem = content.gear.flat[itemToEquip].type; //eg displays: head (good)
				htmlEnd += content.gear.flat[itemToEquip].text + '<br>';
				// verify if item is already equipped
				if (user.items.gear.equipped[typeOfItem] == itemToEquip) {
					equipCountSkip++;
					if (equipCountSkip===Object.keys(wardrobe).length){ // if equipCountSkip = amount of inventory in wardrobe
						$('#modalContent').html('already equipped');
						await wait(1000);
					} // end if equipCountSkip
				} else {
					url = 'https://habitica.com/api/v3/user/equip/equipped/'+ itemToEquip;
					$('#modalContent').html('Equipping wardrobe ' + nameOfWardrobe + '<br>' + (equipCountSkip + equipCount + 1) + '/8<br>' + avatar + '<br>');
					await doAjax(url);
					user.items.gear.equipped[typeOfItem] = itemToEquip;
					wardrobeEquippedObject[typeOfItem] = itemToEquip;
					addAvatar(wardrobeEquippedObject);
					equipCount++;
					await wait(1000);
				} // end else
			} // end if undefined
		} //end if abort
		}; // end each
		await wait(50);
		$('#modal').hide();
		$('#modalContentAbort').hide();
		getEquippedWardrobes();
} // end function callWardrobe 
 
async function callTriple (amount, url, name, cost, wardrobe, nameOfWardrobe, field){ // amountOfSkill, API, "eg. Tools of the Trade, 25, perception, Object
	if (abort) {return;}
    if (wardrobeEquipped.includes(nameOfWardrobe)) {
				console.log(nameOfWardrobe + 'already equipped');
				} else {
					console.log("calling wardrobe " + nameOfWardrobe);
					await callWardrobe(wardrobe, nameOfWardrobe); 	// wardrobe ist Object here
					
				}
				$('#modalContent').html('Casting...');
				$('#modal').show();	
				await callSkill(amountOfSkill,
				    skills[user.stats.class][field].API,
				    skills[user.stats.class][field].name,
				    skills[user.stats.class][field].cost,
					skills[user.stats.class][field].nameOfWardrobe,
					field);
			getEquippedWardrobes();
			if (wardrobeEquipped.includes('intelligence')) {
					console.log(nameOfWardrobe + 'already equipped');
			} else {
					if (rememberGear=="true") { // remberGear displays as "Return to wardrobe Intelligence" on the front End. Think in FrontEnd locig here!
							if (!abort) {await callWardrobe(intelligence, 'Intelligence');}
					} else { 
							console.log("OK. leaving " + name + " equipped.");
							$('#modal').hide();}
			}
			getEquippedWardrobes();
			abort = false;
} // end callTriple

async function prepareTriple(amount, field){

    url = skills[user.stats.class][field].API;
    const name = skills[user.stats.class][field].name;
    const cost = skills[user.stats.class][field].cost;
    const wardrobe = skills[user.stats.class][field].wardrobe;
    const nameOfWardrobe = skills[user.stats.class][field].nameOfWardrobe;

	if (abort) {return;}
	if (user.stats.mp < cost) {		// not enoght mana  ==> break up immediately
		$('#modalContent').html('Not enough Mana.');
		$('#modal').show()
		await wait(1000);
		$('#modal').hide();
	} else {
		if (user.stats.lvl < skills[user.stats.class][field]){ // level not high enough
			$('#modalContent').html('You need to reach level ' + skills[user.stats.class][field].unlock + ' to cast ' + name);
			$('#modal').show();
			await wait(1000);
			$('#modal').hide();
	 	} else {
			callTriple(amount, url, name, cost, wardrobe, nameOfWardrobe, field);
	    }
	}
} // end function prepareTriple


async function partyCronTimes(){
		$('#modalContent').html('Loading group data...');
		$('#modal').show();
        console.log("loading party");
		party = await doAjax('https://habitica.com/api/v3/groups/party', 'GET');
		var modalHtml = '';
		var members; 
		var memberId = [];
		var memberData = {};
		var memberName = [];
		var memberLastCron = [];
		var memberLastCronMilliseconds = [];
		var i=0;
		for (members in party.quest.members) { // member resolves in f74e2316-cad6-4da4-83aa-1ac8c586a8fc eg
			memberId[i] = members;
			$('#modalContent').html('Loading member data...' + (i + 1));
			// memberData = await loadMember(memberId[i]);
			memberData = await doAjax('https://habitica.com/api/v3/members/' + memberId[i], 'GET');
            memberName[i] = memberData.auth.local.username;
			var date = new Date(memberData.auth.timestamps.loggedin); // transfer UTC to local time zone
			memberLastCron[i] = date.getFullYear() + '/' +
								(date.getMonth() + 1) + '/' +
								(date.getDate()<10 ? '0': '') + date.getDate() + ' ' +
								(date.getHours()<10 ? '0': '') + date.getHours() + ':' +
								(date.getMinutes()<10 ? '0': '') + date.getMinutes();
			memberLastCronMilliseconds[i] = date.getTime();  
			i++;
			}
		
		for (var i=0; i < memberLastCronMilliseconds.length; i++) {
			for (var j=0; j < i; j++) {
				if (memberLastCronMilliseconds[i] < memberLastCronMilliseconds[j]) {
					
					var x = memberLastCronMilliseconds[i];
					memberLastCronMilliseconds[i] = memberLastCronMilliseconds[j];
					memberLastCronMilliseconds[j] = x; 
					
					var x = memberName[i];
					memberName[i] = memberName[j];
					memberName[j] = x; 
					
					var x = memberLastCron[i]; 
					memberLastCron[i] = memberLastCron[j];
					memberLastCron[j] = x;
				}
			}
		}
		
		modalHtml = 	'<div>These are the recent Cron-times of all members in your party. <br>: <br><pre>' +
						'<table>' +
							'<tr>' +
								'<th>Party member</th>' +
								'<th>Last Cron</th>' +
							'</tr>';
		
		for (var i=0; i < memberName.length; i++) {
			modalHtml += '<tr>' +
			 			 	'<td>' + memberName[i] + '</td> ' +
							'<td>' + memberLastCron[i] + '</td>' +
						 '</tr>';
			}
		modalHtml += '</table>';
		$('#modal').hide();
		modalHtml += '</pre></div>';
		$('.dataSectionxy').html(modalHtml);
		$('#modalData').show();
}; 
// cronHelper Ajax section
async function scoreTaskDoAjax(id, direction, row){
		
		$('#modalContent').html('Scoring task...');
		$('#modal').show();
		
		var mana = 0;
		var gold = 0;
		var health = 0;
		var level = 0; 
		var experience = 0;
		
		// Prepare Ajax for scoring task. If ChecklitItem then score ChecklistItem
		
		for (var key in tasksFromDb) {
		
			// dealing with checklistItems
			if (tasksFromDb[key].hasOwnProperty("checklist") && tasksFromDb[key].checklist != '') {
				for (var checklistKey in tasksFromDb[key].checklist) {
						if (tasksFromDb[key].checklist[checklistKey].id == id) { 
							url = 'https://habitica.com/api/v3/tasks/' + tasksFromDb[key].id + '/checklist/' + id + '/score';
						}
				}
			}
			// dealing with main-tasks including main-tasks with checklistitems
			if (tasksFromDb[key].id == id) {
				var url = 'https://habitica.com/api/v3/tasks/' + id + '/score/' + direction
				if (tasksFromDb[key].hasOwnProperty('checklist') && tasksFromDb[key].checklist != '') {
					if (confirm('There are unchecked checklist items.\n\nAre you sure?')) {}
					else {$('#modal').hide(); return;}
				}
			}
		} // end for var key in tasksFromDB
		
		// now try ajax
        await rateLimit();
        let result;
        try {
			result = await $.ajax({
					url: url,
					type: 'POST',
					dataType: 'json',
					cache: false,
					beforeSend: function(xhr){
						xhr.setRequestHeader('x-client', '9226cae6-d852-45da-a51b-ec2c9cb759e6-Habitican Wardrobes');
						xhr.setRequestHeader('x-api-user', userID);
						xhr.setRequestHeader('x-api-key',  apiToken);
					},
                    success: function(result, status, xhr){
                        rateLimit(xhr.getResponseHeader('x-ratelimit-remaining'), xhr.getResponseHeader('x-ratelimit-reset'));
    					mana = result.data.mp - user.stats.mp;
						gold = result.data.gp - user.stats.gp;
						health = result.data.hp - user.stats.hp;
						level = result.data.lvl - user.stats.lvl;
						experience = result.data.exp - user.stats.exp;
						//write back to var user
						user.stats.mp = result.data.mp;
						user.stats.gp = result.data.gp;
						user.stats.hp = result.data.hp;
						user.stats.lvl = result.data.lvl;
						user.stats.exp = result.data.exp;

						var type = '';
                        var modalHtml = '';
                        
						(direction == 'up') ? modalHtml = 'You gained:<br>' : modalHtml = 'You lost:<br>';

						modalHtml += '<div style="width: 60%; color="#444444">' +  
						'<div style="font-size: x-small">\n' +
						'\u2022Mana: ' + Math.round(10 * mana) / 10 + ' points<br>' +
						'\u2022Gold: ' + Math.round(10 * gold) / 10 + ' points<br>' +
						'\u2022Exp.: ' + Math.round(10 * experience) / 10 + ' points<br>';
						if (level > 0) {modalHtml += '\u2022' + level + ' level<br>';}
						if (health > 0) {modalHtml += '\u2022Health: ' + Math.round(10 * health) / 10 + ' points<br>';}
						//if (result.data.hasOwnProperty('drop')) {modalHtml += '\u2022' + result.data.drop.dialog.text + 'found';}
						modalHtml += '</div>'; 

						// loop through tasksFromDb (again) to find id and set completed to true and check for deletion of row
						for (var key in tasksFromDb) {
    						// 1st treat checklistItems
							if (tasksFromDb[key].hasOwnProperty("checklist") && tasksFromDb[key].checklist != '') {
								if (tasksFromDb[key].id == id) { // resolves in 'mainTask checked, while there are checklistItems'
									tasksFromDb[key].completed = true;
								} else { // resolves as checklistItemChecked
									for (var checklistKey in tasksFromDb[key].checklist) {
										if (tasksFromDb[key].checklist[checklistKey].id == id) {
											tasksFromDb[key].checklist[checklistKey].completed = true;
										}
								    }
								}
							} else { // end if checklistItem // if not a checklistItem
									// 2nd treat non-checklistItems
									if (tasksFromDb[key].id == id) {
										if (direction == 'up' && tasksFromDb[key].type != 'habit') {
											tasksFromDb[key].completed = true;
										} 
										if (direction == 'up' && tasksFromDb[key].type == 'habit') {
											tasksFromDb[key].counterUp++;
										}
										if (direction == 'down' && tasksFromDb[key].type == 'habit') {
											tasksFromDb[key].counterDown++;
										}
									}
							} // end else not a checklistItem
						} // end for var key in tasksFromDb
						modalHtml += '</div>'; 
						$('#modalContent').html(modalHtml);
						setTimeout(function(){$('#modal').hide();}, 2000);
						console.log('calling cronhelper() again');
						cronHelper();
					} // end success function
			});
		} catch (error) {
			$('#modalContent').html('Error: '+ error.responseText);
			$('#modal').show();
			console.log(error);
			setTimeout(function(){$('#modal').hide();}, 2000);
		}

} // end function scoreTasksDoAjax

function cronHelperMakeButton(taskId, direction, type, up, down) {
	// mainTaskId is taskId in case of ChecklistItem: taskId will then be checklistId
	var result = '';

	if (type == 'daily' && direction == 'up') {
		result = '<button style="border-radius: 10px; border-style: none" class="up" id="' + taskId + '">+</button>';
		}
	if (type == 'todo' && direction == 'up') {
		result = '<button style="border-radius: 10px; border-style: none" class="up" id="' + taskId + '">+</button>';
		}
	if (type == 'habit' && direction == 'up' && up != false) {
		result = '<button style="border-radius: 10px; border-style: none" class="up" id="' + taskId + '">+</button>';
		}
	if (type == 'habit' && direction == 'down' && down != false) {
		result = '<button style="border-radius: 10px; border-style: none" class="down" id="' + taskId + '">-</button>';
		}
	return result;
} // end function cronHelperMakeButton
function cronHelper() {
	var textForTasks = '';
	var textForCron = '';
	var textGeneral = '';
	
	//tasks section - automatic selection of wardrobe takes place here already, rather than later on checking off tasks.
	if (cronHelperWardrobeForTasks == 'disabled') {
		textForTasks = 'Scoring Tasks: Automatic selection of gear is disabled.'
		textGeneral = 'Under Settings/Cron Helper: you can select optimized gear allocation.<br>Please consider that after automatically changing gear, it is not possible to determine your previously selected battle gear.<br>'	
	} else {
		textForTasks = 'Scoring Tasks: Wardrobe ' + cronHelperWardrobeForTasks + ' is equipped.';
		textGeneral = '';
		// if allowed and desired wardrobe not equipped
		if (!wardrobeEquipped.includes(cronHelperWardrobeForTasks)) {
			if (cronHelperWardrobeForTasks == 'intelligence') {callWardrobe(intelligence, 'Intelligence')}
			if (cronHelperWardrobeForTasks == 'perception') {callWardrobe(perception, 'Perception')}
			if (cronHelperWardrobeForTasks == 'strength') {callWardrobe(strength, 'Strength')}
			if (cronHelperWardrobeForTasks == 'legendary') {callWardrobe(legendary, 'Legendary')}
		}
	} // end Tasks section
	
	// cron section
	if (cronHelperWardrobeForCron == 'disabled') {
		textForCron = 'Running Cron: Automatic selection of gear is disabled.'
		textGeneral = 'Under Settings/Cron Helper: you can select optimized gear allocation.<br>Please consider that after automatically changing gear, it is not possible to determine your previously selected battle gear.<br>'	
	} else {
		textForCron = 'Running Cron: Wardrobe Intelligence will be selected.'
		if (cronHelperWardrobeForTasks != 'disabled') {
			textGeneral = '';
		}
	}

	$('#cronHelperInfo').css('font-size', 'x-small');
	$('#cronHelperInfo').html(textForTasks + '<br>' + textForCron + '<br>' + textGeneral);
	
	
	var x = document.getElementById('cronHelperTable').rows.length;
	for (var i=1; i < x; i++) { // 1st 2 lines are header and space
		document.getElementById('cronHelperTable').deleteRow(-1);
	}
	output('habit');
	output('daily');
	output('todo');
	function output(type) {
		for (var key in tasksFromDb) { // key as number for element
			if (tasksFromDb[key].type == type) {
				
				if (tasksFromDb[key].completed != true && tasksFromDb[key].isDue != false) {
					var table = document.getElementById('cronHelperTable');
					// insert spacer-row
					var row = table.insertRow(-1);
					var cell1 = row.insertCell(0);
					cell1.style.heigt = "5px";
					cell1.style.backgroundColor = "#dddddd";
					//insert data-row
					var row = table.insertRow(-1);
					var cell1 = row.insertCell(0);
					var i = 0;
					//var j = document.getElementById('cronHelperTable').rows.length; 
					if (tasksFromDb[key].hasOwnProperty("checklist") && tasksFromDb[key].checklist != '') {
						//1st Row: display taskname, type, score u/d
						cell1.innerHTML = '<div class="taskLong">' + tasksFromDb[key].text + '</div>' +
										  '<div class="taskType">' + tasksFromDb[key].type + '</div>' +
										  '<div class="score">' + cronHelperMakeButton(tasksFromDb[key].id, 'up', tasksFromDb[key].type, tasksFromDb[key].up, tasksFromDb[key].down) + '</div>' +
										  '<div class="score">' + cronHelperMakeButton(tasksFromDb[key].id, 'down', tasksFromDb[key].type, tasksFromDb[key].up, tasksFromDb[key].down) + '</div>';
										  
						//2nd ++ Rows display -, checklistItem, Chekclist, score u/d
						for (var checklistKey in tasksFromDb[key].checklist) {
							if (tasksFromDb[key].checklist[checklistKey].completed != true) {
								//var table = document.getElementById('cronHelperTable');
								var row = table.insertRow(-1);
								i++;
								(i / 2 == Math.round(i / 2)) ? row.style.backgroundColor = "#eeeeee" : row.style.backgroundColor = "#f5f5f5"
								var cell1 = row.insertCell(0);
								cell1.innerHTML = '<div class="taskShort">-</div>' +
												  '<div class="checklistItem">' + tasksFromDb[key].checklist[checklistKey].text + '</div>' +
												  '<div class="taskType">Checklist</div>' +
												  '<div class="score">' + cronHelperMakeButton(tasksFromDb[key].checklist[checklistKey].id, 'up', tasksFromDb[key].type) + '</div>' +
												  '<div class="score">' + cronHelperMakeButton(tasksFromDb[key].checklist[checklistKey].id, 'down', tasksFromDb[key].type) + '</div>';
							} // end if completed checklist
							//if (i / 2 != Math.round(i / 2)) {table.insertRow(-1); cell1=row.insertCell(0);}
						} // end for var checklistKey
						
					} else {
						// Task without any checklistItems
						var scoreInfo = '';
						var j = document.getElementById('cronHelperTable').rows.length;
						if (j / 2 == Math.round(j / 2)) {
							var row = table.insertRow(-1);
							row.insertCell(0);
						}
						
						if (tasksFromDb[key].type == 'habit') {scoreInfo = '<span style="color: #cccccc">(' + tasksFromDb[key].counterUp + '/' + tasksFromDb[key].counterDown + ')</span>'}
						if (tasksFromDb[key].type == 'daily') {scoreInfo = '<span style="color: #cccccc">(' + tasksFromDb[key].streak + ')</span>'}
						
						cell1.innerHTML = '<div class="taskLong">' + tasksFromDb[key].text + scoreInfo + '</div>' +
										  '<div class="taskType">' + tasksFromDb[key].type + '</div>' +
										  '<div class="score">' + cronHelperMakeButton(tasksFromDb[key].id, 'up', tasksFromDb[key].type, tasksFromDb[key].up, tasksFromDb[key].down) + '</div>' +
										  '<div class="score">' + cronHelperMakeButton(tasksFromDb[key].id, 'down', tasksFromDb[key].type, tasksFromDb[key].up, tasksFromDb[key].down) + '</div>';
					}
				} // end if completed	
			} // end if tasksFromDb 
		} // end for var key in tasksFromDb
	} // function output(type);
} // end function cronHelper


async function callForceCron() {
	
	if (user.needsCron == false) {
		$('#modalContent').html('Your Cron has not yet taken place.<br>Please try later!');
		$('#modal').show();
		setTimeout(function(){$('#modal').hide()}, 3000);
		return;
	} else {

		if (cronHelperWardrobeForCron == 'disabled' && !wardrobeEquipped.includes('intelligence')) {
			if (confirm('You are going to run Cron with your individually selected Battle Gear.'+
						'You might want to change to wardrobe Intelligence to gain more mana.' +
						'\n\nPlease be aware that after changing to wardobe Intelligence, there is ' +
						'no way to determine your previously selected gear.\n\nDo you want to proceed with your current gear?')){
				if (confirm('This will run Cron. Are all of your completed tasks ticked off?\n\n Are you sure you want to proceed?')) {
					await doAjax('https://habitica.com/api/v3/cron');
					fetchData();
				} else {
					alert('Action cancelled');
					return;
				}
			} else {
				alert('Action cancelled.');
				return;
			}
		} else {
			if (confirm('This will run Cron. Are all of your completed tasks ticked off?\n\n Are you sure you want to proceed?')) {
				if (!wardrobeEquipped.includes('intelligence')) { await callWardrobe('intelligence');}
				await doAjax('https://habitica.com/api/v3/cron');
				fetchData();
			}
		}
	} // end if user.needsCron
} // end async function callForceCron

function setCostumesArray() {

    costumes = [];

    for (var i = 0; i <= 5; i++) {
       costumes.push(emptyCostume);
    }
    
    costumes[0] = saveCostume();
    
    // try to read costumes one...three from storage
    for (var i = 1; i <= 3; i++) {
        const str = storeData('costume' + i);
        if (str && str != "0") {costumes[i] = JSON.parse(str);}
    }
    
} // end function setCostumesArray


function saveCostume (obj) { // save costume in array of objects

    if (obj) {
        costume = JSON.parse(JSON.stringify(obj));
    } else {

        costume = JSON.parse(JSON.stringify(emptyCostume));
        
        ['head', 'armor', 'weapon', 'shield', 'back', 'body', 'eyewear', 'headAccessory'].forEach(function(key) {
            costume[key] = user.items.gear.costume[key];
        });

        ['color', 'base', 'bangs', 'beard', 'mustache', 'flower'].forEach(function(key) {
            costume.preferences.hair[key] = user.preferences.hair[key];
        });

        ['skin', 'shirt', 'chair', 'size', 'background'].forEach(function(key) {
            costume.preferences[key] = user.preferences[key];
        });
    }
    return costume;
} // end function saveCostume()


function costumeAvatar(costume) {
	    let avatarCostume = '<div style="padding-left: 70px; height: 147px; width: 140px;">'; //margin: -10px auto 0px 46px;

        if (costume.preferences.background) {avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/background_' + costume.preferences.background + '.png" style="position: absolute;">'};
        
        if (costume.back && !costume.back.includes('base_0')) {avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/' + costume.back + '.png" class="costume">';}
        
        ['chair', 'shirt', 'skin'].forEach(function(element) {
          if (costume.preferences[element]) {
            if (element == 'chair') {
                if (costume.preferences.chair != 'none') {
                    avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/chair_' + costume.preferences[element] + '.png" class="costume">';
                }
            } else {
            if (element == 'shirt') {
               avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/' + costume.preferences.size + '_' + element + '_' + user.preferences[element] + '.png" class="costume">';
            } else {
               avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/' + element + '_' + costume.preferences[element] + '.png" class="costume">';
            }
          }
          }
        });

        ['base', 'bangs', 'beard', 'mustache', 'flower'].forEach(function(element){
          if (costume[element] || costume.preferences.hair[element]) {
            if (costume.preferences.hair[element]) {
                if (element === 'flower') {
                    avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/hair_' + element + '_' + costume.preferences.hair[element] + '.png" class="costume">';
                } else {
                    avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/hair_' + element + '_' + costume.preferences.hair[element] + '_' + costume.preferences.hair.color + '.png" class="costume">';
    	        }
            }
          }
        });

        ["eyewear", "armor", "head", "weapon", "shield", "body", "headAccessory"].forEach (function(element) {
		    if (costume[element]) {
                if (!costume[element].includes('base_0')){
            	    if (element != "armor") {
					    avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/' + costume[element] + '.png" class="costume">';
	    			} else {
		    			avatarCostume += '<img src="https://s3.amazonaws.com/habitica-assets/mobileApp/images/broad_' + costume[element] + '.png" class="costume">';
			    	}
			    }
		    }
    	});

	    avatarCostume += '</div>';
	    return avatarCostume; // returns the html-code of the avatar
} // end function costumeAvatar()


function undress(str) { // str is being passed as "UDC" of "dressup" by the callers

    if (str == 'UDC') {console.log("unequip everything");}
    if (str == 'dressup') {console.log("do not unequip, but equip all new gear");}

    let confirmed = true;
    if (!isEmpty(costumes[4])) {
        confirmed = false;
        if (confirm('This will remove your costume from the Dressing Room. Are you sure?')) {
            confirmed = true;
        }
     }

     if (confirmed) {
        
        const i = isStored(costumes[0]);
        console.log(i);
        if (i !=0) {
            $('#CS' + i).prop('disabled', false);
            $('#SC' + i).prop('disabled', true); // in oder not to loose costume too easily
        } else {
            costumes[4] = saveCostume(costumes[0]);
            $('#costume4').html(costumeAvatar(costumes[4]));
            $('#CS4').prop('disabled', false);
            storeData('costume4', costumes[4]);
        }
        // await unequip function .then =>
        costumes[0] = saveCostume(emptyCostume);
        $('#costume0').html(costumeAvatar(costumes[0]));
        $('#UDC').prop('disabled', true);

        // it's a good idea to disable the "put your costume here" buttons, because now this will save empty costumes!
        for (let i=1; i<=3; i++) {
            if ($('#SC' + i).prop('value') == 'put your costume here') {
                $('#SC' + i).prop('disabled', true);
            }
        }
    }
}

function dressup(i) {
    
    if (!isEmpty(costumes[0])) {undress('dressup')};
    
    if (i == 4) { // Dressing Room
        // 1. deal with cs0
        $('#costume0').html(costumeAvatar(costumes[4]));
        $('#UDC').prop('disabled', false);
        // await quip costume here .then=> go on
        equipCostume(costumes[4]);
        costumes[0] = saveCostume(costumes[4]);


        // 2. deal with cs4
        $('#costume4').html(costumeAvatar(emptyCostume));
        $('#CS4').prop('disabled', true);
        storeData('costume4', 0);
        costumes[4] = saveCostume(emptyCostume);
        
        // 3. deal with disabled buttons
        for (let i=1; i<=3; i++) {
            //if ($('#SC' + i).prop('value') == 'put your costume here') {
                $('#SC' + i).prop('disabled', false);
            //}
        }
    } else {
        // 1. deal with cs0
        $('#costume0').html(costumeAvatar(costumes[i]));
        $('#UDC').prop('disabled', false);
        costumes[0] = saveCostume(costumes[i]);
        
        // 2. deal with csi        
        // $('#costume' + i).html(costumeAvatar(emptyCostume)); // no, leave it stored
        $('#CS' + i).prop('disabled', true);
        // storeData('costume' + i, 0); // no, leave it stored
        // costumes[i] = saveCostume(emptyCostume); // no, leave it stored
        
        // 3. deal with disabled buttons
        for (let i=1; i<=3; i++) {
            if ($('#SC' + i).prop('value') == ' remove this costume ') {
                $('#SC' + i).prop('disabled', false);
            }
        }
    }
}


function adjustCostumesContainer(i) {

    // run first time without parameters => read LS
    if (!i) {
        for (let j=1; j<=3; j++) {
            $('#costume' + j).html(costumeAvatar(costumes[j])); // no matter if empty or not!
            if (isEmpty(costumes[j])) {
                $('#SC' + j).prop('value', 'put your costume here');
                $('#CS' + j).attr('disabled', true);
            } else {
                $('#SC' + j).prop('value', ' remove this costume ');
                if (isEquipped(costumes[j])) {
                    $('#CS' + j).attr('disabled', true);
                } else {
                   $('#CS' + j).attr('disabled', false);
                }
            }
        }
        if (isEmpty(costumes[4])) {$('#CS4').attr('disabled', true)};
    } else {
    
        // from empty container to a filled up one...
        if (isEmpty(costumes[i])) {
            if (isStored(costumes[i]) !=0) {
                $('#modalContent').html('This costume is already stored in another locker');
                $('#modal').show();
                wait(2000).then(() => $('#modal').hide());
            } else {
                costumes[i] = saveCostume(costumes[0]);
                storeData('costume' + i, costumes[i]);
                $('#costume' + i).html(costumeAvatar(costumes[i]));
                $('#SC' + i).prop('value', ' remove this costume ');
                if (isEquipped(costumes[i])) {
                    $('#CS' + i).attr('disabled', true)
                } else {
                    $('#CS' + i).attr('disabled', false);
                }
            }
        } else {
            if (confirm('You will remove this costume from your locker. \n2020 Are you sure?')) {
                $('#SC' + i).prop('value', 'put your costume here');
                $('#CS' + i).attr('disabled', true);
                costumes[i] = JSON.parse(JSON.stringify(emptyCostume));
                $('#costume' + i).html(costumeAvatar(emptyCostume));
                storeData('costume' + i, 0);
            }
        }
    }
}

function equipCostume(objNew, objOld) { // obj0 new costume, obj1 current (old) costume
    
    function select(n, o) { // new costume / old costume (note: equipping gear a 2nd time will remove it)
        /*  new:    a   a   a   -   -   -
            old:    a   b   -   a   b   -
            ==>     -   n   n   o   o   -
            (no.    1   2   2   3   3   1) */

        let result;
        if (n == o) {result = ''} // 1
        if (n && o != n) {result = n;} // 2
        if (!n && o) {result = o;} // 3
        return result;
    }

    let obj = saveCostume(emptyCostume);
    if (!objOld) {objOld = saveCostume(costumes[0]);}

    ['head', 'armor', 'weapon', 'shield', 'back', 'body', 'eyewear', 'headAccessory'].forEach (function(key) {
        obj[key] = select(objNew[key], objOld[key]);
    });
    ['color', 'base', 'bangs', 'beard', 'mustache', 'flower'].forEach (function(key) {
        obj.preferences.hair[key] = select(objNew.preferences.hair[key], objOld.preferences.hair[key]);
    });
    ['skin', 'shirt', 'chair', 'size', 'background'].forEach (function(key) {
        obj.preferences[key] = select(objNew.preferences[key], objOld.preferences[key]);
    });

    ajaxCostumes(obj);
}

async function ajaxCostumes(obj) {

    let url;
    let key;

    for (let key of ['head', 'armor', 'weapon', 'shield', 'back', 'body', 'eyewear', 'headAccessory']) {
        if (obj[key] != '' && !obj[key].includes('_base_0')) {
           //await doAjax('https://habitica.com/api/v3/user/equip/costume/' + obj[key], 'POST');
        }
    }

    for (let key of ['color', 'base', 'bangs', 'beard', 'mustache', 'flower']) {
        if (obj.preferences.hair[key] != '') {
            //let pref = {'preferences' : {'hair': {[key]: 0}}};
            let pref = {'preferences.hair': 0};
            pref.preferences.hair.push({[key]: obj.preferences.hair[key]});
            console.log("PREF: " + JSON.stringify(pref));
            pref.preferences.hair[key] = obj.preferences.hair[key];
            console.log("PREF: " + JSON.stringify(pref));
            await doAjax('https://habitica.com/api/v3/user', 'PUT', pref);
        }
    }

    for (let key of ['skin', 'shirt', 'chair', 'size']) {
        if (obj.preferences[key] != '') {
            let pref = {'preferences': {[key]: ''}};
            pref.preferences[key] = obj.preferences[key];
            console.log(JSON.stringify(pref));
            await doAjax('https://habitica.com/api/v3/user', 'PUT', pref);
        }
    }

        if (obj.preferences.background != '' && user.purchased.background[obj.preferences.background]) {
            let pref = {'preferences': {'background': ''}};
            pref.preferences.background = obj.preferences.background;
            console.log(JSON.stringify(pref));
            await doAjax('https://habitica.com/api/v3/user', 'PUT', pref);
        }
}

function iterateObject (obj, array) { // gets values for each key in a costumes-object and returns them in an array
    Object.keys(obj).forEach(key => {
        if (typeof(obj[key]) === 'object') {
            iterateObject(obj[key], array);
        } else {
            array.push(obj[key]);
        }
    })
    return array;
}

function isStored(obj) { // return number of locker, where obj is stored (1, 2, 3)

    let result = [];
    let arr = [];
    
    for (let i = 0; i <= 4; i++) {
        let array = [];
        let obj = iterateObject(costumes[i], array);
        !isEmpty(obj) ? arr.push(JSON.stringify(obj)) : arr.push(0);
    }

    for (let i = 1; i <= 4; i++) {
        if (arr[0] == arr[i] && arr[i] != 0) {
            result.push(i);
        }
    }

    result = parseInt(result[0]);
    if (!result) {result=0;}

    return result;

}

function isEmpty(obj) {
    let result = true;
    let array = [];
   
    array = iterateObject(obj, array);
    
    array.forEach(function(i) {
        if (i != "") {result = false;}
    })
    
    return result;
}

function isEquipped(obj) {
    let array;
    let result = true;

    array = [];
    let one = iterateObject(obj, array);
    
    array = [];
    let another = iterateObject(costumes[0], array);

    one.forEach(function(i) {
        if (!another.includes(i)) {result = false;}
    })
    return result;
}

async function abortFunction() {
	console.log(abort);
	$('#modalContent').html('aborting...');
	$('#modal').show();
	await wait(2000);
	abort = false;
	fetchData();
	console.log(abort);
	$('#modal').hide();
}

async function hideDropdown() {
    $('.navbar').css({pointerEvents: 'none'});
    await wait(50);
    $('.navbar').css({pointerEvents: 'auto'});
}

/////////////////////////////////////////////////
/////////////////////////////////////////////////
///////////////// Buttons ///////////////////////
/////////////////////////////////////////////////

	$( document ).ready(function() {
    	if (user.items.gear.owned.head_mystery_201509 && user.items.gear.owned.armor_mystery_201509) {
			$('#werewolf').show();
		} else {
			$('#werewolf').hide();
		}
		
		// display tasks on which a skill can be cast
		getTasks();
		displayTasks();

	});
	
	
	 $(document).click(function(event) {
	 
			var eclass = $(event.target).closest().prevObject[0].className;
			var eid = $(event.target).closest().prevObject[0].id;
			var row = $(event.target).parents('tr').index();
	 		
		
			if (eclass == 'up' || eclass == 'down') {
				//console.log(' score : col: '+ column_num + ' id: ' + eid + ' line ' + r + 'this: ' + JSON.stringify($(this).parents(1).index()));
				scoreTaskDoAjax(eid, eclass, row);
			} // end if  eclass up or down		

			// modals
			//if you click on anything except the modal itself or the "open modal" link, close the modal
 			if ($(event.target).closest("#modalDataContent, #TAS, #HCT, #USR, #SKL, #DGR, #DCS, #PAR").length == 0) {
				$('#modalData').hide();
			}
			if ($(event.target).closest('#modalHelpContent, #HLP').length == 0) {
				$('#modalHelp').hide();
			}
			if ($(event.target).closest("#modalSettingsContent, #SET").length == 0) {
				$('#modalSettings').hide();
			}
			if ($(event.target).closest("#modalVersionContent, #VER").length == 0) {
				$('#modalVersion').hide();
			}
			if ($(event.target).closest('#modalCronHelperContent, #CRO, #forceCron').length == 0){
				$('#modalCronHelper').hide();
			}
				
			if ($(event.target).closest(".close").length == 1) {
				$('#modal').hide();
				$('#modalData').hide();
				$('#modalSettings').hide();
				$('#modalVersion').hide();
				$('#modalHelp').hide();
				$('#modalCronHelper').hide();
				}
	 });
	 $('#HCT').click(function(){
	 			$('.dataSectionxy').html(
				'<div>This is Habitica\'s content: <br><pre><span style="font-size: x-small">' +
				JSON.stringify(content, null, 4) +
				'</span></pre></div>');
				$('#modalData').show();
				});
	 $('#USR').click(function(){
	 			$('.dataSectionxy').html(
				'<div>This is your user profile: <br><pre><span style="font-size: x-small">' +
				JSON.stringify(user, null, 4) +
				'</span></pre></div>');
				$('#modalData').show();
				});
	 $('#SKL').click(function(){
		 		$('.dataSectionxy').html(
				'</span><div>These are your skills: <br><pre><span style="font-size: x-small">' +
				JSON.stringify(skills[user.stats.class], null, 4) +
				'</pre></div>');
				$('#modalData').show();
				});
	 $('#PAR').click(function(){
	 			partyCronTimes();
	 			})
	 $('#CRO').click(function(){
	 			cronHelper();
	 			$('#modalCronHelper').show();
	 			})
	 $('#TAS').click(function(){
	 			var showHistory = $('#showHistory').is(':checked');
				if (showHistory != true) {
					var output = JSON.parse(JSON.stringify(tasksFromDb));
					for (var key in output) {
						if (output[key].hasOwnProperty("history")) {
							delete output[key].history;
						}
					}
					$('.dataSectionxy').html(
					'<div>These are your tasks: <br><pre><span style="font-size: x-small">' +
					JSON.stringify(output, null, 4) +
					'</span></pre></div>');
				} else {
					$('.dataSectionxy').html(
					'<div>These are your tasks: <br><pre><span style="font-size: x-small">' +
					JSON.stringify(tasksFromDb, null, 4) +
					'</span></pre></div>');
				}
				$('#modalData').show();
				});
	 $('#SET').click(function(){
	 			$('#modalSettings').show();
				});
	 $('#VER').click(function(){
	 			$('#modalVersion').show();
				});
	 $('#ICO').click(function(){
				$('.dataSectionx').html(
				'<div>This is your avatar: <br>' +
				loadAvatar() +
				'</div>');
				$('#modalData').show(); 
				});
	 $('#INT').click(function(){
	 			htmlEnd = '<div>Wardrobe INT <br>';
				callWardrobe(intelligence, "Intelligence");
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				});
	 $('#PER').click(function(){
	 			htmlEnd = '<div> Wardrobe PER <br>';
				callWardrobe(perception, "Perception");
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				});
	  $('#CON').click(function(){
	 			htmlEnd = '<div> Wardrobe CON <br>';
				callWardrobe(constitution, "Constitution");
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				});
	 $('#LEG').click(function(){
	 			htmlEnd = '<div>Wardrobe Legendary Equipment <br>';
				callWardrobe(legendary, "Legendary");
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				});
	 $('#BLE').click(function(){
	 			htmlEnd = '<div>Wardrobe Blessing (CON + INT) <br>';
				callWardrobe(blessing, 'Blessing');
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				});		
	 $('#STR').click(function(){
	 			htmlEnd = '<div>Wardrobe Strength <br>';
				callWardrobe(strength, 'Strength');
				htmlEnd += '</div>';
				$('#displayContent').html(htmlEnd);
				});
	$('#HLP').click(function(){
				$('#modalHelp').show();
				}); // end of click
	$('#DGR').click(function(){
			getMaxGear();
			const displayGear='<div>This is your equipment (battle gear / efficiency):</div><span style="font-size: x-small">' +
							'<div><pre>Best INT Gear: ' + JSON.stringify(intelligence, null, 4) + '</pre></div>' +
							'<div><pre>Best PER Gear: ' + JSON.stringify(perception, null, 4) + '</pre></div>' +
							'<div><pre>Best STR Gear: ' + JSON.stringify(strength, null, 4) + '</pre></div>' +
							'<div><pre>Best CON Gear: ' + JSON.stringify(constitution, null, 4) + '</pre></div>' +
							'<div><pre>Best Blessing Gear: ' + JSON.stringify(blessing, null, 4) + '</pre></div>' +
							'<div><pre>Legendary Gear: ' + JSON.stringify(legendary, null, 4) + '</pre></div>' +
							'<div><pre>Initial Gear HB: ' + JSON.stringify(user.items.gear.equipped, null, 4) + '</pre></div>' +
							'<div><pre>Initial Gear JS: ' + JSON.stringify(initialGear, null, 4) + '</pre></div>';
			$('.dataSectionxy').html(displayGear);
			$('#modalData').show();
			}); // end of click
    $('#DCS').click(function(){
            let displayCostumes = '<div>These are your costumes (for the looks):</div><span style="font-size: x-small">';
            for (let i = 0; i<=5; i++) {
                displayCostumes += '<div><pre>Costume ' + i + ': ' + JSON.stringify(costumes[i], null, 4) + '</pre></div>';
            }
            $('.dataSectionxy').html(displayCostumes);
            $('#modalData').show();
            });
	$('#RFR').click(function(){
			fetchData();
			}); // end of click
	$('#forceCron').click(function(){
		callForceCron();
		});

    $('#FEW').click(function(){
        storeData("FrontEnd", "wardrobes");
        $('.skills-Container').hide();
        $('.costumes-Container').hide();
        $('.wardrobes-Container').show();
        hideDropdown();
        })
    $('#FEC').click(function(){
        storeData("FrontEnd", "costumes");
        $('.skills-Container').hide();
        $('.costumes-Container').show();
        $('.wardrobes-Container').hide();
        hideDropdown();
        //if (!costume) {setCostumesArray();}
        })
    $('#FES').click(function(){
        storeData("FrontEnd", "skills");
        $('.skills-Container').show();
        $('.costumes-Container').hide();
        $('.wardrobes-Container').hide();
        hideDropdown();
        })
    // buttons in the costumes-FrontEnd
    $('#SC1').click(function(){
        adjustCostumesContainer(1);
        })
    $('#SC2').click(function(){
        adjustCostumesContainer(2);
        })
    $('#SC3').click(function(){
        adjustCostumesContainer(3);
        })
    $('#UDC').click(function(){
        undress('UDC');
        })
    $('#CS1').click(function() {
        equipCostume(costumes[1]);
        dressup(1);
        })
    $('#CS2').click(function() {
        equipCostume(costumes[2]);
        dressup(2);
        })
    $('#CS3').click(function() {
        equipCostume(costumes[3]);
        dressup(3);
        })        
    $('#CS4').click(function(){
        equipCostume(costumes[4]);
        dressup(4);
        })
        
	// buttons in the skill-FrontEnd
	$('.add').click(function () {
		if ($(this).prev().val() < 20) {
    		$(this).prev().val(+$(this).prev().val() + 1);
		}
		})
	$('.sub').click(function () {
		if ($(this).next().val() > 1) {
    		if ($(this).next().val() > 1) $(this).next().val(+$(this).next().val() - 1);
		}
		})
	$('#castSkill1').click(function () {
		amountOfSkill = limitAmountOfSkill('field1');
		prepareTriple(amountOfSkill, 'field1');
		})
	$('#castSkill2').click(function () {
		amountOfSkill = limitAmountOfSkill('field2');
		prepareTriple(amountOfSkill, 'field2');
		})
	$('#castSkill3').click(function () {
		amountOfSkill = limitAmountOfSkill('field3');
		prepareTriple(amountOfSkill, 'field3');
		})
	$('#castSkill4').click(function () {
		amountOfSkill = limitAmountOfSkill('field4');
		prepareTriple(amountOfSkill, 'field4');
		})
	$('#threshold').on('change', function(){
		threshold = $('#threshold').prop('value'); // value comes as a string form <option>
		storeData('Hard Mode', threshold); // ... needs to be stored as a string
		threshold = parseInt(threshold); // ... but needs to be number for the following code
		}); 
		$('#alternativeAttribute').on('change', function(){
		alternativeAttribute = $('#alternativeAttribute').prop('value'); // value comes as a string form <option>
		storeData('Alt. Attribute', alternativeAttribute); // ... needs to be stored as a string
		}); 
	$('#forceAetherAmulet').click(function(){
		forceAetherAmulet = JSON.stringify($('#forceAetherAmulet').is(':checked'));
		storeData('Amulet', forceAetherAmulet);
		console.log(forceAetherAmulet);
		})
	$('#forceComicalArrow').click(function(){
		forceComicalArrow = JSON.stringify($('#forceComicalArrow').is(':checked'));
		storeData('Arrow', forceComicalArrow);
		console.log(forceComicalArrow);
		})
	$('#cronHelperWardrobeForTasks').on('change', function() {
		cronHelperWardrobeForTasks = $('#cronHelperWardrobeForTasks').prop('value');
		storeData('Tasks', cronHelperWardrobeForTasks);
		console.log(cronHelperWardrobeForTasks);
	})
	$('#cronHelperWardrobeForCron').on('change', function() {
		cronHelperWardrobeForCron = $('#cronHelperWardrobeForCron').prop('value');
		storeData('Cron', cronHelperWardrobeForCron);
	})	
	$('#rememberGear').click(function(){	
		rememberGear = JSON.stringify($('#rememberGear').is(':checked')); 
		storeData("Remember Gear", rememberGear);
		console.log(rememberGear);
		})
	$('#allowWerewolf').click(function(){
		allowWerewolf = $('#allowWerewolf').is(':checked');
		storeData('Werewolf', allowWerewolf);
		werewolf();
		})
	$('#modalAbortButton').click(function () {
		abort = true;
		abortFunction();
		})
	$('#castOnBluestTask').click(function(){
		castOnBluestTask = JSON.stringify($('#castOnBluestTask').is(':checked'));
		storeData("Bluest Task", castOnBluestTask);
		displayTasks();
		console.log(castOnBluestTask);
	})
	$('#selectTask').on('change', function(){
		skills[user.stats.class].field2.task = $('#selectTask option:selected').text();
		skills[user.stats.class].field2.taskId = $('#selectTask option:selected').val(); 
		$('.skillOnTask').html('on ' + skills[user.stats.class].field2.task);
		console.log(skills[user.stats.class].field2.taskId);
		displayTasks(); 
		}); 

	
    //////////////////////////////////////////////////////////////////////
    ////   Display the HTML    (within paseData)   ///////////////////////
    //////////////////////////////////////////////////////////////////////
	$('#documentationAndForm').html(' ');
    $('#modal').hide();
    $('#output').html(htmlStart + html + htmlEnd);
	prepareSkillAmounts();
	if (frontEnd == 'wardrobes') {
			$('.skills-Container').hide();
            $('.costumes-Container').hide();
			$('.wardrobes-Container').show();
            }
		if (frontEnd == 'skills') {
			$('.skills-Container').show();
            $('.costumes-Container').hide();
			$('.wardrobes-Container').hide();
            }
        if (frontEnd == 'costumes') {
            $('.skills-Container').hide();
            $('.costumes-Container').show();
			$('.wardrobes-Container').hide();
            }


} // End of parseData() and its nested functions
}); // end of global Function
</script>
<style>
/*********************************************************************
****   Page-wide   ***************************************************
*********************************************************************/
body {
	font-family: Helvetica, Arial, sans-serif;
    font-size: 14px;
    background-color: #4f2a93;
	color: #000000;
}
#outerFrame {
	margin: 0px;
	background-color: #4f2a93;
}
#innerBody {
    margin: 5px;
    padding: 5px; 
    background-color: #eeeeee;
	color: #000000;
	border-radius: 8px;
	min-width: 605px; 
}
#loading {
    margin-right: 30px;
    margin-left: 30px;
    color: orange;
    font-size: 1.5em;
    font-weight: bold;
}
div.scroll {
    width: 95%;
    height: 200px;
    overflow: scroll;
}
#headerExtras .showHideToggle {
    white-space: nowrap;
}
.show {
    display: block;
}
.hide {
    display: none;
}
.clear {
    clear: both;
}
.leftSide {
	position: absolute;
	float: left;
	left: 0px;
}
.rightSide {
	position: absolute; 
	float: right;
	right: 0px;
}
.topSide {
	vertical-align: text-top;
	top: 0px;
}
.bottomSide {
	vertical-align: text-bottom;
	bottom: 0px;
}
.wardrobes-Container {
  display: flex;
  flex-wrap: wrap;
  background-color: #dddddd;
  line-height: 250px;
  border-radius: 8px;
}
.wardrobes-Container>div {
  background-color: #eeeeee;
  border-radius: 8px;
  width:280px;
  margin: 10px;
  border: 10px;
  text-align: left;
  line-height: 13px;
  font-size: 12px;
}
.skills-Container {
  display: flex;
  flex-wrap: wrap;
  background-color: #dddddd;
  line-height: 250px;
  border-radius: 8px;
}
.skills-Container>div {
  background-color: #eeeeee;
  border-radius: 8px;
  width:280px;
  margin: 10px;
  border: 10px;
  text-align: center;
  line-height: 13px;
  font-size: 12px;
}
.costumes-Container {
  display: flex;
  flex-wrap: wrap;
  background-color: #dddddd;
  line-height: 250px;
  border-radius: 8px;
}
.costumes-Container>div {
  background-color: #eeeeee;
  border-radius: 8px;
  width:280px;
  margin: 10px;
  border: 10px;
  text-align: left;
  line-height: 13px;
  font-size: 12px;
}
.flex-displayContent {
	background-color: #eeeeee;
	display: flex;
	flex-wrap: wrap;
	margin: 10%
	width: 100%;
	height: 200px;
	overflow: scroll;
}
.flex-displayContent>div {
	width: 50%;
	margin: 10px;
	border: 10px;
	text-align: left;
	overflow:scroll;
}
.costume {
    position: absolute;
    padding-top: 24px;
    padding-left: 24px;
}
/***************************
******Attriute Containers **
****************************/
.container {
    width: 97%;
    height: 80px;
    color: #4e4a57;
    margin: auto;
    padding: 0;
	border-radius: 8px;
}
.one {
    width: 47%;
    height: 70px;
	float: left;
	border-radius: 8px;
	border-style: solid;
	border-width: 3px;
	border-color: #ffffff
	
}
.two {
	width: 47%;
    margin-left: 50%;
    height: 70px;
	align: left;
	border-radius: 8px;
	border-style: solid;
	border-width: 3px;
	border-color: #ffffff
}
.innerContainer {
    width: 100%;
    height: 70px;
    background: #ffffff;
    margin: auto;
    padding: 0px;
	color: #4e4a57;
	font-family: "Roboto",sans-serif;
	
}
.innerOne {
	text-transform: uppercase;
	text-align: center;
	
	margin-top: 6%; 
	font-size: large;
    width: 45%;
    height: 60px;
    background: #ffffff;
	color: #4e4a57;
	float: left;
	
}
.innerTwo {
	font-size: x-small;
    margin-left: 45%;
    height: 70px;
    background: #ffffff;
	color: #4e4a57;
}
.containerMana {
    border-radius: 8px;
	width: 91%;
    height: 110px;
    color: #4e4a57;
    margin: auto;
    padding: 8px;
	background: #efffff;
	font-family: "Roboto",sans-serif;
}
.left {
    width: 58%;
    
	float: left;
}
.middle {
	width: 16%;
	text-align: right;
	float: left;
}
.right {
	width: 18%;
    margin-left: 76%;
	text-align: right;
	align: left;
}
.skills {
    width: 47%;
    height: 80px;
	float: left;
	border-radius: 8px;
	border-style: solid;
	border-width: 3px;
	border-color: #ffffff
	
}
.mana {
	width: 47%;
    margin-left: 50%;
    height: 80px;
	align: left;
	border-radius: 8px;
	border-style: solid;
	border-width: 3px;
	border-color: #ffffff
}
/***************************
*** IMG hovers *************
***************************/
.wrap {
  position: relative;
  
}
.description {
  border-radius: 8px;
  position: absolute;
  float: left;
  top: -45px;
  left: -10%;
  right: -10%;
  font-weight: normal;
  color: #333333;
  visibility: invisible;
  opacity: 0;
  background-color: #fefefe;
  margin: 1em auto 1em auto;
  padding: 5px;
  border: 1px solid #888888;
  width: 90px;
  min-width: 90px;
  max-width: 90px;
  z-index: 2;
}
.descriptionStats {
  border-radius: 8px;
  position: absolute;
  top: 5px;
  left: 90px;
  right: 50px;
  font-weight: normal;
  color: #333333;
  visibility: invisible;
  opacity: 0;
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888888;
  width: 150px;
  z-index: 2;
}
.descriptionSkills {
  border-radius: 8px;
  position: absolute;
  bottom: 30px;
  left: -8px;
  font-weight: normal;
  color: #333333;
  visibility: invisible;
  opacity: 0;
  background-color: #fefefe;
  margin: auto;
  padding: 0px;
  border: 1px solid #888888;
  width: 280px;
  z-index: 2;
}
.wrap:hover .description {
  visibility: visible;
  opacity: 1;
}
.wrap:hover .descriptionStats {
  visibility: visible;
  opacity: 1;
}
.wrap:hover .descriptionSkills {
  visibility: visible;
  opacity: 1;
}
/***********************************
quantity buttons
***************/
.number {
	width: 20px;
	text-align: center;
}
	 
	

/**********************************************************************
****** Modal **********************************************************
**********************************************************************/

.rateLimiter {
    display:none;
    position: fixed;
    z-index: 6;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-colot: rbg(0,0,0);
    background-color: rgba(0,0,0,0.4);
}

/* modal und modal-content for short info about equipping gear, casting skills etc. */
/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 5; /* Sit on top */
    padding-top: 100px; /* Location of the box DO WE NEED THIS?*/
    left: 0;
    top: 0;
	width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}
/* Modal Content */
.modal-content {
	position: absolute; 
	left: 50%;
	top: 32%;
	transform: translate(-50%, -50%);
	border-radius: 8px;
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 300px;
	font-weight: bold;
	text-align: center; 
}
.modal-content-footer {
	position: relative;
	left: 50%;
	top: calc(32vh); 
	transform: translate(-50%, -50%);
	width: 300px;
	text-align: center; 
}
/* modalData and modalData-content for big modals (tasks, skills, content, user, version info, help */
/* The Modal (background) */
.modalData {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 4; /* Sit on top, even on top of Tooltips*/
    padding-top: 100px; /* Location of the box DO WE NEED THIS?*/
    left: 0;
    top: 0;
	width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: hidden; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}
/* Modal Content */
.modalData-content {
	position: fixed;
    bottom: 5%;
    left: 10%;
    width: 80%;
    height: 90%;
	min-width: 80%;
	max-width: 600px; 
	border-radius: 8px;
	background-color: #fefefe; 
    border: 2px solid #eeeeee;
	z-index: 4; 
}
/* cronHelper */
.cornHelperTable {
	border-collapse: collapse;
	width: 100%;
	border: 10px;
	border-left-width: 10px;
	border-top-style: none;
	border-right-style: none;
	border-left-style: 5px;
	border-color: #eeeeee;
	
}
.top {
  overflow: hidden;
  background-color: #eeeeee;
  color: #222222;
  top: 0;
  height: 80px;
  max-height: 200px;
  width: 100%;	
}
.dataSectiony {
	overflow-y: auto;
	overflow-x: hidden;
	position: relative;
	min-height: cals(90vh - 160px);
	max-height: calc(90vh - 160px);
}
.dataSectionxy {
	overflow-y: auto;
	overflow-x: auto;
	position: relative;
	min-height: calc(90vh - 160px);
	max-height: calc(90vh - 160px);
}
.dataSectionFix {
	overflow-y: auto;
	overflow-x: auto;
	position: relative;
	min-height: calc(90vh - 160px);
	max-height: calc(90vh - 160px);
}
.bottom {
	overflow: hidden;
	bottom: 0px;
	width: 100%;
	height: 80px;
	background-color: #eeeeee;
}
/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}
.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}
/*********************************************************************
****   Header   ******************************************************
*********************************************************************/
h1 {
    float: left;
	font-size: 1.5em;
}
h1>a:first-child { /* "Habitica" link in header */
    color: black;
    text-decoration: none;
}
h1>a:first-child:hover { /* "Habitica" link in header */
    text-decoration: underline;
}
h1 span {
    font-size: 0.5em;
}
/************************************************
***** top navigation ****************************
************************************************/

.navbar {
  overflow: hidden;
  background-color: #eeeeee;
}
.navbar a {
  float: left;
  font-size: 16px;
  color: #662266;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}
.navbar b {
  float: left;
  font-size: 16px;
  color: #662266;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
}
.dropdown {
  float: left;
  overflow: hidden;
}
.dropdown .dropbtn {
  font-size: 16px;
  border: none;
  outline: none;
  color: #662266;
  padding: 14px 16px;
  background-color: inherit;
  font-family: inherit;
  margin: 0;
}

.navbar a:hover, .dropdown:hover .dropbtn {
  background-color: #662266;
  color: white; 
}

.topnav-right {
  float: right;
}
.small {
	font-size: 8px;
	margin: 1px; 
}
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 3;
}
.dropdown-content a {
  float: none;
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  text-align: left;
}
.dropdown-content a:hover {
  background-color: #995599;
}
.dropdown:hover .dropdown-content {
  display: block;
}
/*////////////////////////////
/// Output Members' last cron
/////////////////////////////*/
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}
td, th {
  text-align: left;
  padding: 8px;
}
/*///////////////////////////////
/// Cron Helper Table ///////////
////////////////////////////////*/
.taskType {
	float: left;
	width: 15%;
}
.score {
	float: left;
	width: 30px;
}
.taskLong {
	float: left;
	width: 70%;
}
.taskShort {
	float: left;
	width: 15%;
	
}
.checklistItem {
	float: left;
	width: 55%;
}
</style>

</head>


<body>
	<!-- Modals -->
        <div id="rateLimiter" class="rateLimiter">
            <div class ="modal-content"> 
                <p>30 requests allowed in 60 seconds. Limit reached. Please wait!</p>
                <p id="rateLimiterCountdown">awaiting reset time</p>
            </div>
        </div>
		<!-- small info modal for info about: loading, casting skills, equipping gear, etc.  -->
		<div id="modal" class="modal">
			<div id="modalContent" class="modal-content"></div>
			<div id="modalContentAbort" class="modal-content-footer" style="display: none"><button id="modalAbortButton" style="color: #2995cd">Abort</button></div>
		</div>	

		<!-- modal for the separate Settings-page -->
		<div id="modalSettings" class="modalData">	
			<div id="modalSettingsContent" class="modalData-content" style="background-color: rgba(250,250,250,0.85)">
				<div class="top">
					<span class="leftSide">Settings:</span>
					<span class="close">× &nbsp;</span>
				</div>
				<div class="dataSectionFix">
					<p>Automatic Selection of Gear:</p>
					<p>Set threshold
						<select id="threshold" onchange="console.log(value)">
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>
							<option value="4">4</option>
							<option value="5">5</option>
							<option value="6">6</option>
							<option value="7">7</option>
							<option value="8">8</option>
							<option value="9">9</option>
						</select>
					</p>
					<p style="font-size: x-small">
						All wardrobes are pre-filled with the users Habitica-side chosen Battle Gear. <br>
						Pre-filled gear is replaced by equipment from inventory with values exceeding the threshold.<br>
						Choosing a low threshold will allow the wardrobes to be aligned to maximum attribute points, even at the expense of other important attributes.<br>
						At a high threshold, the maximum yield of attribute points is not achieved, but other important attributes are more likely maintained.<br>
					</p>
					<p>Set alternative attribute: 
						<select id="alternativeAttribute" onchange="console.log(value)">
							<option value="none">-none-</option>
							<option value="int">Intelligence</option>
							<option value="per">Perception</option>
							<option value="str">Strength</option>
							<option value="con">Constitution</option>
						</select>
					</p>
					<p style="font-size: x-small">
						An alternative attribute can be selected to exchange equipment with values ​​below the threshold for equipment with different attributes.
					</p>	
					
					<p>Force Aether Amulet <input id="forceAetherAmulet" type="checkbox" autocomplete="off"> <span style="font-size: x-small"> (if Aether Amulet is forced, you might not be able to equip the Lifeguard Whiste (INT: 12)</span></p>
					<p>Force Comical Arrow <input id="forceComicalArrow" type="checkbox" autocomplete="off"></p>
					<p style="font-size: x-small">
						Both Aether Amulet and Comical Arrow provide high attribute points for STR. Regardless of other setting, "force Aether Amulet and Comical Arrow" 
						equips both items, provided they are in the iventory. This does not apply to wardrobe PER.
					</p>	
					<hr>
					<p>Cron Helper: </p>
					<p>Wardrobe for Tasks: 
					  <select id="cronHelperWardrobeForTasks" onchange="console.log(value)">
  						<option value="disabled">-disabled-</option>
						<option value="intelligence">Intelligence</option>
						<option value="perception">Perception</option>
						<option value="strength">Strength</option>
						<option value="Legendary">Legendary</option>
					  </select>
					</p>
					<p style="font-size: x-small">
						Cron Helper can change wardrobes when scoring tasks automatically, depending on the setting made here. <br> 
						For players who do not wish to change equipment using the Cron Helper, this procedure can be disabled. <br> 
						CAUTION: Scoring tasks with the help of automated change of wardrobes will change the users battle gear. Once equipped, there is no way to determine previous state!
					</p>
					<p>Wardrobe for Cron: 
					  <select id="cronHelperWardrobeForCron" onchange="console.log(value)">
  						<option value="disabled">-disabled-</option>
						<option value="intelligence">Intelligence</option>
						</select>
					</p>
					<p style="font-size: x-small">
						Cron Helper can change wardrobes when running cron automatically, depending on the setting made here. <br> 
						For players who do not wish to change equipment using the Cron Helper, this procedure can be disabled. <br> 
						CAUTION: Running cron with the help of automated change of wardrobes will change the users battle gear. Once equipped, there is no way to determine previous state!
					</p>
			
					<hr>
					<p>Show History on Data\Tasks: <input id="showHistory" type="checkbox" autocomplete="off"><span style="font-size: x-small">(Initially hidden for better view)</span></p>
					<hr>
					<p>Werewolf equipper</p>
					<p style="font-size: x-small">
						The honorable user <a href="https://habitica.com/profile/410b09e8-b870-4e30-80ac-2c99e9fd9678" target="_blank">@psn aka Spiro</a> from the 
						<a href="https://habitica.com/groups/guild/2ff9822b-27f2-4774-98da-db349b57a38e" target="_blank">Aspiring Comrades Guild</a> is the author of the 
						<a href="https://habitica.fandom.com/wiki/Werewolf_Equipper" target="_blank">werewolf equipper</a> script, that equips the werewolf costume
						on days with full moon. 
						The author agreed upon Habitican Wardrobes to host the werewolf feature as well. 
						If you choose to allow the Werewolf equipper, you will get the costume equipped on days with full moon, and get your previously worn costume back on
						the following day. The feature is only available if you own the werewolf costume. </p>
					<p id="werewolf">Allow Werewolf <input id="allowWerewolf" type="checkbox" autocomplete="off"></p>	
						     
					
										
				</div>					
			</div>
		</div>

		<!-- modal for data display: tasks, user-data, wardrobes, skills, Habitica content -->
		<div id="modalData" class="modalData">	
			<div id="modalDataContent" class="modalData-content">
				<div class="top">
					<span class="leftSide">Habitica Data</span>
					<span class="close">× &nbsp;</span>
				</div>
				<div class="dataSectionxy">
					main content here	
				</div>
				<div class="bottom"> 
					<span class="leftSide bottomSide">
						To close, click x or outside this window 
					</span>
					<span class="rightSide bottomSide">
						&nbsp;
					</span> 
				</div>
			</div>
		</div>

		<!-- modal for Cron Helper page -->
		<div id="modalCronHelper" class="modalData">	
			<div id="modalCronHelperContent" class="modalData-content">
				<div class="top">
					<span class="leftSide topSide">Habitica Cron Helper</span>
					<span class="close">× &nbsp;</span>
					<div style="position: absolute; font-weight: bold; top: 50px; width: 95%;">
							<div class="taskShort">Task</div>
							<div class="checklistItem">Checklist</div>
							<div class="taskType">Type</div>
							<div class="score"><button style="border-radius: 10px; border-style: none" class="up">+</button></div>
							<div class="score"><button style="border-radius: 10px; border-style: none" class="down">-</button></div>
							<div class="score" style="width: 14px;">&nbsp;</div>
							</div><table>
						<tbody><tr>
							
						</tr>
					</tbody></table>
				</div>
				<div class="dataSectionFix cronHelperTable">
					<div class="taskShort"></div><div class="checklistLong"></div><div class="taskType"></div><div class="score"></div><div class="score"></div><table id="cronHelperTable" class="cronHelperTable">
 			 			<tbody><tr>
	    				</tr>
					</tbody></table>
				</div>
				<div class="bottom"> 
					<span id="cronHelperInfo" class="leftSide bottomSide">
						Please check, if you are wearing the correct wardrobe<br>
						before scoring a task or before forcing cron.<br> 
					</span>
					<span class="rightSide bottomSide">
						<button id="forceCron" style="border-radius: 8px; 
								   border: none;
								   background-color: green; 
								   color: white; 
								   font-size: large;">
							Force Cron
						</button>
						&nbsp;
					</span> 
				</div>
			</div>
		</div>

		
		<!-- model for help-window -->
		<div id="modalHelp" class="modalData">
			<div id="modalHelpContent" class="modalData-content">
				<div class="top">
					<span class="leftSide">Habitican Wardrobes - Help</span>
					<span class="close">× &nbsp;</span>
				</div>
				<div class="dataSectionFix">
					<ol style="list-style-position: outside;">
						Help: <br><br>
						<li>Habitican Wardrobes is a HTML-File using Javascript. <br>The code can be found on 
						<a href="https://github.com/PitiTheGrey/Habitican-Wardrobes" target="_blank">Github</a></li>
						<li>There is a <a href="https://habitica.com/groups/guild/ba3e642f-a109-4ad2-b041-301c2935189f">Habitican Wardrobes Guild</a> 
						on Habitica to discuss feature requests, report bugs, ask questions, give feedback and alike. </li>
						<li>Please feel free to read the <a href="https://habitica.fandom.com/wiki/Habitican_Wardrobes">wiki page</a> about Habitican Wardrobes and the 
						<a href="https://habitica.fandom.com/wiki/Cron-Helper">Cron Helper</a>.</li>
					</ol>
				</div>
				<div class="bottom"> 
					<span class="leftSide bottomSide">
						To close, click x or outside this window 
					</span>
					<span class="rightSide bottomSide">
						&nbsp;
					</span>
				</div>
			</div>
		</div>

		<!-- modal for version-info -->
		<div id="modalVersion" class="modalData">	
			<div id="modalVersionContent" class="modalData-content">
				<div class="top">
					<span class="leftSide">Habitican Wardrobes and Cron Helper version info:</span>
					<span class="close">× &nbsp;</span>
				</div>
				<div class="dataSectionFix">
					<h3>Version Info:</h3><br><br>
			    	<ol style="list-style-position: outside;"> 
                    <h4>Version 3.0</h4><br>
                        Habitican Wardrobes offers a new Front End. It's called 'Costumes'. Here you can see your current appearance and save it to 3 different
                        lockers. If you want to save some other costume to your locker, please change your costume on Habitica, come back here and refresh the page. 
                        You can choose to equip any of the three locer-costumes. An undressed costume will automatically wait for you in the Locker Room. But after
                        a page refresh, 'Mummy' will have cleaned up everything and the Locker Room is empty. It is planned that if you turn into a werewolf, your 
                        clothes can be found inside your Locker Room. <br>
                        The Costumes-page might be a good means to attract players with the beauty concept in mind, rather than the efficiency. But on the other hand, 
                        those players can learn about the efficiency part, because we have a clear separation between 1. Battle Gear (efficiency) and 2. Costume (for the looks).
					    <br>The different Costumes are stored in the browsers local storage. Unfortunately the costumes cannot (yet) be synchronized between different divices.
                    <h4>Version 2.6</h4><br>
                        New guidelines allow to communicate with the Habitica server 30 times a minute. The code takes care not to exceed this bottleneck.
                    <h4>Version 2.5.1</h4><br>
						The new Lifeguard Whistle comes with an INT value of 12. The single checkbox for Aether Amulet and Comical Arrow had to be separated in two checkboxes, 
						in order to allow one of them without excluding the Lifeguard Whistle.
					<h4>Version 2.5</h4><br>
						Warriors and Mages can select to either cast Brutal Smash or Burst of Flames on their bluest task or any other task. 
					<h4>Version 2.4</h4><br>
						Improvement of Werewolf-equipper. Hair and Wheelchair do not disturb anymore. 
					<h4>Version 2.3</h4><br>
					<li>
						An "Abort"-button was added to stop the rutines "equipping gear" and "casting skills".
					</li>
					<li>
						The honorable user <a href="https://habitica.com/profile/410b09e8-b870-4e30-80ac-2c99e9fd9678" target="_blank">@psn aka Spiro</a> from the 
						<a href="https://habitica.com/groups/guild/2ff9822b-27f2-4774-98da-db349b57a38e" target="_blank">Aspiring Comrades Guild</a> is the author and inventer of the 
						<a href="https://habitica.fandom.com/wiki/Werewolf_Equipper" target="_blank">werewolf equipper</a> script, that equips the werewolf costume
						on days with full moon. 
						The author agreed upon Habitican Wardrobes to host the werewolf feature as well. 
						If you choose to allow the Werewolf equipper, you will get the costume equipped on days with full moon, and get your previously worn costume back on
						the following day. The feature is only available if you own the werewolf costume. The feature needs to be activated in the Settings-menu.
					</li>
					<li>Minor CSS adjustments</li>
					<li>The impact of the skill "Stealth" which a rogue can cast, is displayed next to "progression of mana" and the number of dailies done is increased by the number of stealthed dailies.</li>
					
					<h4>Version 2.1 and 2.2</h4><br>
					<li>
						'Cron Helper' allows you to take care of all of your accidentally unchecked task entries, even though Habitica's cron time has already expired.<br>
						After all desired tasks have been ticked off, the cron process can be triggered via the 'force cron' button. It's required that Habitica's cron time has already expired, though.
						<br>
						The Cron Helper is integrated into Habitican Wardrobes to take advantage of the appropiate wardrobes for runnung cron and checking off tasks.<br>
					</li>
					<li> 
						The menu item 'Data' now contains the entry 'Party-Cron-Times'. 'Party Cron Times' displays a list of your party members and their most recent 
						cron time. <br>
						This information may be useful to decide when a skill should be used. You may want to wait for the next party member to cron, before you 
						cast your party buffs.  
					</li>
					<li>
						The Hard-Mode button has been replaced by a selection box. Values between 1 and 9 can now influence whether the wardrobe should reach the maximum number 
						of attribute points, or wheter other properties can better be retained.  <br>
						Hand in hand with the selection field for the threshold, the program logic for the selection of the best equipment for a wardrobe has been revised.<br>
						Every wardrobe is prefilled with the users' current equipment. Only better equipment will be added if it is above the threshold. <br>
						On the Settings page, you can set an alternative property to search for if the threshold set causes undesirable results.
					</li>
					<li>Several modals have been optically refreshed and screen design has been given a little lifting in regards to mobile devices</li>
					<li>Display of Avatar on the skills-page and on equipping modal. </li>
					<li>Fixed 'Return to Wardrobe Intelligence' button, not set to true on startup. </li>
					<br>
					<br> 
  			 		<h4>Version 2.0</h4><br>
			   	 	<li>
						You can now toggle the display between Wardrobes and Skills. 
					</li>
			   	 	<li>
						The new Skills-section allows you to cast any of your four skills with an adjustable number of repititions.
					</li>
			   	 	<li>
						Values (repititions, Hard-Mode, selcted FrontEnd) are stored either in your browsers Local-Storage or in a local cookie if there is no 
						Local-Storage (if you use Edge as browser e.g.). All values will still be present after a page reload or a complete browser restart. 
						Check any search-engine on how to clean local Storage to delete entries by hand. 
					</li>
   					<li>Amount of repitition will automatically be reduced if Mana-level is too low.</li>
   					<li>Skills cannot be cast if your level is too low for the specific skill. </li>
					<li>
						The website uses the best suitable wardrobe for your chosen skill and returns to wardrobe Intelligence when all skills are completed. <br>
						Plans are to let you specify a wardrobe to return to. 
					</li>
					<li>
						Skills that are cast on tasks will be cast on your bluest task (highest positive value). <br>
						Warriors who might want to make a red tast more blue, will unfortunately have to wait for a future version where they can choose an 
						individual target.<br>
   						It is not possible to cast skills on tasks from challenges. 
					</li>
   					<li>Some buttons were relocated to a new navigation bar on the top of the page for easier access and better looks. </li>
   					<li>Display of information about gear, user-data, Habitica-content, tasks, etc. now uses modals for an optimized field of view. </li>
   					<li>
						The API section needed major adjustments and was redesigned completely. <br>
   						The use of deferred promises could no longer be maintained and had to be replaced by async await functions in order to sequentially go 
						through the chain of ajax-calls. 
					</li>
   					<li>xhr-headers for server-requests now contain the name of the tool and the authors user-id.</li>
   					<li>
						There are wait-functions between API-Server-Calls to minimize server-load. <br>
 	  					The more skills are cast, the longer the waiting time between calls will be. The formula is (1000+(1000 * amount / (0.01 * amount + 20))) 
						in milli-seconds. So code waits 1.5 sec each on 10 casts, 3.5 sec each on 50 casts and 11 sec each on 200 casts. 
					</li> 
 	  				<li>Adjustments of some z-index</li>
 	  				<li>Adjustments of disclaimer for legal compatibility with local law in conjunction with data-processing</li>
					<br>
 	 		 		<br> 
  			   		<h4>Version 1.4</h4><br>
			   		Hard Mode - button added. Default value is disabled - showing gear with compromise in some cases. <br>
   					Activating Hard Mode will provide best gear at any cost. <br><br>
   					Version 1.3.5<br>
   					Tooltips added for Skills in order to give more precise information. <br>
   					Refresh-button moved to top of the page for accessability. <br>
   					Counters added to "lodading" and "equipping" modals. <br>
   					<br>
   					Version 1.3<br>
   					Class-specific Impacts of skills were added for all classes.<br>
   					This version allows for entry level players<br>
   					Bug-fixes: <br>
  	 				Empty inventory sports are no longer shown. <br>
  	 				In case multiple wardrobes contain the same inventory, all those wardrobes are displayed with a boarder. <br>
   					Corrected focus for Tooltips for information about gear <br> 
   					undefined situations in gear fixed<br>
   					euip-function was adjusted to match exact number of items in each wardrobe<br>
   					<br>
   					Version 1.2<br>
   					Two-handed weapons were implemented.  <br>
   					code was overhauled. <br>
   					<br>
		   			<br>
		   			old Version 1.1<br>
					Fixed bug:  Items that were lost due to death were suggested in the wardrobe, and couldn't be equipped. 
					</ol>	
				</div>
				<div class="bottom"> 
					<span class="leftSide bottomSide">
						To close, click x or outside this window 
					</span>
					<span class="rightSide bottomSide">
						&nbsp;
					</span> 
				</div>
			</div>
		</div>
	<!-- end Modals section -->

	<div id="innerBody">
		<h1>Habitican Wardrobes<br>
			<span>(v 3.0 August 2020)</span>
		</h1>
		<div id="headerExtras"></div>
		<hr class="clear">
		<div id="loading">
    		<div class="good hide">
        			<p>Please wait. Syncronizing with Habitica server...</p>
    		</div>
    		<div class="bad hide">
        			<p>There was an error obtaining the data.</p>
        			<ul class="padded">
            			<li>
						Please reload the page (but perhaps wait half an hour first in case Habitica is under heavy load).
					</li>
            			<li>
						If you're using Internet Explorer, try another browser. <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a> 
						or <a href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a> will be more reliable.
					</li>
        			</ul>
    		</div>
		</div>

		<div id="userStats">
        </div>
		<hr class="clear">
		<div id="buttons"></div>
		<hr class="clear">
	
		<div id="documentationAndForm">
   		 	<iframe src="./wardrobes27_files/null.html" id="formPasswdSaveFix" name="formPasswdSaveFix" style="display:none">
			</iframe><!-- DAMN YOU CHROME!! DAMN YOU!!!! http://stackoverflow.com/a/9116737 -->
			<form id="userApiDetailsForm" method="POST" action="https://www.abbhh.de/wardrobes.html" target="formPasswdSaveFix">
				<fieldset>
       	     		<legend>
						<span class="highlight">
							Enter your Habitica API details
							(from <a href="https://habitica.com/user/settings/api" target="_blank"> User Icon &gt; Settings &gt; API</a>)
						</span>
            		</legend>
            		<label for="userId"><span>User ID</span>
           	     		<input type="text" name="userId" id="userId" value=""> <!-- Value entfernen -->
            		</label>
            		<label for="apiToken"><span>API Token</span>
           	     		<input type="password" name="apiToken" id="apiToken" value=""> <!-- Value entfernen -->
            		</label>
					<input type="submit" value="Fetch My Data">
						<p style="font-size: 8px;">
							Datenschutzerklärung und Impressum:
							<br>
							Verantwortlicher: ABB Allgemeine Buchhaltungshilfe- und Betriebsberatungsges. mbH, Hammer Deich 70, 20537 Hamburg<br>
							<br>
							Personenbezogene Daten: Die Angaben zu User-ID und API-Token (habitica.com) werden nicht durch abbhh.de gespeichert und dienen ausschließlich 
							dem Zugriff auf habitica.com. abbhh.de speichert Serverlogfiles (IP-Adresse, verwendeter Browser, Referer-Url). Die Erhebung der Daten dient 
							dem Betrieb der Website. Die Daten werden nicht ausgewertet und nach 30 	Tagen gelöscht. abbhh.de/wardrobes.html wird auf Ihrem Browser 
							ausgeführt und speichet dort vom Benutzer ausgewählte Einstellungen im LocalStorage oder alternativ als Cookie auf Ihrem Gerät. Diese 
							Datenspeicherung erfolgt ausschließlich für die Komfortoptimierung der Benutzer.<br>
							<br>
							Widerspruch gegen die Datenverarbeitung und Zustimmung zur Datenverarbeitung:<br> 
							Durch Eingabe Ihrer Nutzerdaten User-ID und API-Token akzeptieren Sie die Erhebung o.g. Daten. Der Datenerhebung widersprechen Sie durch 
							Verzicht auf die Nutzung dieser Website. <br>
							<br>
   			   	   		   	Privacy and security notes:
   		   		   	 		<br>
							Personal Data / Contact: <br>
							Responsible Person: ABB Allgemeine Buchhaltungshilfe- und Betriebsberatungsges. mbH, Hammer Deich 70, 20537 Hamburg / Germany<br>
							<br>
							Personal data: The information on user ID and API tokens (habitica.com) are not stored abbhh.de and are used exclusively
							accessing habitica.com. abbhh.de stores server log files (IP address, browser used, referer url). The collection of data serves the operation of
							Website. The data will not be evaluated and will be deleted after 30 days. abbhh.de/wardrobes.html is executed on your browser and stores the user
							selected settings in the LocalStorage or alternatively as a cookie on your device. This data storage is exclusively done for the comfort of the users. 
							<br>
							Opposition to data processing and consent to data processing:<br>
							By entering your user data User-ID and API-Token you accept the survey of the data mentioned above. Contradict the data collection by waiving the use
							this website.<br>
							<br>General<br>
			   	    	    Your API Token is a password - do not share it with anyone, not even the maintainer of this page if you are seeking help.<br>
   			   		   	  	This page does not save your User ID and API Token to any location, but your browser might, if it has been configured to
       				   	  	save form and password information. If you are using this page on a shared computer, you should clear any data that the browser
       			   		  	has saved. <br>
							This page will make changes to your Habitica accout. It changes equipped gear, fires skills and tasks, lets you cron after crontime. 
							If anything goes wrong, please use the official access paths to Habitica (webpage, app). <br>
							Changes to the Habitica user data made on this webpage will take effect immediately on the official webpage or on the app. Visibility of changes 
							occur after a sync there. <br>
							This page is not Habitica code. It's third party. Autor is <a href="https://habitica.com/profile/9226cae6-d852-45da-a51b-ec2c9cb759e6">@Pitii</a> 
							(user of <a href="https://www.habitica.com/">Habitica</a> and member of the guild 
							<a href="https://habitica.com/groups/guild/2ff9822b-27f2-4774-98da-db349b57a38e">'Aspiring Comrades'</a> and 
							<a href="https://habitica.com/groups/guild/ba3e642f-a109-4ad2-b041-301c2935189f">'Habitican Wardrobes'</a>). 
							Code can be viewed on <a href="https://github.com/PitiTheGrey/Habitican-Wardrobes">Github</a>.
						</p>
				</fieldset>
			</form>
		</div><!-- end of div id="documentationAndForm" -->
	</div><!-- end of div id="innerBody" -->


</body></html>
